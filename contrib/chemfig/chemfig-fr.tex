%  __________________________________________________________________
% |                                                                  |
% |                           chemfig v1.2e                          |
% |__________________________________________________________________|
%
% Ceci est chemfig_doc_fr.tex, le code LaTeX de la documentation en
% français de chemfig.
%
% Maintainer : Christian Tellechea
% E-mail     : unbonpetit@openmailbox.org
%              Comments, bug reports and suggestions are welcome.
% Licence    : Released under the LaTeX Project Public License v1.3c
%              or later, see http://www.latex-project.org/lppl.txt
% Package URL: http://ctan.org/pkg/chemfig
% Copyright  : Christian Tellechea 2010-2015
%
% The "chemfig" package consists of the 8 following files:
%    - chemfig.tex (this file)
%    - chemfig.sty (the package file for LaTeX)
%    - t-chemfig.tex (the package file for conTeXt)
%    - README
%    - chemfig_doc_en.tex, chemfig_doc_en.pdf (english manual)
%    - chemfig_doc_fr.tex, chemfig_doc_fr.pdf (manual in french)
%
% --------------------------------------------------------------------
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%
% %     http://www.latex-project.org/lppl.txt
%
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% --------------------------------------------------------------------
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Christian Tellechea
% --------------------------------------------------------------------
\documentclass[10pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[a4paper,margin=2.5cm,head=17pt,headsep=3mm,footskip=10mm]{geometry}
\usepackage[bottom]{footmisc}
\usepackage{libertine}
\renewcommand*\oldstylenums[1]{{\fontfamily{fxlj}\selectfont #1}}
\usepackage[scaled=0.8]{luximono}
\usepackage{amsmath}
\usepackage{array}
\usepackage{longtable}
\usepackage{xspace}
\usepackage{fancybox}
\usepackage{boites}
\usepackage{textcomp}
\usepackage{enumitem}
\usepackage{chemfig}
\usetikzlibrary{decorations.pathmorphing}
\usetikzlibrary{decorations.markings}
\usetikzlibrary{matrix}
\usepackage{siunitx}
\usepackage{emerald}
\usepackage{xstring}
\usepackage[protrusion=true,expansion,final,babel=true]{microtype}
\usepackage{fancyhdr}
\fancypagestyle{plain}{%
	\fancyhead[L]{\colorbox{gray!40}{\rlap{\small\bfseries\CF}\kern\dimexpr\linewidth-2\fboxsep}}
	\fancyhead[C]{}
	\fancyhead[R]{\scriptsize\slshape\leftmark\kern0.5em}
	\fancyfoot[l]{\tiny Compilé par Christian \textsc{Tellechea}, le \today.}
	\fancyfoot[c]{}
	\fancyfoot[r]{\thepage}}
\renewcommand\headrulewidth{0pt}

\makeatletter
\let\gobble\@gobble
\newcommand\idx{\@ifstar{\let\print@or@not\@gobble\idx@}{\let\print@or@not\@firstofone\idx@}}
\newcommand\idx@[1]{%
	\ifcat\expandafter\noexpand\@car#1\@nil\relax% si sc
		\expandafter\ifx\@car#1\@nil\protect
			\index{#1}%
			\print@or@not{#1}%
		\else
			\saveexpandmode\expandarg
			\StrSubstitute{\string#1}{\string @}{\@empty\protect\symbol{'100}}[\temp@]%
			\StrGobbleLeft\temp@1[\temp@]%
			\restoreexpandmode
			\expandafter\index\expandafter{\temp@ @\protect\texttt{\protect\textbackslash\temp@}}%
			\print@or@not{\texttt{\string#1}}%
		\fi
	\else
		\index{#1}%
		\print@or@not{#1}%
	\fi
}

\newcommand\make@car@active[1]{%
	\catcode`#1\active
	\begingroup
		\lccode`\~`#1\relax
		\lowercase{\endgroup\def~}%
}

\newif\if@exstar

\newcommand\exemple{%
	\begingroup
	\parskip\z@
	\@makeother\;\@makeother\!\@makeother\?\@makeother\:% neutralise frenchb
	\@ifstar{\@exstartrue\exemple@}{\@exstarfalse\exemple@}}

\newcommand\exemple@[2][65]{%
	\medbreak\noindent
	\begingroup
		\let\do\@makeother\dospecials
		\make@car@active\ { {}}%
		\make@car@active\^^M{\par\leavevmode}%
		\make@car@active\^^I{\space\space}%
		\make@car@active\,{\leavevmode\kern\z@\string,}%
		\make@car@active\-{\leavevmode\kern\z@\string-}%
		\make@car@active\>{\leavevmode\kern\z@\string>}%
		\make@car@active\<{\leavevmode\kern\z@\string<}%
		\exemple@@{#1}{#2}%
}

\newcommand\exemple@@[3]{%
	\def\@tempa##1#3{\exemple@@@{#1}{#2}{##1}}%
	\@tempa
}

\newcommand\exemple@@@[3]{%
	\xdef\the@code{#3}%
	\endgroup
	\if@exstar
		\begingroup
			\fboxrule0.4pt
			\let\breakboxparindent\z@
			\def\bkvz@bottom{\hrule\@height\fboxrule}%
			\let\bkvz@before@breakbox\relax
			\def\bkvz@set@linewidth{\advance\linewidth\dimexpr-2\fboxrule-2\fboxsep}%
			\def\bkvz@left{\vrule\@width\fboxrule\hskip\fboxsep}%
			\def\bkvz@right{\hskip\fboxsep\vrule\@width\fboxrule}%
			\def\bkvz@top{\hbox to \hsize{%
				\vrule\@width\fboxrule\@height\fboxrule
				\leaders\bkvz@bottom\hfill
				\ECFAugie
				\fboxsep\z@
				\colorbox{black}{\kern0.25em\color{white}\footnotesize\lower0.5ex\hbox{\strut#2}\kern0.25em}%
				\leaders\bkvz@bottom\hfill
				\vrule\@width\fboxrule\@height\fboxrule}}%
			\breakbox
				\kern.5ex\relax
				\ttfamily\footnotesize\the@code\par
				\normalfont
				\kern3pt
				\hrule height0.1pt width\linewidth depth0.1pt
				\vskip5pt
				\rightskip0pt plus 1fill
				\everypar{{\color{lightgray}\rlap{\vrule height0.1pt width\linewidth depth0.1pt}}\hskip0pt plus 1fill}%
				\newlinechar`\^^M\everyeof{\noexpand}\scantokens{#3}\par
			\endbreakbox
		\endgroup
	\else
		\vskip0.5ex
		\boxput*(0,1)
			{\fboxsep\z@
			\hbox{\ECFAugie\colorbox{black}{\leavevmode\kern0.25em{\color{white}\footnotesize\strut#2}\kern0.25em}}%
			}%
			{\fboxsep5pt
			\fbox{%
				$\vcenter{\hsize\dimexpr0.#1\linewidth-\fboxsep-\fboxrule\relax
					\kern5pt\parskip0pt \ttfamily\footnotesize\the@code}%
				\vcenter{\kern5pt\hsize\dimexpr\linewidth-0.#1\linewidth-\fboxsep-\fboxrule\relax
					\everypar{{\color{lightgray}\rlap{\vrule height0.1pt width\dimexpr\linewidth-0.#1\linewidth-\fboxsep-\fboxrule depth0.1pt}}}%
					\footnotesize\newlinechar`\^^M\everyeof{\noexpand}\scantokens{#3}}$%
				}%
			}%
	\fi
	\medbreak
	\endgroup
}

\newcommand\falseverb[1]{{\ttfamily\detokenize{#1}}}

\long\def\centerverb#1{%
	\def\centerverb@i##1#1{##1\hfill\null\par\egroup}%
	\bgroup
		\ttfamily\@noligs
		\parskip3.5pt\par\hfill
		\let\do\@makeother\dospecials
		\@vobeyspaces
		\centerverb@i}

\makeatother

\usepackage[frenchb]{babel}
\frenchbsetup{StandardLists=true,og=«,fg=»}

\newcommand\CF{{\ECFAugie ChemFig}\xspace}
\newcommand\TIKZ{ti\textit kz\xspace}
\newcommand\molht[1]{\begingroup\parskip3.5pt\par\hfill\chemfig{#1}\hfill\null\par\endgroup}
\newcommand\boxednode[2]{\fbox{$\mathrm{#1}\vphantom{M_1}$}_{#2}}
\newcommand\boxedfalseverb[1]{{\fboxsep0pt\fbox{\vphantom|\falseverb{#1}}}}

\usepackage[plainpages=false,pdfpagelabels,bookmarks=true,bookmarksopen=true,colorlinks=true,hyperfootnotes=false,filecolor=black,linkcolor=blue,urlcolor=magenta,pdfauthor={Christian TELLECHEA},pdftitle={ChemFig},pdfsubject={Dessiner des molécules 2D avec LaTeX},pdfkeywords={ChemFig},pdfcreator={LaTeX}]{hyperref}

\csname @addtoreset\endcsname{section}{part}
\usepackage{titlesec}
\titleformat{\part}[display]
	{\normalfont\Large\filcenter\sffamily\bfseries}%
	{\LARGE\MakeUppercase{\partname}}%
	{1pc}%
	{\titlerule\vspace{1pc}\Huge}

\begin{filecontents*}{chemfig_doc_fr.ist}
% Fichier de style makeindex
heading_prefix "{\\bfseries\\hfill "
heading_suffix "\\hfill\\null}\\nopagebreak\n"
headings_flag 1
symhead_positive "Symboles"
symhead_negative "Symboles"
delim_0 "\\dotfill"
delim_1 "\\dotfill"
delim_2 "\\dotfill"
\end{filecontents*}

\usepackage{makeidx}
\makeindex
\begin{document}
\begin{titlepage}
	\catcode`!12
	\begin{tikzpicture}[remember picture,overlay]
		\shade [left color=blue,right color=white]([yshift=2cm]current page.west) rectangle ([xshift=-1cm]current page.south);
		\shade [left color=white,right color=blue] ([xshift=1cm]current page.south) rectangle ([yshift=2cm]current page.east);
		\filldraw[black](current page.north west) rectangle ([yshift=7cm]current page.east);
		\shade[top color=black,bottom color=blue]([yshift=7cm]current page.east)rectangle([yshift=2.5cm]current page.west);
		\filldraw[black!55!blue!100]([yshift=2.5cm]current page.east)rectangle([yshift=2cm]current page.west);
	\end{tikzpicture}
	\begin{center}
		\color{white}\ECFAugie\fontsize{50pt}{50pt}\selectfont\CF\par
		\Large v\csname CF@ver\endcsname\par\bigskip
		\footnotesize\csname CF@fr@date\endcsname\par
		\normalsize Christian Tellechea\par\vskip1.5cm
		\huge Une extension \TeX{} pour dessiner des molécules%
	\end{center}
	\vskip4cm
	\begin{center}
		\scriptsize
		\setatomsep{3em}%
		\chemfig{-[::-30](-[5])(-[7])-[::+60]-[::-60]O-[::+60](=[::-45]O)-[::+90]HN>:[::-60](-[::+60]**6(------))-[::-30](<:[2]OH)-[::-60](=[6]O)-[::+60]O>:[::-60]*7(---?(<[::-120]OH)-(<|[1]CH_3)(<:[::-90]CH_3)-(-[1](<[::+80]HO)-[0](=[::+60]O)-[7](<|[::+130]CH_3)(-[::+75](<|[2]OH)-[::-60]-[::-60](<[::+30]O-[::-90])-[::-60](<[::+90])(<:[::+30]O-[7](-[6]CH_3)=[0]O)-[::-60])-[6]-[5,1.3]?(<:[7]O-[5](=[::-60]O)-[6]**6(------)))=(-[2]CH_3)-)}%
		\par
		{\ECFAugie\small Le taxotère}%
	\end{center}
	\vskip1.5cm
	\hfill
	\hbox to 0pt{\hss\scriptsize
		\setbondoffset{1pt}
		\setatomsep{2.5em}
		\setcompoundsep{5em}
		\setarrowoffset{6pt}
		\schemestart
		  \chemfig{(-[:-150]R')(-[:-30]R)=[2]N-[:30]OH}
		  \arrow{<=>[\chemfig{H^\oplus}]}
		  \chemfig{(-[@{a0}:-150]R')(-[:-30]R)=[2]@{a1}N-[@{b0}:30]@{b1}\chemabove{O}{\scriptstyle\oplus}H_2}
		  \chemmove[red,-stealth,red,shorten <=2pt]{
		      \draw(a0)..controls +(135:2mm) and +(215:4mm).. (a1);
		      \draw(b0)..controls +(120:2mm) and +(180:3mm).. ([yshift=7pt]b1.180);}
		  \arrow{<=>[\chemfig{{-}H_2O}]}[,1.1]
		  \chemleft[{\subscheme[90]{%
		    \chemfig{R'-\chemabove{N}{\scriptstyle\oplus}~C-R}
		    \arrow{<->}[,0.75]
		    \chemfig{R'-\lewis{2:,N}=@{a1}\chemabove{C}{\scriptstyle\oplus}-R}}}\chemright]
		  \arrow{<=>[\chemfig{H_2@{a0}\lewis{0:2:,O}}]}[,1.1]
		  \chemmove[red,-stealth,red,shorten <=3pt]{
		      \draw(a0)..controls+(90:10mm)and+(45:10mm)..([yshift=6pt]a1.45);}
		  \chemfig{*6(R\rlap{$'$}-N=(-R)-\chemabove{O}{\scriptstyle\oplus} H_2)}
		  \arrow{<=>[\chemfig{{-}H^\oplus}]}
		  \chemfig{*6(R\rlap{$'$}-N=(-R)-OH)}
		  \arrow
		  \chemfig{*6(R\rlap{$'$}-\chembelow{N}{H}-(-R)(=[2]O))}
		\schemestop\hss}\hfill\null
	\begin{center}
		\ECFAugie\small Réarrangement de Beckmann%
	\end{center}
\end{titlepage}
\parindent0pt\pagestyle{plain}
\tableofcontents
\parskip\medskipamount
\newpage

\setitemize{leftmargin=3em,topsep=0pt,parsep=0pt,itemsep=0pt,label=--}
\part{Introduction}\section{Nouveau dans la v1.2}
\paragraph{Pointes de flèches} Le modèle de pointe de flèche «CF» utilisé par défaut dans \CF est désormais défini avec la commande \verb|\pgfdeclarearrow| sur le modèle de «Stealth». Pour cela, la bibliothèque «arrows.meta» est chargée. La pointe «CF» admet donc les mêmes possibilités de personnalisation que la pointe «Stealth». Il est maintenant possible de définir le style de la pointe des flèches par défaut par l'intermédiaire de \verb|\setarrowdefault|.

\exemple{Personnalisation des flèches}/1) Flèche par défaut :\par
\schemestart A\arrow B\schemestop

2) Personnalisation par flèche :\par
\schemestart
	A\arrow[,,->] B\arrow[,,-{Triangle[slant=0.5,blue,width=10pt]}]
	C\arrow[,,-{CF[sharp]}] D
\schemestop\par

3) Style par défaut modifié :\par
\setarrowdefault{,,-{CF[red,open,length=15pt,line width=1pt]}}
\schemestart A\arrow B\schemestop/

\paragraph{Incrément d'angle} Lorsque l'angle d'une liaison est spécifié par \verb|[<n>]| où \verb|<n>| est un entier, l'angle de la liaison vaut $45\times\text{<n>}$. On peut désormais choisir l'angle qui va multiplier \verb|<n>| par \verb|\setangleincrement{<increment>}| :

\exemple{Modification de l'incrément de l'angle}/Par défaut : \chemfig{-[1]-[-1]-[1]-[-1]}

Incrément de 30 :
\setangleincrement{30}\chemfig{-[1]-[-1]-[1]-[-1]}/

\paragraph{Macros \texttt{\string\chemrel} et \texttt{\string\chemsign}} Ces macros obsolètes sont supprimées du package \CF. Pour écrire des réactions chimiques, il faut se placer dans l'environnement \verb|\schemestart|...\verb|\schemestop| et utiliser les macros \verb|\arrow| et \verb|\+|.

\paragraph{Librairie «external»}
En tenant compte des limitation exposées dans la documentation de la librairie «external», la macro \verb|\chemfig| est maintenant compatible avec cette librairie.

\paragraph{Macro étoilée \texttt{\string\setcrambond*}}
Lorsque la macro \verb|\setcrambond| est étoilée, les liaisons de Cram arrière sont tracées sous forme de rectangle et non pas sous forme de triangle.

\exemple{Liaisons de Cram arrière}/Non étoilée : \setcrambond{1ex}{.5pt}{.5pt}\chemfig{A>:B<:C}

Étoilée : \setcrambond*{1ex}{.5pt}{.5pt}\chemfig{A>:B<:C}/

\section{Présentation}
Pour charger \CF, il faut écrire :
\begin{itemize}
	\item {\color{blue}\verb-\input chemfig.tex-} avec $\varepsilon$\TeX\idx*\input;
	\item {\color{blue}\verb-\usepackage{chemfig}-} avec \LaTeX\idx*{Latex@\protect\LaTeX}\idx*\usepackage;
	\item {\color{blue}\verb-\usemodule[chemfig]-} avec Con\TeX t\idx*{ConTeXt@Con\protect\TeX{}t}\idx*\usemodule;
\end{itemize}

Dans tous les cas, le package \TIKZ\idx*{tikz}, s'il n'a pas été chargé auparavant, est chargé par \CF.

La commande principale permettant de dessiner les molécules est \verb|\chemfig{<code>}|\idx*\chemfig. L'argument \verb|<code>| est la suite de caractères décrivant le dessin de la molécule selon les règles qui seront exposées dans ce manuel.

Tout a été fait pour qu'il soit possible de dessiner le plus grand nombre de configurations de molécules chimiques, tout en privilégiant une syntaxe simple, souple et intuitive. Malgré tout, le \verb-<code>- qui décrit le dessin en 2D de la molécule voit sa complexité augmenter proportionnellement à celle de la molécule à dessiner.

La commande \verb|\chemfig| dessine une molécule en se servant de commandes de l'extension \TIKZ\idx*{tikz}, placées à l'intérieur de l'environnement \verb|tikzpicture|\idx*{tikzpicture}. Le choix de \TIKZ implique que:
\begin{itemize}
\item l'utilisateur a le choix pour le moteur de compilation\idx*{mode de compilation} : pdf\LaTeX{} peut indifféremment être utilisé en mode dvi\idx*{dvi (mode)} (tex $\longrightarrow$ dvi $\longrightarrow$ ps $\longrightarrow$ pdf) ou en mode pdf\idx*{pdf (mode)} (tex $\longrightarrow$ pdf). En effet, \TIKZ, via la sous-couche \idx{pgf}, donne des résultats graphiques identiques dans les deux modes;
\item la boîte englobante\idx*{boite englobante@boîte englobante} est automatiquement calculée par \TIKZ et l'utilisateur n'a pas à se préoccuper d'éventuels chevauchements avec le texte. En revanche il faut faire attention à la régularité des interlignes lorsque la molécule est dessinée dans un paragraphe. À titre d'exemple, on a tracé la boîte englobante\idx*{boite englobante@boîte englobante} pour cette molécule : {\fboxsep0pt \fbox{\chemfig{H_3C-C(-[:-30]OH)=[:30]O}}}. \CF placera toujours le premier atome de la molécule sur la \idx{ligne de base} du code qui précède.
\end{itemize}

\section{Remerciements}
Cette extension a pu voir le jour grâce à l'aide de Christophe \textsc{Casseau} qui en a eu l'idée. Je le remercie pour l'aide qu'il m'a apportée en amont de l'écriture du code ainsi que pour les tests qu'il a effectués.
\bigbreak
Enfin, je tiens à chaleureusement remercier Theo \textsc{Hopman} qui m'a spontanément proposé d'effectuer la traduction de ce manuel en anglais.
\newpage

\part{Fonctionnement de \protect\CF}
Cette partie est consacrée à la description des fonctionnalités les plus courantes de \CF. L'utilisateur trouvera ici les explications suffisantes pour dessiner la plupart des molécules. La présentation des fonctionnalités est faite sous un angle théorique, et le but de cette partie n'est pas de dessiner de vraies molécules chimiques mais de donner à l'utilisateur une description formelle des fonctionnalités de \CF. La partie «Utilisation avancée», page~\pageref{utilisation.avancee}, sera plus pratique et dévoilera des fonctionnalités plus avancées pour les utilisations les plus pointues. On y mettra aussi en avant des méthodes pour construire de vraies molécules chimiques, page \pageref{exemples.commentes}. Enfin, la dernière partie présentera des molécules chimiques et le code utilisé pour les dessiner.

\section{Groupes d'atomes}
Intrinsèquement, le dessin d'une molécule chimique consiste à relier par des traits de différents types des groupes d'atomes. Ainsi, dans la molécule \chemfig{O=O}, il y a 2 groupes d'atomes, chacun constitué d'un seul atome «O».

{\fboxsep1pt
Mais dans cette molécule
\molht{H_3C-C(-[:-30]OH)=[:30]O}
on compte 4 groupes d'atomes : «$\mathrm{H_3C}$», «C», «O» et «OH». Pour des raisons que nous verrons plus tard, \CF examine chaque groupe d'atomes et le découpe en atomes. Chaque atome s'étend jusqu'à rencontrer une lettre majuscule ou un de ces caractères spéciaux : {\ttfamily \boxedfalseverb{-} \boxedfalseverb{=} \boxedfalseverb{~} \boxedfalseverb{(} \boxedfalseverb{!} \boxedfalseverb{*} \boxedfalseverb{<} \boxedfalseverb{>} \boxedfalseverb{@}}. Pour \CF, tous les caractères entre accolades sont ignorés pour le découpage en atomes\idx*{decoupage en atomes@découpage en atomes}.

Par conséquent, le premier groupe d'atomes «$\mathrm{H_3C}$» est découpé en 2 atomes : $\boxednode{H_3}{}$ et $\boxednode C{}$. Chimiquement, il arrive que ce ne soient pas de vrais atomes puisque $\mathrm{H_3}$ par exemple, est constitué de 3 atomes d'hydrogène. Par abus de langage, on parlera d'atomes par la suite. Par conséquent, \CF voit la molécule précédente ainsi :
\renewcommand*\printatom[1]{\fbox{\ensuremath{\mathrm{#1}}}}
\molht{H_3C-C(=[:30]O)(-[:-30]OH)}}

Un espace est ignoré s'il est au début d'un groupe d'atomes.

\section{Différents types de liaisons}
\idx*{liaison!types}Pour \CF, les liaisons entre 2 atomes sont de 9 types, correspondant aux caractères \boxedfalseverb-, \boxedfalseverb=, \boxedfalseverb~, \boxedfalseverb>, \boxedfalseverb<, \boxedfalseverb{>:}, \boxedfalseverb{<:}, \boxedfalseverb{>|} et \boxedfalseverb{<|} :\label{types.liaisons}
\begin{center}
\begin{tabular}{>{\centering\arraybackslash}m{1.7cm}>{\centering\arraybackslash}m{3cm}>{\centering\arraybackslash}m{2cm}m{4cm}}
\hline
\No{} liaison&Code                 &Résultat      &Type de liaison\\\hline
1            &\verb+\chemfig{A-B}+ &\chemfig{A-B} &Simple\\
2            &\verb+\chemfig{A=B}+ &\chemfig{A=B} &Double\\
3            &\verb+\chemfig{A~B}+ &\chemfig{A~B} &Triple\\
4            &\verb+\chemfig{A>B}+ &\chemfig{A>B} &Cram pleine droite\\
5            &\verb+\chemfig{A<B}+ &\chemfig{A<B} &Cram pleine gauche\\
6            &\verb+\chemfig{A>:B}+&\chemfig{A>:B}&Cram pointillée droite\\
7            &\verb+\chemfig{A<:B}+&\chemfig{A<:B}&Cram pointillée gauche\\
8            &\verb+\chemfig{A>|B}+&\chemfig{A>|B}&Cram évidée droite\\
9            &\verb+\chemfig{A<|B}+&\chemfig{A<|B}&Cram évidée gauche\\\hline
\end{tabular}
\end{center}
\label{setdoublesep}La commande \verb-\setdoublesep{<dim>}-\idx*{\setdoublesep} permet de régler l'espacement entre les traits des liaisons doubles ou triples. Cet espacement vaut 2pt par défaut.

\label{longueur.liaison}\idx*{liaison!longueur}Lorsqu'une liaison est faite entre 2 atomes, il faut comprendre que ces atomes sont contenus dans des boîtes invisibles rectangulaires. Les centres des deux rectangles sont séparés par une distance réglable $\Delta$, appelée «distance interatome». De plus, les liaisons ne relient pas exactement les frontières des rectangles : une distance $\delta$, réglable elle aussi, sépare le bord des rectangles du début et de la fin de la liaison. Pour aider à la compréhension, les boîtes rectangulaires sont rendues visibles dans ce schéma :
\begin{center}
\begin{tikzpicture}[every node/.style={anchor=base,inner sep=1.5pt,outer sep=0pt,minimum size=0pt},baseline]
	\node[draw] at(0,0)(aa){\huge A};
	\node[draw]at(4,0)(bb){\huge B};
	\path[shorten <=5pt,shorten >=5pt,draw](aa)--(bb)coordinate[pos=0](al) coordinate[pos=1](bl);
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at(al){};
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at([xshift=5pt]al){};
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at(bl){};
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at([xshift=-5pt]bl){};
	\draw[blue,dash pattern=on 1pt off 1pt](bl)--([yshift=0.7cm]bl);
	\draw[blue,dash pattern=on 1pt off 1pt]([xshift=-5pt]bl)--([xshift=-5pt,yshift=0.7cm]bl);
	\draw[<->]([yshift=0.6cm]bl.center)--([xshift=-5pt,yshift=0.6cm]bl.center) node [midway,above,draw=none]{$\delta$};
	\draw[blue,dash pattern=on 1pt off 1pt](al)--([yshift=0.7cm]al);
	\draw[blue,dash pattern=on 1pt off 1pt]([xshift=5pt]al)--([xshift=5pt,yshift=0.7cm]al);
	\draw[<->]([yshift=0.6cm]al.center)--([xshift=5pt,yshift=0.6cm]al.center) node [midway,above,draw=none]{$\delta$};
	\node[draw,circle,fill,red,minimum size=2pt,inner sep=0pt]at(aa){};
	\node[draw,circle,fill,red,minimum size=2pt,inner sep=0pt]at(bb){};
	\draw[<->]([yshift=1cm]aa.center)--([yshift=1cm]bb.center) node [midway,above,draw=none] {$\Delta$} ;
	\draw[red,dash pattern=on 2pt off2pt](aa.center)--([yshift=1.1cm]aa.center);
	\draw[red,dash pattern=on 2pt off2pt](bb.center)--([yshift=1.1cm]bb.center);
\end{tikzpicture}
\end{center}

\label{setatomsep}La macro \verb-\setatomsep{<dimension>}-\idx*{\setatomsep} règle cette distance interatome $\Delta$. Si la \verb-<dimension>- est vide, elle prend sa valeur par défaut : 3em. Cette commande, comme toutes les commandes de réglage, agit sur toutes les molécules qui vont suivre.

\exemple{Distance interatome}|\setatomsep{2em}\chemfig{A-B}\par
\setatomsep{50pt}\chemfig{A-B}|

\label{setbondoffset}\idx*{\setbondoffset}La commande \verb-\setbondoffset{<dimension>}- permet de régler l'espacement $\delta$ entre le trait représentant la liaison et l'atome. Si la \verb-<dimension>- est vide, alors $\delta=\text{2 pt}$.
\exemple{Retrait des liaisons}|\setbondoffset{0pt}\chemfig{A-B}\par
	\setbondoffset{5pt}\chemfig{A-B}|

Si deux liaisons se suivent, alors \CF insère un groupe vide \verb-{}-, et autour de ce groupe vide, l'espacement $\delta$ est nul :
\exemple{Groupes vides}/\chemfig{A-B=-=C}/

\label{setbondstyle}\idx*{\setbondstyle}La commande \verb-\setbondstyle{<code tikz>}- définit le style de toutes les liaisons qui seront dessinées par la suite. Le \verb-<code tikz>- est vide par défaut. Pour personnaliser les liaisons une par une, voir page~\pageref{perso-liaisons}.
\exemple{Style des liaisons}/\setbondstyle{line width=1pt,red}
\chemfig{A-B=C>|D<E>:F}/

\label{modif.retrait}On peut spécifier l'espacement $\delta$ pour une seule liaison avec le caractère \verb-#-\idx*{\protect\symbol{'043}@\protect\texttt{\protect\symbol{'043}}}. Ce caractère doit se situer \emph{immédiatement} après le signe de liaison et dispose d'un argument obligatoire entre parenthèses de la forme «\verb-#(<dim1>,<dim2>)-», où \verb-<dim1>- représente l'espacement $\delta$ au début de la liaison et \verb-<dim2>- celui de la fin. Si \verb-<dim2>- est omis, l'espacement en fin de liaison prend la valeur de $\delta$ en vigueur à ce moment. On peut observer sur cet exemple comment le retrait, réglé à 4pt pour être plus visible, est rendu nul pour la liaison arrivant sur «B», puis partant de «B» et enfin pour les deux à la fois :
\begingroup
\catcode`\#12
\exemple{Réglage fin du retrait des liaisons}/\setbondoffset{4pt}
\chemfig{A-B-C}\par
\chemfig{A-#(,0pt)B-C}\par
\chemfig{A-B-#(0pt)C}\par
\chemfig{A-#(,0pt)B-#(0pt)C}/
\endgroup

Par défaut, tous les atomes se trouvant dans les groupes d'atomes sont composés en mode mathématique\idx*{mode mathematique@mode mathématique} (les espaces sont ignorés). Ils peuvent donc contenir des caractères propres à ce mode comme la mise en indice ou en exposant\footnote{Il existe un problème de placement des groupes d'atomes contenant des exposants ou des indices. Voir page~\pageref{alignement.vertical}.}:
\exemple{Mode mathématique}|\chemfig{A_1B^2-C _ 3 ^ 4}|

Il existe des réglages spécifiques aux liaisons de Cram\idx*{Cram (représentation)}\idx*\setcrambond. On utilise cette syntaxe :\label{setcrambond}
\centerverb/\setcrambond{<dim1>}{<dim2>}{<dim3>}/
\smallskip

Si l'un des argument est vide, il prend sa valeur par défaut. Les 3 arguments sont :
\begin{itemize}
	\item \verb-<dim1>- est la largeur de la base des triangles et vaut 1.5ex par défaut;
	\item \verb-<dim2>- est l'épaisseur des pointillés et vaut 1pt par défaut;
	\item \verb-<dim3>- est l'espacement entre les pointillés et vaut 2pt par défaut.
\end{itemize}

Voici un exemple où les 3 dimensions sont modifiées :

\exemple{Liaison de Cram modifiée}-\setcrambond{10pt}{0.4pt}{1pt}
\chemfig{A>B>:C>|D}-

\section{Angle d'une liaison}
\idx*{liaison!angle}\idx*{liaison!argument optionnel|(}Chaque liaison admet un argument optionnel qui se met entre crochet. Le contenu de cet argument optionnel permet de régler tout ce dont on a besoin pour la liaison. Cet argument optionnel est constitué de 5 champs séparés par des virgules qui sont autant d'arguments optionnels pour la liaison. Le premier de ces arguments définit l'angle optionnel de la liaison. Les angles vont croissant dans le sens trigonométrique et sont définis par rapport à l'horizontale. Si l'argument optionnel est vide, alors l'angle par défaut vaut 0\degres. Nous verrons plus loin comment modifier cet angle par défaut.

Il y a plusieurs façons de spécifier l'angle d'une liaison.
\subsection{Angle prédéfini}
\idx*{liaison!angle!prédéfini}Lorsque l'argument optionnel contient un entier celui-ci représente l'angle que fait la liaison avec l'horizontale, en multiples de 45\degres. Ainsi, \verb-[0]- spécifie un angle de 0\degres, \verb-[1]- de 45\degres, etc.

\exemple{Angles prédéfinis}|\chemfig{A-B-[1]C-[3]-D-[7]E-[6]F}|

Ces angles restent valable si les atomes sont vides et il en sera de même par la suite pour toutes les fonctionnalités que nous verrons :
\exemple{Angles prédéfinis, groupes vides}|\chemfig{--[1]-[3]--[7]-[6]}|

Pour ceux qui trouvent cela « affreux\footnote{Voir \texttt{\detokenize{http://tex.stackexchange.com/questions/161796/ugly-bond-joints-in-chemfig}}} », il est désormais possible de raccorder les liaisons simples entres-elles moyennant un temps de compilation légèrement augmenté. La macro \idx\enablebondjoin{} permet d'activer cette fonctionnalité et \idx\disablebondjoin{} la désactive (comportement préférable qui est celui par défaut).

\exemple{Raccord entre liaisons}/\setbondstyle{line width=3pt}
\chemfig{-[1]-[7]} et
\enablebondjoin\chemfig{-[1]-[7]}\disablefixedbondlength/

\label{setangleincrement}Il est possible de modifier l'angle dont on prend les multiples. La macro \idx\setangleincrement{} permet de choisir un autre angle que celui de 45\degres{} sélectionné par défaut :

\exemple{Modification de l'angle prédéfini}/Par défaut (45) : \chemfig{-[1]-[-1]-[1]-[-1]}

\setangleincrement{30}
Angle de 30 : \chemfig{-[1]-[-1]-[1]-[-1]}/

\subsection{Angle absolu}
\idx*{liaison!angle!absolu}Si on veut spécifier un angle en degrés avec l'horizontale, alors l'argument optionnel doit prendre cette forme : \verb-[:<angle absolu>]-. S'il le faut, l'\verb-<angle absolu>- est ramené dans l'intervalle $[0\;;\;360]$ :
\exemple{Angles absolus}/\chemfig{A-[:30]B=[:-75]C-[:10]D-[:90]>|[:60]-[:-20]E-[:0]~[:-75]F}/

\subsection{Angle relatif}\label{angle.relatif}
\idx*{liaison!angle!relatif}Il est souvent intéressant de spécifier pour une liaison l'angle qu'elle fera relativement à la précédente. On doit alors employer cette syntaxe pour l'argument optionnel : \verb-[::<angle relatif>]-. Le signe de l'\verb-<angle relatif>- peut être omis s'il s'agit d'un \verb-+-.

Voici une molécule où les angles des liaisons augmentent de 20\degres{} à chacune après la première dont l'angle est absolu de $-5\degres$ :
\exemple{Suite d'angles relatifs}|\chemfig{A-[:-5]-[::+20]-[::20]B-[::+20]-[::20]C-[::20]}|

On peut «casser» un enchaînement d'angles relatifs en mettant un angle absolu ou prédéfini lorsqu'on le souhaite. Ici, c'est à l'atome «B» dont la liaison suivante un angle absolu de 315\degres.
\exemple{Suite d'angles relatif puis angle absolu}|\chemfig{A-[:-5]-[::20]-[::20]B-[7]-[::20]C-[::20]}|

\section{Longueur d'une liaison}
\idx*{liaison!longueur}En fait, il faudrait plutôt parler d'espace interatome que de longueur d'une liaison. En effet, seul l'espace interatome est réglable avec \idx{\setatomsep} comme on l'a vu page~\pageref{longueur.liaison}. Une fois ce paramètre fixé, la longueur d'une liaison dépend du contenu des atomes et, dans une moindre mesure, de l'angle que fait la liaison avec l'horizontale. Il est bien évident que deux atomes peu «encombrants» auront leurs bords plus lointains que s'il avaient été encombrants. On s'en rend très bien compte sur cet exemple où les atomes «I» sont plus étroits que les atomes «M» ce qui entraîne que la liaison entre les «I» est plus longue que celle entre les «M» :
\exemple{Influence de la largeur de l'atome}|\chemfig{I-I}\par
\chemfig{M-M}|

Cet aspect de l'encombrement des atomes se fait particulièrement sentir lorsqu'ils comportent les exposants ou des indices. Dans cet exemple, la liaison est bien plus courte, au point de se confondre avec un signe mathématique $-$ :
\exemple{Liaison trop courte}|\chemfig{A^{++}_{2}-B^{-}_3}|

Il est important de remarquer que l'exposant «\verb+-+» est \emph{mis entre accolades}. En effet si ce n'était pas le cas, \CF stopperait l'atome sur ce caractère qui est un caractère de liaison. L'atome serait donc «\verb-B^-», ce qui conduirait à des résultats inattendus.

Il est possible de changer le comportement de \CF quant à l'espace interatome. En effet, lorsque la commande \verb+\chemfig+ est immédiatement suivie d'une étoile, la macro \verb-\setatomsep{<dimension>}-\idx*{\setatomsep} ne spécifie plus la distance entre les centres des atomes, notée $\Delta$, mais \emph{la longueur des liaisons}. Dès lors, les liaisons ont des longueurs fixes tandis que la distance entre les centres des atomes devient variable et dépend de leur encombrement. Voici le schéma de la page~\pageref{longueur.liaison} et ce qu'il devient avec la macro \verb|\chemfig*| :

\begin{center}
\begin{tabular}{c@{\kern2cm}c}
	macro \verb|\chemfig|&macro \verb|\chemfig*|\\[2ex]
	\begin{tikzpicture}[every node/.style={anchor=base,inner sep=1.5pt,outer sep=0pt,minimum size=0pt},baseline]
	\node[draw] at(0,0)(aa){\huge A};
	\node[draw]at(4,0)(bb){\huge B};
	\path[shorten <=5pt,shorten >=5pt,draw](aa)--(bb)coordinate[pos=0](al) coordinate[pos=1](bl);
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at(al){};
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at([xshift=5pt]al){};
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at(bl){};
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at([xshift=-5pt]bl){};
	\draw[blue,dash pattern=on 1pt off 1pt](bl)--([yshift=0.7cm]bl);
	\draw[blue,dash pattern=on 1pt off 1pt]([xshift=-5pt]bl)--([xshift=-5pt,yshift=0.7cm]bl);
	\draw[<->]([yshift=0.6cm]bl.center)--([xshift=-5pt,yshift=0.6cm]bl.center) node [midway,above,draw=none]{$\delta$};
	\draw[blue,dash pattern=on 1pt off 1pt](al)--([yshift=0.7cm]al);
	\draw[blue,dash pattern=on 1pt off 1pt]([xshift=5pt]al)--([xshift=5pt,yshift=0.7cm]al);
	\draw[<->]([yshift=0.6cm]al.center)--([xshift=5pt,yshift=0.6cm]al.center) node [midway,above,draw=none]{$\delta$};
	\node[draw,circle,fill,red,minimum size=2pt,inner sep=0pt]at(aa){};
	\node[draw,circle,fill,red,minimum size=2pt,inner sep=0pt]at(bb){};
	\draw[<->]([yshift=1cm]aa.center)--([yshift=1cm]bb.center) node [midway,above,draw=none] {$\Delta$} ;
	\draw[red,dash pattern=on 2pt off2pt](aa.center)--([yshift=1.1cm]aa.center);
	\draw[red,dash pattern=on 2pt off2pt](bb.center)--([yshift=1.1cm]bb.center);
	\end{tikzpicture}
	&
	\begin{tikzpicture}[every node/.style={anchor=base,inner sep=1.5pt,outer sep=0pt,minimum size=0pt},baseline]
	\node[draw] at(0,0)(aa){\huge A};
	\node[draw]at(5,0)(bb){\huge B};
	\path[shorten <=5pt,shorten >=5pt,draw](aa)--(bb)coordinate[pos=0](al) coordinate[pos=1](bl);
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at(al){};
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at([xshift=5pt]al){};
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at(bl){};
	\node[draw,circle,fill,blue,minimum size=1.5pt,inner sep=0pt]at([xshift=-5pt]bl){};
	\draw[blue,dash pattern=on 1pt off 1pt](bl)--([yshift=0.7cm]bl);
	\draw[blue,dash pattern=on 1pt off 1pt]([xshift=-5pt]bl)--([xshift=-5pt,yshift=0.7cm]bl);
	\draw[<->]([yshift=0.6cm]bl.center)--([xshift=-5pt,yshift=0.6cm]bl.center) node [midway,above,draw=none]{$\delta$};
	\draw[blue,dash pattern=on 1pt off 1pt](al)--([yshift=0.7cm]al);
	\draw[blue,dash pattern=on 1pt off 1pt]([xshift=5pt]al)--([xshift=5pt,yshift=0.7cm]al);
	\draw[<->]([yshift=0.6cm]al.center)--([xshift=5pt,yshift=0.6cm]al.center) node [midway,above,draw=none]{$\delta$};
	\draw[<->]([yshift=1cm]al)--([yshift=1cm]bl) node [midway,above,draw=none] {$\Delta$} ;
	\draw[red,dash pattern=on 2pt off2pt](al)--([yshift=1.1cm]al);
	\draw[red,dash pattern=on 2pt off2pt](bl)--([yshift=1.1cm]bl);
	\end{tikzpicture}
\end{tabular}
\end{center}

Afin que les cycles soient des polygones réguliers, le comportement par défaut est rétabli, même si la macro \verb|\chemfig| est étoilée.

\exemple{Liaisons de longueur fixe}/\chemfig{Cl-Cl}\par
\chemfig*{Cl-Cl}/

Si l'on souhaite que le comportement des macros étoilées devienne celui par défaut, on peut appeler la macro \idx\enablefixedbondlength. La macro \idx\disablefixedbondlength{} redonne aux liaisons des longueurs variables.

Notamment lorsque le comportement par défaut est en vigueur et pour se prémunir de liaisons trop courtes, il est parfois nécessaire de pouvoir augmenter (ou parfois réduire) la distance interatome. Pour cela, l'argument optionnel des liaisons est en réalité constitué de plusieurs champs séparés par des virgules. Comme on l'a vu, le premier champ spécifie l'angle. Le deuxième champ, s'il est non vide, est un coefficient qui multipliera la distance interatome $\Delta$ par défaut. Ainsi, écrire \verb+-[,2]+ demandera à ce que cette liaison ait l'angle par défaut (1\ier{} champ vide) et que les atomes qu'elle relie soit espacés d'une distance double de celle par défaut.\idx*{liaison!longueur}
\exemple{Longueur de liaison modifiée}/\chemfig{A^{++}_{2}-[,2]B^{-}_3}\par
\chemfig{A-B-[,2]C=[,0.5]D}\par
\chemfig{-=[,1.5]-[,0.75]=[:-20,2]}/

On peut modifier la taille des molécules\idx*{taille des molécules@taille des molecules} en jouant sur la taille de la police ou sur \idx\setatomsep, éventuellement sur les deux\footnote{On peut aussi utiliser le deuxième argument optionnel de la commande \texttt{\string\chemfig}, voir page~\pageref{arguments.optionnels}.}, en prenant soin de confiner ces changements à l'intérieur d'un groupe si on veut en limiter la portée :
\exemple{Modifier la taille des molécules}/\normalsize       \chemfig{H-[:30]O-[:-30]H}\par
\setatomsep{2.5em}\chemfig{H-[:30]O-[:-30]H}\par
\small            \chemfig{H-[:30]O-[:-30]H}\par
\footnotesize     \chemfig{H-[:30]O-[:-30]H}\par
\scriptsize       \chemfig{H-[:30]O-[:-30]H}\par
\tiny             \chemfig{H-[:30]O-[:-30]H}/

\section{Atome de départ et d'arrivée}
\idx*{liaison!atome de départ et d'arrivée}Un groupe d'atomes peut contenir plusieurs atomes. Mettons que l'on veuille relier le groupe «ABCD» au groupe «EFG» avec une liaison. \CF calcule quel atome du premier groupe et quel atome de second groupe il faut relier en fonction de l'angle que fait la liaison avec l'horizontale. Si l'angle est compris entre $-90\degres$ et 90\degres{} (modulo 360\degres) ces valeurs étant \emph{non comprises}, alors, la liaison se fait entre le dernier atome du premier groupe et de premier atome du second groupe. Dans tous les autres cas, la liaison se fait par défaut entre le premier atome du premier groupe et le dernier atome du second groupe.

Voici des exemples où les angles sont dans l'intervalle $]-90\;;90[$, et où la liaison se fait donc entre D et E :
\exemple{Atomes liés par défaut}|\chemfig{ABCD-[:75]EFG}\quad
\chemfig{ABCD-[:-85]EFG}\quad
\chemfig{ABCD-[1]EFG}|

Dans les exemples suivants, les angles appartiennent à $[90\;;270]$ et donc la liaison se fait entre A et G :
\exemple[60]{Atomes liés par défaut}|\chemfig{ABCD-[:100]EFG}\quad
\chemfig{ABCD-[:-110]EFG}\quad
\chemfig{ABCD-[5]EFG}|

Dans certains cas, on peut désirer qu'une liaison parte d'autres atomes que ceux calculés par \CF  On peut forcer un atome de départ ou un atome d'arrivée avec l'argument optionnel de la liaison. Il faut écrire :
\centerverb/[,,<entier 1>,<entier 2>]/
\smallskip

où \verb-<entier 1>- et \verb-<entier 2>- sont les numéros des atomes de départ et d'arrivée souhaités. Il faut que ces atomes existent, sinon, un message d'erreur sera émis.
\exemple{Atomes liés forcés}|\chemfig{ABCD-[:75,,2,3]EFG}\qquad
\chemfig{ABCD-[:75,,,2]EFG}\qquad
\chemfig{ABCD-[:75,,3,2]EFG}|

\section{Personnalisation des liaisons}\label{perso-liaisons}
\idx*{liaison!personnalisation}Il existe un 5\ieme{} et dernier argument optionnel pour les liaisons qui se trouve à droite de la 4\ieme{} virgule :
\centerverb/[,,,,<code tikz>]/
\smallskip

\idx*{tikz}Ce \verb-<code tikz>- est passé directement à \TIKZ lorsque la liaison est tracée. On peut y mettre des attributs de couleur comme «\verb-red-», de pointillés comme «\verb-dash pattern=on 2pt off 2pt-», d'épaisseur comme «\verb-line width=2pt-» ou même de décoration si on a chargé une librairie de décoration de \TIKZ. On peut aussi rendre une liaison invisible en écrivant «\verb-draw=none-»\idx*{liaison!invisible}. Si on veut spécifier plusieurs attributs, on utilise la syntaxe de \TIKZ en les séparant par une virgule :
\exemple{Passage de code tikz}|\chemfig{A-[,,,,red]B}\par
\chemfig{A-[,,,,dash pattern=on 2pt off 2pt]B}\par
\chemfig{A-[,,,,line width=2pt]B}\par
\chemfig{A-[,,,,red,line width=2pt]B}|

On peut ainsi avoir accès aux nombreuses librairies de décoration de \TIKZ. On peut par exemple utiliser la librairie «\verb-pathmorphing-» en écrivant \verb-\usetikzlibrary{decorations.pathmorphing}- dans le préambule pour tracer des liaisons ondulées :
\exemple{Liaison ondulée}|\chemfig{A-[,3,,,decorate,decoration=snake]B}|

Les liaisons de Cram sont insensibles aux attributs d'épaisseur et de pointillés.

\section{Valeurs par défaut}
\idx*{chemfig@\protect\texttt{\protect\string\protect\chemfig}!valeurs par défaut}Au début de chaque molécule, les valeurs par défaut des arguments optionnels des liaisons sont initialisées. Elles valent :
\begin{itemize}
	\item 0\degres{} pour l'angle des liaisons;
	\item 1 pour le coefficient multiplication des longueurs;
	\item \verb-<vide>- pour les  numéros de départ et d'arrivée des atomes, ce qui laisse à \CF le soin de calculer ceux-ci en fonction de l'angle de la liaison;
	\item \verb-<vide>- pour le paramètre passé à \TIKZ.
\end{itemize}

On peut changer ces valeurs par défaut pour toute la molécule en débutant le code de la molécule par
\centerverb/[<angle>,<coeff>,<n1>,<n2>,<code tikz>]/
\smallskip

Ainsi, si le code de la molécule commence par \verb-[:20,1.5]-, alors toutes les liaisons auront un angle de 20\degres{} par défaut et les distances interatomes une longueur qui vaut 1,5 fois la distance interatomes par défaut. On peut à tout moment ignorer ces valeurs par défaut en spécifiant un argument optionnel, comme pour la liaison qui suit l'atome «C» de cet exemple :
\exemple{Écrasement des valeurs par défaut}|\chemfig{[:20,1.5]A-B-C-[:-80,0.7]D-E-F}|

Si on écrit un improbable \verb-[1,1.5,2,2,red,thick]-, sauf indication contraire, toutes les liaisons auront un angle de 45\degres{} avec l'horizontale, les distances interatomes vaudront 1,5 fois la distance par défaut, les liaisons partiront et arriveront sur le deuxième atome de chaque groupe et seront rouges et épaisses :
\exemple{Valeurs par défaut}|\chemfig{[1,1.5,2,2,red,thick]ABC-DEF=GHI}|\idx*{liaison!argument optionnel|)}

\section{Ramifications}\idx*{ramification}
\subsection{Principe}
Jusqu'à présent, toutes les molécules étaient linéaires, ce qui est rare. On peut attacher une sous molécule à un atome faisant suivre cet atome d'un \verb-<code>- entre parenthèses. Ce \verb-<code>- est le code d'une sous molécule qui viendra d'attacher sur l'atome.

Dans cet exemple, la sous molécule «\verb/-[1]W-X/» vient s'attacher sur l'atome «B» :
\exemple{Ramification}|\chemfig{A-B(-[1]W-X)-C}|

On peut avoir plusieurs sous molécules qui viennent s'attacher sur un même atome. Il suffit de le faire suivre de plusieurs parenthèses contenant le code de chaque sous molécule :
\exemple{Ramifications multiples}|\chemfig{A-B(-[1]W-X)(-[6]Y-[7]Z)-C}|

Le code de chaque sous molécule peut définir ses propres valeurs par défaut qui seront valables dans toute l'étendue de la sous molécule. Ici, on attache sur «B» une sous molécule «\verb/[:60]-D-E/» dont l'angle par défaut vaut 60\degres{} absolus. On attache également sur «B» une sous molécule «\verb/[::-30,1.5]-X-Y/» dont l'angle par défaut vaut 30\degres{} de moins que celui de la liaison précédente (qui était celle qui allait de «A» à «B») et dont la distance interatome est 1,5 fois celle par défaut :
\exemple{Valeur par défaut dans les ramifications}|\chemfig{A-B([:60]-D-E)([::-30,1.5]-X-Y)-C}|

Maintenant, que se passe t-il si au début de la molécule principale, on écrit «\verb/[:-45]/» :
\exemple{Influence de l'angle par défaut}|\chemfig{[:-45]A-B([:60]-D-E)([::-30,1.5]-X-Y)-C}|

On constate que l'angle entre la liaison \verb/B-C/ et la liaison \verb/B-X/ reste de 30\degres{} puisqu'il s'agissait d'un angle relatif pour la sous molécule «\verb/-X-Y/». Par contre, la branche «\verb/-D-E/» reste inclinée à 60\degres{} avec l'horizontale et n'a pas suivi le mouvement de rotation imprimé par l'angle de $-45\degres$ du début, ce qui est normal puisque «\verb/-D-E/» a un angle absolu. Pour faire pivoter la totalité d'une molécule il est donc important que tous les angles soient relatifs.

\subsection{Imbrication}
Les sous molécules peuvent être imbriquées, et les règles vues au paragraphe précédent restent valables :
\exemple{Ramifications imbriquées}|\chemfig{A-B([1]-X([2]-Z)-Y)(-[7]D)-C}|

\subsection{Méthode}
Mettons maintenant que nous voulions dessiner la molécule d'anhydride d'acide :
\chemfig{R-C(=[::+60]O)-[::-60]O-[::-60]C(=[::+60]O)-[::-60]R}

La meilleure méthode pour y arriver est de choisir le plus long chemin. Ici nous pouvons par exemple dessiner le chemin \verb/R-C-O-C-R/ en tenant compte des angles et en n'utilisant que les angles relatifs :
\exemple{Structure de l'anhydride d'acide}|\chemfig{R-C-[::-60]O-[::-60]C-[::-60]R}|

Partant de cette structure, il suffit de rajouter deux sous molécules «\verb/=O/» sur les atomes de carbone :
\exemple{Anhydride d'acide}|\chemfig{R-C(=[::+60]O)-[::-60]O-[::-60]C(=[::+60]O)-[::-60]R}|

N'ayant utilisé que des angles relatifs, on peut faire pivoter cette molécule, en spécifiant un angle par défaut de 75\degres{} par exemple :
\exemple[70]{Rotation de la molécule}|\chemfig{[:75]R-C(=[::+60]O)-[::-60]O-[::-60]C(=[::+60]O)-[::-60]R}|

\section{Lier des atomes éloignés}
\idx*{liaison!atomes éloignés}Nous avons vu comment relier des atomes \emph{qui se suivent dans le code}. Il est parfois indispensable de relier entre-eux des atomes ne se suivant pas dans le code. Appelons «liaisons distantes» ces liaisons particulières.

Prenons cette molécule :
\exemple{Structure ramifiée}|\chemfig{A-B(-[1]W-X)(-[7]Y-Z)-C}|

Et mettons que l'on veuille relier les atomes \verb/X/ et \verb/C/. Dans ce cas, \CF permet de poser un «crochet» \emph{immédiatement} après l'atome qui nous intéresse. Le caractère utilisé pour poser ce crochet est «\verb-?-», pour sa ressemblance avec un crochet. Ainsi, si l'on écrit \verb/X?/, alors, l'atome \verb/X/ portera ce crochet. Par la suite dans le code, tous les atomes suivis d'un \verb-?- seront reliés à \verb/X/ :
\exemple{Liaison éloignée}|\chemfig{A-B(-[1]W-X?)(-[7]Y-Z)-C?}|

On aurait pu relier d'autres atomes à X en les faisant suivre de \verb-?-. Ici, ce sont les atomes \verb-C- et \verb-Z- :
\exemple{Plusieurs liaisons éloignées}|\chemfig{A-B(-[1]W-X?)(-[7]Y-Z?)-C?}|

Maintenant, imaginons que nous devions laisser ces liaisons distantes \verb/X-C/ et \verb/X-Z/, tout en ajoutant une autre : \verb/A-W/. Il faut donc poser deux crochets \emph{différents}, l'un sur \verb/A/ et l'autre sur \verb/X/. En fait, le caractère \verb/?/ a un argument optionnel :
\centerverb/?[<nom>,<liaison>,<tikz>]/
\smallskip

où chaque champ prend sa valeur par défaut s'il est vide :
\begin{itemize}
	\item le \verb-<nom>- est le nom du crochet : tous les caractères alphanumériques (a..z, A..Z, 0..9) sont admis\footnote{Ce n'est pas totalement exact. En réalité, tous les caractères pouvant être mis entre \texttt{\string\csname...\string\endcsname} sont autorisés.}. Ce nom vaut «\verb-a-» par défaut. Seul ce champ est pris en compte lors de la première occurrence de ce crochet portant ce nom.
	\item \verb-<liaison>- spécifie avec quelle liaison l'atome portant cette occurrence du crochet doit être reliée a l'atome portant la première occurrence. Deux cas de figure sont possibles; soit ce champ est un entier représentant le type de liaison voulu : 1=liaison simple, 2=liaison double, etc. Voir le tableau page~\pageref{types.liaisons} pour les codes des liaisons.

	Soit la \verb-<liaison>- est constituée des caractères codant la liaison, à condition que ces caractères soient \emph{entre accolades};
	\item \verb-<tikz>- sera passé directement à \TIKZ comme on l'a vu avec les liaisons classiques.
\end{itemize}

Voici notre molécule avec les liaisons distantes requises, puis avec les liaisons \verb/A-W/ et \verb/X-C/ personnalisées :
\exemple{Plusieurs liaisons éloignées}|\chemfig{A?[a]-B(-[1]W?[a]-X?[b])(-[7]Y-Z?[b])-C?[b]}\par\medskip
	\chemfig{A?[a]-B(-[1]W?[a,2,red]-X?[b])(-[7]Y-
	Z?[b,1,{line width=2pt}])-C?[b,{>},blue]}|

On peut écrire plusieurs crochets différents après un atome. Mettons que dans ce pentagone incomplet, on veuille relier \verb/A-E/, \verb/A-C/ et \verb/E-C/ :
\exemple{Un cycle incomplet}|\chemfig{A-[:-72]B-C-[:72]D-[:144]E}|

Alors, il faut procéder de cette façon :
\exemple{Plusieurs liaisons éloignées}|\chemfig{A?[a]-[:-72]B-C?[a]?[b]-[:72]D-[:144]E?[a]?[b]}|

\section{Cycles}\idx*{cycle|(}
L'exemple précédent montre comment tracer un polygone régulier, mais la méthode est fastidieuse puisque les angles dépendent du nombre de côté du polygone.

\subsection{Syntaxe}
\CF peut tracer des polygones réguliers facilement. L'idée est d'attacher un cycle à un \verb/<atome>/ extérieur à ce cycle avec cette syntaxe :
\centerverb/<atome>*<n>(<code>)/
\smallskip

\verb/<n>/ est le nombre de côtés du polygone et le \verb/<code>/ représente les liaisons et les groupes d'atomes qui constituent ses sommets et arêtes. Ce code \emph{doit} commencer par une liaison puisque l'atome se trouve à l'extérieur du cycle.

Voici un 5-cycle, attaché a l'atome «\verb/A/» :
\exemple{5-cycle}|\chemfig{A*5(-B=C-D-E=)}|

On peut également dessiner un cycle avec un, plusieurs, ou tous les groupes d'atomes vides, comme c'est le cas pour les dessins hors des cycles :
\exemple{5-cycle avec groupes vides}|\chemfig{*5(-=--=)}|

Un cycle peut être incomplet\idx*{cycle!incomplet} :
\exemple{5-cycle incomplet}|\chemfig{*5(-B=C-D)}|
Si un cycle a un code qui contient trop de liaisons et de groupes d'atomes pour le nombre de sommets spécifiés, toutes les liaisons et les groupes au delà du maximum admissible sont ignorés :
\exemple{5-cycle tronqué}|\chemfig{A*5(-B=C-D-E=F-G=H-I)}|

Il est possible de dessiner un cercle ou un arc de cercle à l'intérieur d'un cycle\idx*{cycle!cercle intérieur}. Pour cela, on utilise cette syntaxe :
\centerverb/<atome>**[<angle 1>,<angle 2>,<tikz>]<n>(<code>)/
\smallskip

où chaque champ de l'argument optionnel prend sa valeur par défaut s'il est vide :
\begin{itemize}
	\item \verb/<angle 1>/ et \verb/<angle 2>/ sont les angles absolus de départ et de fin de l'arc de cercle. Ceux-ci valent 0\degres{} et 360\degres{} de telle sorte qu'un cercle complet est tracé par défaut;
	\item \verb/<tikz>/ est le code qui sera passé à \TIKZ pour le dessin de l'arc de cercle.
\end{itemize}

\exemple{Cycles et arcs de cercle}|\chemfig{**6(------)}\quad
\chemfig{**[30,330]5(-----)}\quad
\chemfig{**[0,270,dash pattern=on 2pt off 2pt]4(----)}|

\subsection{Position angulaire}
\subsubsection{Au départ}
\idx*{cycle!position angulaire}Comme on le voit dans les exemples ci-dessous, la règle est que l'atome d'attache «\verb/A/» se trouve toujours au sud ouest du cycle. De plus, le cycle est toujours construit dans le sens trigonométrique et la dernière liaison tombe verticalement sur l'atome de rattachement :
\exemple{Position angulaire des cycles}|\chemfig{A*4(-B-C-D-)}\qquad\chemfig{A*6(------)}|

Si cette position angulaire ne convient pas, il est possible de spécifier via l'argument optionnel du début de la molécule un autre angle par défaut. Voici un 6-cycle qui a été pivoté de $+30\degres$, de $-30\degres$ puis de $+60\degres$ :
\exemple[55]{Rotation des cycles}|\chemfig{[:30]A*6(------)}\qquad
\chemfig{[:-30]A*6(------)}\qquad
\chemfig{[:60]A*6(------)}|

\subsubsection{Après une liaison}
Lorsqu'un cycle ne commence pas une molécule et qu'une (ou plusieurs) liaisons ont été auparavant tracées, la position angulaire par défaut change : le cycle est tracé de telle sorte que la liaison qui arrive sur l'atome de rattachement soit la bissectrice du premier et du dernier côté du cycle.

Voici un  cas simple :
\exemple{Liaison arrivant sur un cycle}|\chemfig{A-B*5(-C-D-E-F-)}|

La règle reste valable, quelque soit l'angle de la liaison précédente :
\exemple{Liaisons arrivant sur un cycle}|\chemfig{A-[:25]B*4(----)}\vskip5pt
\chemfig{A=[:-30]*6(=-=-=-)}|

\subsection{Ramifications partant d'un cycle}
\idx*{cycle!ramification}Pour faire partir une ramification d'un des sommets du cycle, on emploie la syntaxe déjà vue :
\centerverb/<atome>(<code>)/
\smallskip

où le \verb/<code>/ est celui de la sous molécule et l'\verb-<atome>- occupe le sommet. Une chose particulière aux cycles est que l'angle par défaut de la sous molécule n'est pas 0\degres{} mais est calculé de telle sorte qu'il soit la bissectrice des côtés partant du sommet :
\exemple{Ramification partant d'un cycle}|\chemfig{X*6(-=-(-A-B=C)=-=-)}|

On peut faire partir une sous molécule du premier sommet du cycle, ainsi que de tous les autres sommets :
\exemple{Cycle et ramifications}|\chemfig{*5((-A=B-C)-(-D-E)-(=)-(-F)-(-G=)-)}|

Si on souhaite que la liaison partant d'un sommet ne soit pas la bissectrice de ses côtés, on peut jouer sur le paramètre optionnel global ou le paramètre optionnel de la liaison :
\exemple[50]{Ramifications et angles spécifiés}|\chemfig{*5(---([:90]-A-B)--)}\qquad
\chemfig{*5(---(-[:90]A-B)--)}\qquad
\chemfig{*5(---([::+0]-A-B)--)}|

Il est intéressant de constater au troisième exemple que si on spécifie un angle relatif de 0\degres, la liaison se fait dans le prolongement de la liaison qui précédait dans le cycle. C'est la règle de la page \pageref{angle.relatif} qui spécifiait que l'angle de référence était celui de la dernière liaison tracée.

On peut désormais lier des cycles entre eux par des liaisons :
\exemple{Cycles liés}|\chemfig{*6(--(-*5(----(-*4(----))-))----)}|

\subsection{Cycles emboîtés}
\idx*{cycle!imbrication}Pour «coller» 2 cycles entre eux, la syntaxe est légèrement différente : on identifie le sommet d'où va commencer l'autre cycle. Il suffit de faire suivre ce sommet par la syntaxe habituelle d'un cycle. Voici par exemple un 5-cycle qui part du deuxième sommet d'un 6-cycle :
\exemple{Cycles imbriqués}|\chemfig{A*6(-B*5(----)=-=-=)}|

On remarque que le cycle qui vient se greffer sur le cycle principal a une position angulaire telle que deux de leurs côté coïncident. De plus, le 5-cycle n'a que 4 liaisons «\verb/----/». En effet, la 5\ieme{} serait inutile puisqu'il s'agit du deuxième côté du 6-cycle qui est déjà tracé.

Il est bien entendu possible de coller plusieurs cycles entre eux :
\exemple{Plusieurs cycles imbriqués}|\chemfig{*5(--*6(-*4(-*5(----)--)----)---)}|

Il y a un cas où on doit employer une ruse. On voit sur cet exemple que le quatrième côté du deuxième 5-cycle vient boucler sur le centre de l'atome «\verb-E-».
\exemple{Dessin non parfait}|\chemfig{A-B*5(-C-D*5(-X-Y-Z-)-E-F-)}|

Ceci est normal puisque le deuxième 5-cycle (qui part de l'atome «\verb-D-») est dessiné \emph{avant} que \CF n'ait pris connaissance de l'atome «\verb-E-». Dans ce cas, il faut se servir de deux crochets pour tracer la liaison \verb/Z-E/ :
\exemple{Liaison distante et cycle}|\chemfig{A-B*5(-C-D*5(-X-Y-Z?)-E?-F-)}|

On aurait aussi pu utiliser un \verb-\phantom{E}- au dernier sommet du 5-cycle :
\exemple{Utilisation de \string\phantom}/\chemfig{A-B*5(-C-D*5(-X-Y-Z-\phantom{E})-E-F-)}/

\subsection{Cycles et groupes d'atomes}
Il faut prendre des précautions avec les cycles lorsque un ou plusieurs sommets sont constitués de plusieurs atomes :
\exemple{Cycle et groupes d'atomes}|\chemfig{AB*5(-CDE-F-GH-I-)}|

Pour que le cycle ait une forme régulière, il faut passer outre le mécanisme de \CF qui calcule automatiquement les atomes de départ et d'arrivée des liaisons\idx*{liaison!atome de départ et d'arrivée}. Ici, il faut relier \verb/C-F/ et \verb/F-G/ en le spécifiant avec l'argument optionnel de ces liaisons\idx*{liaison!argument optionnel} :
\exemple{Atomes de départ et d'arrivée imposés}|\chemfig{AB*5(-CDE-[,,1]F-[,,,1]GH-I-)}|\idx*{cycle|)}

\section{Représentation des déplacements d'électrons}\label{mecanismes-reactionnels}\idx*{mécanismes réactionnels|(}
Depuis la version 0.3 de \CF, on peut représenter les déplacements d'électrons des effets mésomères ou des mécanismes réactionnels. Cela est rendu possible en marquant le point de départ et le point d'arrivée de la flèche que l'on utilise pour indiquer la migration des électrons à l'aide de la syntaxe «\verb-@{<argument>}-»\idx*{"@}. Cette syntaxe permet de poser un nœud (au sens de \TIKZ) en rendant ce nœud accessible en dehors de l'argument de la commande \verb-\chemfig- grâce à l'option «\texttt{remember picture}» qui est passée à tous les environnements «\idx{tikzpicture}». Cela suppose que le visualiseur prenne en charge le «\idx{picture remembering}» et que la compilation soit lancée deux fois.

Deux cas de figure peuvent se présenter, on peut poser :
\begin{itemize}
	\item un nœud de dimension nulle sur une liaison en utilisant la syntaxe «\verb-@{<nom>,<coeff>}-» placée immédiatement au début de l'argument optionnel de la liaison concernée sans être suivi d'une virgule s'il y a un premier argument optionnel. Dans ce cas, le nœud portera le nom «\verb-<nom>-» et le \verb-<coeff>-, compris entre 0 et 1, déterminera où le nœud se situera sur la liaison. Si on utilise «\verb-@{<nom>}-», le \verb-<coeff>- prend la valeur de 0.5 par défaut ce qui signifie que le nœud est posé au milieu de la liaison;
	\item un nœud sur un atome en utilisant la syntaxe «\verb-@{<nom>}-» immédiatement avant l'atome concerné. Dans ce cas, le nœud a exactement le même encombrement que l'atome, il peut notamment être vide et donc avoir des dimensions nulles.
\end{itemize}
Une fois que la commande \idx{\chemfig} a dessiné la (ou les) molécule(s) et a posé les nœuds avec la syntaxe décrite ci dessus, on peut relier ces nœuds entre eux avec les instructions de \TIKZ. Ces instructions seront placées dans l'argument de la commande \verb-\chemmove-\idx*{chemmove@\protect\texttt{\protect\string\protect\chemmove}|(}\footnote{En réalité, la commande \texttt{\string\chemmove} place son argument dans un environnement «\idx{tikzpicture}» dans lequel les options sont «\texttt{remember picture,overlay}».} et auront la syntaxe suivante si par exemple, on doit relier un nœud portant le nom «\verb-<nom1>-» au nœud portant le nom «\verb-<nom2>-» :
\centerverb|\chemmove[<opt>]{\draw[<opt tikz>](<nom1>)<link tikz>(<nom2>);}|
\smallskip

L'argument optionnel \verb-<opt>- de la commande \verb-\chemmove- sera ajouté à l'argument de l'environnement \idx{tikzpicture} dans lequel seront tracées les liaisons entre les nœuds. Les instructions \verb-<opt tikz>- et \verb-<link tikz>- sont exhaustivement décrites dans la documentation de l'extension \TIKZ.

\subsection{Effets mésomères}
Pour fixer les idées prenons l'exemple d'un effet mésomère impliquant une double liaison et un doublet non liant conjugués. Commençons par la possible délocalisation des électrons de la double liaison. On va poser un nœud nommé «db» (double bond) au milieu de la double liaison et un nœud nommé «a1» sur l'extrémité de la double liaison.

Les macros \verb|\schemestart|, \verb|\schemestop|, \verb|\arrow| et \verb|\+| sont exposées au chapitre \ref{schemas}, à partir de la page \pageref{schemas}.

\exemple{Effet mésomère 1}/\schemestart
	\chemfig{@{a1}=_[@{db}::30]-[::-60]\lewis{2,X}}
	\arrow{<->}
	\chemfig{\chemabove{\vphantom{X}}{\ominus}-[::30]=_[::-60]
	\chemabove{X}{\scriptstyle\oplus}}
\schemestop
	\chemmove{\draw(db).. controls +(100:5mm) and +(145:5mm).. (a1);}/

Comme on l'a dit, on remarque qu'il n'y pas de virgule derrière le nœud posé dans les arguments optionnels d'une liaison. On écrit «\verb|=_[@{db}::30]|» et non pas «\verb|=_[@{db},::30]|» comme on serait tenté de le faire.

Pour relier les nœuds «db» et «a1», nous avons utilisé la syntaxe suivante :
\centerverb|\chemmove{\draw(db)..controls +(100:5mm) and +(145:5mm)..(a1);}|
\medskip

Le style de flèche par défaut dans \verb|\chemmove| est «CF». Dans cet exemple nous demandons une flèche (\verb/[->]/) et nous utilisons 2 points de contrôle\idx*{points de controle@points de contrôle}\footnote{Pour connaître toutes les façons de relier deux nœuds avec \TIKZ, lire la documentation de ce package.}. Ceux-ci seront situés en coordonnées polaires à 100\degres{} et 5~mm de «db» pour le premier et à 145\degres{} et 5~mm de «a1» pour le second. Il ne faut pas être effrayé par cette syntaxe qui peut paraître compliquée en première lecture car son utilisation se réduit dans la plupart des cas à un simple copier-coller dans lequel on modifie juste le nom des nœuds et les coordonnées polaires des points de contrôle. Ce que nous allons vérifier tout de suite avec l'ajout d'une flèche partant du doublet non liant (nœud «dnl») vers la liaison simple (nœud «sb»).
\exemple{Effet mésomère 2}/\schemestart
	\chemfig{@{a1}=_[@{db}::30]-[@{sb}::-60]@{dnl}\lewis{2,X}}
	\arrow{<->}
	\chemfig{\chemabove{\vphantom{X}}{\ominus}-[::30]=_[::-60]
	\chemabove{X}{\scriptstyle\oplus}}
\schemestop
\chemmove{
    \draw(db)..controls +(100:5mm) and +(145:5mm)..(a1);
    \draw(dnl)..controls +(90:4mm) and +(45:4mm)..(sb);}/

Pour notre nouvelle flèche nous avons fixé les points de contrôle\idx*{points de controle@points de contrôle} comme suit : un angle de 90\degres{} à 4~mm de «dnl» et un angle de 45\degres{} à 4~mm de «sb». Mais nous ne sommes pas entièrement satisfaits car nous aimerions que la flèche ne touche pas le trait représentant le doublet non liant. Pour cela nous allons ajouter quelques options à notre flèche.
\exemple{Effet mésomère 3}/\schemestart
	\chemfig{@{a1}=_[@{db}::30]-[@{sb}::-60]@{dnl}\lewis{2,X}}
	\arrow{<->}
	\chemfig{\chemabove{\vphantom{X}}{\ominus}-[::30]=_[::-60]
	\chemabove{X}{\scriptstyle\oplus}}
\schemestop
\chemmove[->]{% change le style de flèche
    \draw(db).. controls +(100:5mm) and +(145:5mm).. (a1);
    \draw[shorten <=3pt,shorten >=1pt](dnl) .. controls +(90:4mm)
          and +(45:4mm) .. (sb);}/

L'option «\verb|shorten <=3pt|» indique que le point de départ de la flèche doit être raccourci de 3~pt de même «\verb|shorten >=2pt|» indique que le point d'arrivé doit être raccourci de 2~pt.

On peut utiliser toute la puissance des instructions de \TIKZ pour modifier le dessin de la flèche. Ici, nous changeons l'extrémité de la flèche partant de la double liaison en «\verb|-stealth|», nous la dessinons en pointillés d'épaisseur fine et rouge. Nous rajoutons également la lettre $\pi$ au dessus de la flèche en son milieu :
\exemple{Effet mésomère 4}/\schemestart
	\chemfig{@{a1}=_[@{db}::30]-[@{sb}::-60]@{dnl}\lewis{2,X}}
	\arrow{<->}
	\chemfig{\chemabove{\vphantom{X}}{\ominus}-[::30]=_[::-60]
	\chemabove{X}{\scriptstyle\oplus}}
\schemestop
\chemmove{
    \draw[-stealth,thin,dash pattern= on 2pt off 2pt,red]
        (db).. controls +(100:5mm) and +(145:5mm)..
        node[sloped,above] {$\pi$} (a1);
    \draw[shorten <=3pt, shorten >= 1pt]
        (dnl).. controls +(90:4mm) and +(45:4mm).. (sb);}/

Dans l'exemple suivant nous allons voir comment indiquer la position de l'ancre de départ ou d'arrivée. Si nous écrivons
\exemple{Ancre de départ et d'arrivée 1}/\chemfig{@{x1}\lewis{1:,X}}
\hspace{2cm}
\chemfig{@{x2}\lewis{2|,X}}
\chemmove{
    \draw[shorten >=4pt](x1).. controls +(90:1cm) and +(90:1cm).. (x2);}/

Nous constatons que l'ancre de départ de notre flèche ne pointe pas correctement sur nos électrons. La flèche part du milieu du bord supérieur du nœud. En effet, nous avons choisi un angle de départ de 90\degres{} et \TIKZ fait donc partir la flèche de l’ancre «x1.90» qui correspond à l’intersection de la demi droite partant du centre du nœud «x1» et faisant un angle avec l’horizontale de 90\degres{} avec le bord du nœud qui est un rectangle. Pour obtenir le départ de la flèche d’où nous voulons, nous devons spécifier sa position. Après quelques tâtonnements, c’est «x1.57» :
\exemple{Ancres de départ et d'arrivée 2}/\chemfig{@{x1}\lewis{1:,X}}
\hspace{2cm}
\chemfig{@{x2}\lewis{2|,X}}
\chemmove[shorten <=4pt,shorten >=4pt]{
    \draw(x1.57).. controls +(60:1cm) and +(120:1cm).. (x2);}/

Dans certains cas il sera plus facile d'utiliser les coordonnées cartésiennes pour les points de contrôle\idx*{points de controle@points de contrôle}. Ici, nous n'utilisons qu'un seul point de contrôle situé à 1~cm horizontalement de «x1» et 1,5~cm verticalement :
\exemple{Un seul point de contrôle}/\chemfig{@{x1}\lewis{1:,X}}
\hspace{2cm}
\chemfig{@{x2}\lewis{2|,X}}
\chemmove[shorten <=4pt,shorten >=4pt]{
    \draw(x1.57).. controls +(1cm,1.5cm).. (x2);}/

Dans ce cas nous plaçons un point de contrôle à 1~cm horizontalement et 2~cm verticalement de «x1». Tous les objets graphiques dessinées par l’intermédiaire de la commande \verb|\chemmove| sont faits en surimpression et ne seront pas comptés dans les boîtes englobantes. On peut le constater sur l’exemple précédent.

\subsection{Mécanismes réactionnels}
Grâce à l'option \verb|remember picture| qui est passée à tous les environnements «tikzpicture» nous pouvons facilement dessiner les flèches indiquant les mécanismes réactionnels. Prenons comme exemple la première étape de la réaction d'estérification\idx*{charge!\protect\texttt{\protect\string\protect\oplus}}.
\exemple*{Estérification: étape 1}/\setatomsep{7mm}
\schemestart
	\chemfig{R-@{dnl}\lewis{26,O}-H}
	\+
	\chemfig{R-@{atoc}C([6]-OH)=[@{db}]O}
	\arrow(.mid east--){<->[\chemfig{@{atoh}\chemabove{H}{\scriptstyle\oplus}}]}
\schemestop
\chemmove[shorten <=2pt]{
    \draw(dnl)..controls +(90:1cm)and+(north:1cm)..(atoc);
    \draw[shorten >=6pt](db)..controls +(north:5mm)and+(100:1cm)..(atoh);}/

L'utilisation de la commande \verb|\chemabove{<code>}{<materiel>}|\idx*{\chemabove} ne change pas les dimensions de la boîte englobante\idx*{boite englobante@boîte englobante} du \verb|<code>|. Pour cette raison on peut rencontrer certaines difficultés pour pointer sur le matériel indiquant la charge portée ($\oplus$ ou $\ominus$). Dans l'exemple ci-dessus la solution est de créer un point de contrôle\idx*{points de controle@points de contrôle} avec un angle de 110\degres{} à 1~cm de «atoh» et de raccourcir la flèche de 6pt. Dans l'exemple suivant, seconde étape de la réaction d'estérification, on peut voir que la flèche peut prendre des formes plus compliquées sans forcément surcharger le code.
\exemple{Estérification: étape 2}/\setatomsep{7mm}
\chemfig{R-O-C(-[2]R)(-[6]OH)-@{dnl}\lewis{26,O}H}\hspace{1cm}
\chemfig{@{atoh}\chemabove{H}{\scriptstyle\oplus}}
\chemmove{
    \draw[shorten <=2pt, shorten >=7pt]
        (dnl).. controls +(south:1cm) and +(north:1.5cm).. (atoh);}/

Nous laissons le soin au lecteur d'écrire la suite\idx*{chemmove@\protect\texttt{\protect\string\protect\chemmove}|)}\ldots\idx*{mécanismes réactionnels|)}

\section{Écrire un nom sous une molécule}\label{chemname}
Pour plus de commodité, \CF permet d'écrire le nom d'une molécule sous celle-ci avec la commande\idx*\chemname
\centerverb/\chemname[<dim>]{\chemfig{<code de la molécule>}}{<nom>}/
\smallskip

La \verb-<dimension>-, qui vaut 1.5ex par défaut, sera insérée verticalement entre la \idx{ligne de base} de la molécule et le haut des lettres du \verb-<nom>-. Le \verb-<nom>- sera centré par rapport à la molécule mais ce \verb-<nom>- ne peut pas contenir plusieurs paragraphes. Comme on le voit sur cet exemple : \chemname{\chemfig{H-O-H}}{\scriptsize\bfseries La molécule d'eau : $\mathrm{\mathbf{H_2O}}$}, le \verb-<nom>- qui est affiché sous la molécule est pris en compte dans la boîte englobante mais uniquement en ce qui concerne sa dimension \emph{verticale}. L'encombrement horizontal du \verb-<nom>- est toujours nul.

Voici une réaction avec les noms sous les molécules\idx*{reaction chimique@réaction chimique} :
\exemple*{Affichage du nom des molécules}/\schemestart
	\chemname{\chemfig{R-C(-[:-30]OH)=[:30]O}}{Acide carboxylique}
	\+
	\chemname{\chemfig{R'OH}}{Alcool}
	\arrow(.mid east--.mid west)
	\chemname{\chemfig{R-C(-[:-30]OR')=[:30]O}}{Ester}
	\+
	\chemname{\chemfig{H_2O}}{Eau}
\schemestop
\chemnameinit{}/

Il y a quelques contraintes avec cette commande. Pour en pendre conscience, mettons que l'on ait inversé l'acide et l'alcool dans le membre de gauche :
\exemple*{Alignement des noms 1}/\schemestart
	\chemname{\chemfig{R'OH}}{Alcool}
	\+
	\chemname{\chemfig{R-C(-[:-30]OH)=[:30]O}}{Acide carboxylique}
	\arrow(.mid east--.mid west)
	\chemname{\chemfig{R-C(-[:-30]OR')=[:30]O}}{Ester}
	\+
	\chemname{\chemfig{H_2O}}{Eau}
\schemestop
\chemnameinit{}/

En fait, au dessous de la ligne de base de chaque molécule (en gris clair sur les exemples de ce manuel), pour écrire le \verb-<nom>-, la commande \idx{\chemname} insère 1.5ex${}+{}$\emph{la plus grande des profondeurs\footnote{En langage \TeX{}, la profondeur est la dimension qui s'étend verticalement sous la ligne de base.} des molécules rencontrées}. \label{chemnameinit}La macro \verb-\chemnameinit{<argument>}-\idx*{\chemnameinit} initialise cette plus grande profondeur avec le contenu de l'\verb-<argument>-. Il convient donc :
\begin{itemize}
	\item d'écrire \verb-\chemnameinit{<plus profonde molécule>}- avant d'impliquer cette commande dans une réaction, sauf si cette réaction commence par la plus profonde molécule;
	\item d'écrire \verb-\chemnameinit{}- après avoir écrit tous les noms d'une réaction chimique afin d'éviter que la plus grande profondeur trouvée dans cette réaction n'interfère dans une réaction future.
\end{itemize}

Le code correct est donc d'utiliser \idx{\chemnameinit} avant et après la réaction :
\exemple*{Alignement des noms 2}/\chemnameinit{\chemfig{R-C(-[:-30]OH)=[:30]O}}
\schemestart
	\chemname{\chemfig{R'OH}}{Alcool}
	\+
	\chemname{\chemfig{R-C(-[:-30]OH)=[:30]O}}{Acide carboxylique}
	\arrow(.mid east--.mid west)
	\chemname{\chemfig{R-C(-[:-30]OR')=[:30]O}}{Ester}
	\+
	\chemname{\chemfig{H_2O}}{Eau}
\schemestop
\chemnameinit{}/

Enfin, pour écrire un nom sur plusieurs lignes, la commande \idx*{\protect\symbol{'134}\protect\symbol{'134}@\protect\texttt{\protect\symbol{'134}\protect\symbol{'134}}} rencontrée dans un \verb-<nom>- effectue un retour à la ligne\footnote{Par contre, la commande \texttt{\textbackslash par} est interdite et provoquera une erreur à la compilation.} :% TODO : \\ absente du pdf
\exemple*{Nom sur 2 lignes}/\schemestart
	\chemname{\chemfig{R-C(-[:-30]OH)=[:30]O}}{Acide\\carboxylique}
	\+
	\chemname{\chemfig{R'OH}}{Alcool}
	\arrow(.mid east--.mid west)
	\chemname{\chemfig{R-C(-[:-30]OR')=[:30]O}}{Ester}
	\+
	\chemname{\chemfig{H_2O}}{Eau}
\schemestop
\chemnameinit{}/

Si l'on écrit \verb|\chemname*{<nom>}|, alors la macro ne tient pas compte des noms rencontrés précédemment.
\newpage

\part{Utilisation avancée}\label{utilisation.avancee}
\section{Découpage des atomes}\label{decoupage.atomes}
Le mécanisme de découpage en atomes\idx*{decoupage en atomes@découpage en atomes}, déjà décrit auparavant, fait s'étendre chaque atome jusqu'à la prochaine lettre majuscule ou l'un des caractères {\ttfamily \boxedfalseverb{-} \boxedfalseverb{=} \boxedfalseverb{~} \boxedfalseverb{(} \boxedfalseverb{!} \boxedfalseverb{*} \boxedfalseverb{<} \boxedfalseverb{>} \boxedfalseverb{@}}

Dans certains cas, ce découpage automatique produit des atomes incorrects ce qui peut se traduire par un affichage imparfait. Prenons cette molécule par exemple où l'on remarquera que le caractère «\texttt(» est mis entre accolade de façon à éviter que \CF ne comprenne à tort qu'une ramification est créée :

\exemple*{Alcène}/\chemfig{CH_3CH_2-[:-60,,3]C(-[:-120]H_3C)=C(-[:-60]H)-[:60]C{(}CH_3{)}_3}/

On constate que la liaison qui arrive sur l'atome de carbone en haut à droite est trop courte. Cela se produit car, si l'on applique les règles de découpage\idx*{decoupage en atomes@découpage en atomes} de \CF dans le groupe d'atomes en haut à droite, les atomes sont découpés de cette façon : «\texttt{\detokenize{C{(}}}», «\texttt{\detokenize{C}}», «\texttt{\detokenize{H_3{)}_3}}». On comprend alors qu'en mode math, le premier atome qui contient une parenthèse ait une profondeur trop importante comme on le voit en rendant visibles les boîtes contenant les atomes :
\begin{center}
\fboxsep=0pt
\renewcommand*\printatom[1]{\fbox{\ensuremath{\mathrm{#1}}}}%
\chemfig{CH_3CH_2-[:-60,,3]C(-[:-120]H_3C)=C(-[:-60]H)-[:60]C{(}CH_3{)}_3}%
\end{center}
Le caractère «|» provoque la coupure de l'atome en cours à l'endroit où il est rencontré. Ainsi, on peut écrire \texttt{C\textcolor{red}{|}\detokenize{{(CH_3)_3}}} pour faire en sorte que \CF ne découpe que 2 atomes ici : «\texttt{\detokenize{C}}» et «\texttt{\detokenize{{(CH_3)_3}}}. Le problème de la liaison trop courte est ainsi résolu :

\exemple*{Alcène}/\chemfig{CH_3CH_2-[:-60,,3]C(-[:-120]H_3C)=C(-[:-60]H)-[:60]C|{(CH_3)_3}}/

\section{Affichage des atomes}\label{perso.affichage}
Une fois le découpage en atomes effectué, la macro \idx{\printatom} est appelée de façon interne par \CF pour afficher chaque atome. Son unique argument est le code produisant l'affichage de l'atome (par exemple «\verb-H_3-»). Par défaut, cette macro se place en mode mathématique\idx*{mode mathematique@mode mathématique} et affiche son argument avec la police mathématique «rm». Elle est définie par le code suivant :
\begin{itemize}
	\item \verb|\newcommand*\printatom[1]{\ensuremath{\mathrm{#1}}}|\qquad en compilant avec \LaTeX{}\idx*{Latex@\protect\LaTeX}
	\item \verb|\def\printatom#1{\ifmmode\rm#1\else$\rm#1$\fi}|\qquad en compilant avec $\varepsilon$\TeX{}\idx*{etex@$\protect\varepsilon$\protect\TeX} ou Con\TeX tX\idx*{ConTeXt@Con\protect\TeX{}t}.
\end{itemize}\medskip

On peut modifier le code de cette macro pour personnaliser l'affichage de atomes. Dans l'exemple ci-dessous, on redéfinit \idx{\printatom} de façon à ce que chaque atome soit contenu dans une boîte rectangulaire :
\exemple{Redéfinition de \string\printatom}/\fboxsep=1pt
\renewcommand*\printatom[1]{\fbox{\ensuremath{\mathrm{#1}}}}
\chemfig{H_3C-C(=[:30]O)(-[:-30]OH)}/

Voici comment la redéfinir pour utiliser de la police «sf» du mode math :
\exemple{Atomes affichés en police «sf»}/\renewcommand*\printatom[1]{\ensuremath{\mathsf{#1}}}
\chemfig{H_3C-C(=[:30]O)(-[:-30]OH)}/

\section{Arguments optionnels}\label{arguments.optionnels}
La commande \idx{\chemfig} admet deux arguments optionnels\idx*{chemfig@\protect\texttt{\protect\string\protect\chemfig}!arguments optionnels} et sa syntaxe complète est la suivante :
\centerverb|\chemfig[<opt1>][<opt2>]{<code molécule>}|
\smallskip

Le premier argument optionnel \verb-<opt1>- contient des instructions \TIKZ qui seront passées à l'environnement \idx{tikzpicture} dans lequel est dessinée la molécule. Le deuxième argument optionnel \verb-<opt2>- contient des instructions \TIKZ qui seront exécutées lors du dessin de chaque nœud\footnote{Ces instructions sont ajoutées à la fin de l'argument de \texttt{every node/.style\{<argument>\}}. Cet argument contient par défaut les instructions suivantes : «{\ttfamily anchor=base,inner sep=0pt,outer sep=0pt,minimum size=0pt}».}.

Par l'intermédiaire du premier argument optionnel, on peut choisir par exemple la couleur générale ou l'épaisseur des lignes :
\exemple{Choix du style}/\chemfig{A-B-[2]C}\par\medskip
\chemfig[line width=1.5pt]{A-B-[2]C}\par\medskip
\chemfig[red]{A-B-[2]C}/

Avec le second argument optionnel, on peut choisir la couleur des nœud dessinés par \TIKZ, modifier l'inclinaison du dessin ou changer l'échelle\idx*{taille des molécules@taille des molecules} :
\exemple{Choix des styles}/\chemfig{A-B-[2]C}\par\medskip
\chemfig[][red]{A-B-[2]C}\par\medskip
\chemfig[dash pattern=on 1pt off 2pt][red]{A-B-[2]C}\par\medskip
\chemfig[][rotate=20]{A-B-[2]C}\par\medskip
\chemfig[][scale=0.5]{A-B-[2]C}/

\section{Alignement vertical}\label{alignement.vertical}
\idx*{alignement vertical}Dans certains cas de molécules semi développées dont les liaisons sont horizontales, le placement des groupes d'atomes est incorrect.

Un examen attentif de l'exemple suivant révèle que les groupes d'atomes ne sont pas correctement alignés sur la \idx{ligne de base} :
\exemple*{Placement horizontal}/\Huge\setatomsep{2em}
\chemfig{A^1-B-C-D}\qquad
\chemfig{E_1-F-G-H}/

Il est étonnant que le deuxième atome soit correctement aligné alors que les deux derniers subissent un décalage vertical qui semblent être la conséquence de la hauteur différente de la boîte englobant le premier atome «\verb-A^1-» et «\verb-E_1-».

Pour comprendre ce phénomène, il faut examiner comment \CF place les groupes d'atomes les uns par rapport aux autres. Pour cela, limitons nous aux liaisons horizontales ce qui permet d'employer un vocabulaire particulier, mais l'algorithme est le même pour les autres inclinaisons. En fait, une liaison horizontale part du milieu du côté droit de la boîte englobant l'atome d'où part cette liaison. L'atome d'arrivée est positionné de telle sorte que le milieu du côté gauche de sa boîte englobante soit à l'extrémité de la liaison. Il en découle que le placement vertical de l'atome d'arrivée dépend de l'encombrement vertical de l'atome de départ. Pour limiter ce phénomène, \CF ajoute devant chaque atome d'arrivée le \idx{\vphantom} de l'atome de départ, mais sans l'inclure dans le contenu de cet atome d'arrivée : ce \idx{\vphantom} n'est donc pas destiné à se répercuter sur les atomes suivants. Les atomes qui restent dans chaque groupe sont alignés de telle sorte que leur ligne de base coïncide avec la ligne de base de l'atome précédent.

On peut donc mieux expliquer l'alignement défectueux constaté. Les atomes «\verb-B-» et «\verb-F-» sont correctement alignés car ils tiennent compte de la hauteur des atomes qui les précèdent grâce à leur \idx\vphantom. Pour les atomes «\verb-C-» et «\verb-F-», la hauteur des atomes précédents est prise en compte, mais celle des atomes «\verb-A^1-» et «\verb-E_1-» est oubliée ! Il en résulte que, dépendant de l'altitude de ces liaisons, ces atomes sont un peu trop haut ou trop bas.

On peut mettre en évidence ce phénomène en rendant visible les boîtes englobantes des atomes où l'on voit clairement que les atomes «\verb-B-» et «\verb-F-» ont des boîtes englobantes dont la hauteur qui tient compte des hauteurs des atomes précédents :
\exemple*{Placement horizontal et boîtes englobantes}/\Huge\setatomsep{2em}
\fboxsep=0pt
\renewcommand\printatom[1]{\fbox{\ensuremath{\mathrm#1}}}
\chemfig{A^1-B-C-D}\qquad
\chemfig{E_1-F-G-H}/

Aucune solution automatique n'étant satisfaisante, on peut contourner manuellement ce problème en plaçant \emph{à l'intérieur} du troisième atome un \idx{\vphantom} ayant la même hauteur que le premier pour que cette hauteur se répercute sur les suivants :
\exemple*{Contournement du placement vertical}/\Huge\setatomsep{2em}
\chemfig{A^1-B-{\vphantom{A^1}C}-D}\qquad
\chemfig{E_1-F-{\vphantom{E_1}G}-H}/

\label{chemskipalign}Il est possible pour n'importe quel groupe d'atomes de désactiver momentanément le mécanisme d'ajustement d'alignement et neutraliser le \idx\vphantom. Il suffit pour cela de placer dans le groupe d'atomes la commande \idx{\chemskipalign} : l'alignement reprendra au groupe d'atomes suivant comme si le groupe d'atome contenant \idx{\chemskipalign} n'avait pas existé. On peut se rendre compte sur l'exemple suivant de l'effet de cette instruction qui a pour effet de placer le point de référence de la boîte contenant le premier atome au niveau de la liaison qui arrive de gauche. Les boîtes englobant les atomes ont été dessinées à la seconde ligne :

\exemple[60]{Désactivation du mécanisme d'alignement}/\large
\chemfig{A-.-B}\quad
\chemfig{A-\chemskipalign.-B}\par\bigskip
\fboxsep=0pt
\renewcommand\printatom[1]{\fbox{\ensuremath{\mathrm{#1}}}}
\chemfig{A-.-B}\quad
\chemfig{A-\chemskipalign.-B}/

Cette commande est à utiliser avec précaution car l'alignement des atomes dans le groupe d'atomes à venir peut être perturbé. En règle générale, tout se passera bien si le groupe d'atomes dans lequel figure \idx{\chemskipalign} contient \emph{un seul atome} dont la hauteur et la profondeur sont \emph{inférieures} à celles de l'atome qui précède et qui suit, et si les atomes qui précèdent et suivent ont leur profondeur et hauteur égales. Voici par exemple la mésaventure qui arrive lorsque le groupe d'atomes contient 2 atomes, ici «\verb-\chemskipalign.-» et «\verb-B-» :
\exemple{Conséquence de la commande \string\chemskipalign}/\large
\fboxsep=0pt
\renewcommand\printatom[1]{\fbox{\ensuremath{\mathrm{#1}}}}
\chemfig{A-\chemskipalign.B-C}/

Cette fonctionnalité peut parfois s'avérer utile. Mettons que l'on veuille dessiner la molécule
\begin{center}
	\catcode`;12
	\def\emptydisk{\chemskipalign\tikz\draw(0,0)circle(2pt);}%
	\def\fulldisk{\chemskipalign\tikz\fill(0,0)circle(2pt);}%
	\chemfig{A-#(,0pt)\emptydisk-#(0pt,0pt)\fulldisk-#(0pt)B}%
\end{center}
On peut définir les commandes qui vont dessiner les disques vides et pleins avec \TIKZ. Afin que ces disques soit à la bonne hauteur, c'est-à-dire à la hauteur de la liaison qui leur arrive dessus, on se servira de la commande \idx{\chemskipalign}. Pour que, à la deuxième ligne de l'exemple ci dessous, les liaisons «collent» aux disques, nous utiliserons la possibilité de modifier le retrait d'une liaison avec le caractère «\verb-#-»\idx*{\protect\symbol{'043}@\protect\texttt{\protect\symbol{'043}}}, fonctionnalité qui a été vue à la page~\pageref{modif.retrait}. Pour les utilisateurs ayant chargé le package babel avec l'option «frenchb», il est nécessaire de désactiver le caractère actif «\verb-;-» qui marque la fin d'une instruction \TIKZ et qui sinon ne serait pas reconnu en tant que tel. C'est pourquoi on se place dans un groupe où l'on écrit l'instruction \verb-\shorthandoff{;}-\idx*{\shorthandoff} :
\begingroup\catcode`;12 \catcode`#12
\exemple{Utilisation de \string\chemskipalign\ et #}/\begingroup
\shorthandoff{;}
\def\emptydisk{\chemskipalign\tikz\draw(0,0)circle(2pt);}
\def\fulldisk{\chemskipalign\tikz\fill(0,0)circle(2pt);}
\chemfig{A-\emptydisk-\fulldisk-B}\par
\chemfig{A-#(,0pt)\emptydisk-#(0pt,0pt)\fulldisk-#(0pt)B}
\endgroup/\endgroup

\section{Liaisons doubles déportées}
\idx*{liaison!déportées}Toutes les liaisons doubles sont composées de 2 traits et ces traits sont tracés de part et d'autre de la ligne théorique que prendrait la liaison simple. Il est possible de déporter cette liaison double de telle sorte qu'un des deux traits soit sur cette ligne théorique. L'autre trait étant alors au dessus ou au dessous de la liaison. En fait, il est plus rigoureux de dire «à gauche» ou «à droite» de la ligne théorique lorsqu'on parcourt la liaison dans le sens du tracé.

Pour déporter la liaison vers la gauche, il suffit d'écrire «\verb-=^-» et pour la déporter vers la droite «\verb-=_-» :
\exemple{Liaisons doubles déportées}/\chemfig{A-=-B}\par
\chemfig{A-=^-B}\par
\chemfig{A-=_-B}/

Dans les cycles, les liaisons doubles sont automatiquement déportées vers la gauche. On peut cependant les déporter vers la droite en le spécifiant avec «\verb-=_-» :
\exemple{Liaisons doubles déportées et cycles}/\chemfig{*6(-=-=-=)}\qquad
\chemfig{*6(-=_-=_-=_)}/

Les liaisons déportées sont particulièrement utiles dans le tracé de formules topologiques de molécules comprenant chaînes carbonées avec des liaisons doubles. Elles permettent d'avoir une ligne brisée continue, alors que cette ligne brisée serait discontinue avec les liaisons doubles normales :
\exemple{Liaisons déportées et formules topologiques}/\chemfig{-[:30]=[:-30]-[:30]=[:-30]-[:30]}\par
\chemfig{-[:30]=^[:-30]-[:30]=^[:-30]-[:30]}\par
\chemfig{-[:30]=_[:-30]-[:30]=_[:-30]-[:30]}/

\section{Liaisons doubles délocalisées}
\idx*{liaison!delocalisee@délocalisée}Il est parfois nécessaire de tracer une liaison double dont un trait serait plein et l'autre en pointillé. Cette fonctionnalité n'est pas codée en dur dans \CF puisque \TIKZ, avec sa librairie «decorations.markings» le rend possible.

\exemple*{Liaisons délocalisées}|\catcode`\@=11
\tikzset{
	ddbond/.style args={#1}{
		draw=none,
		decoration={%
			markings,
			mark=at position 0 with {
				\coordinate (CF@startdeloc) at (0,\dimexpr#1\CF@double@sep/2)
				coordinate (CF@startaxis) at (0,\dimexpr-#1\CF@double@sep/2);
				},
			mark=at position 1 with {
				\coordinate (CF@enddeloc) at (0,\dimexpr#1\CF@double@sep/2)
				coordinate (CF@endaxis) at (0,\dimexpr-#1\CF@double@sep/2);
				\draw[dash pattern=on 2pt off 1.5pt] (CF@startdeloc)--(CF@enddeloc);
				\draw (CF@startaxis)--(CF@endaxis);
				}
			},
		postaction={decorate}
	}
}
\catcode`\@=12
\chemfig{A-[,,,,ddbond={+}]B-[,,,,ddbond={-}]C}|

\section{Sauvegarde d'une sous molécule}\label{definesubmol}
\idx*{sauvegarde d'une molécule|(}\CF est capable de sauvegarder un \verb-<code>- sous forme d'un alias pour le réutiliser sous forme compacte dans le code d'une molécule. Ceci est particulièrement utile lorsque le \verb-<code>- apparaît plusieurs fois.

Pour cela, on dispose de la commande\idx*{\definesubmol}
\centerverb|\definesubmol{<nom>}{<code>}|
\smallskip

qui sauvegarde le \verb/<code>/ de façon à l'appeler dans le code de la molécule par le raccourci «\verb/!{<nom>}/». Ce \verb-<nom>- peut être :
\begin{itemize}
	\item une suite de caractères : tous les caractères alphanumériques pouvant se trouver entre \texttt{\string\csname} et \texttt{\string\endcsname} sont acceptés;
	\item une séquence de contrôle.
\end{itemize}

Dans tous les cas, si l'alias est déjà défini il est déconseillé de l'écraser avec une nouvelle définition faite avec \idx{\definesubmol}, d'ailleurs, un «warning» sera émis avertissant l'utilisateur que cet alias sera écrasé par le nouveau. Pour écraser la définition d'un alias faite au préalable, il faut utiliser :\label{redefinesubmol}
\centerverb|\redefinesubmol{<nom>}{<code>}|\idx*\redefinesubmol
\smallskip

Voici un code qui dessine la molécule de pentane. On a pris soin auparavant de définir un alias «\verb/xy/» pour le code \verb/CH_2/ :
\exemple{Pentane}|\definesubmol{xy}{CH_2}
\chemfig{H_3C-!{xy}-!{xy}-!{xy}-CH_3}|

Ici, la manœuvre n'est pas très intéressante puisque «\verb/!{xy}/» est aussi long à taper que le code qu'il remplace.

Mais dans certains cas, cette fonctionnalité fait gagner beaucoup de place dans le code de la molécule et en améliore la lisibilité. Dans l'exemple suivant, on dessine la molécule développée de butane. Pour cela, on va définir un alias avec la séquence de contrôle «\verb/\xx/» pour la sous molécule $\mathrm{CH_2}$. Comme on n'emploie que des angles relatifs\idx*{liaison!angle!relatif}, il est possible de faire pivoter la molécule entière de l'angle que l'on veut via l'angle du paramètre optionnel global qui spécifie l'angle par défaut des liaisons de la molécule principale. On met ici 15\degres :
\exemple{Butane}|\definesubmol\xx{C(-[::+90]H)(-[::-90]H)}
\chemfig{[:15]H-!\xx-!\xx-!\xx-!\xx-H}|

La commande \idx{\definesubmol} admet un argument optionnel et sa syntaxe complète est la suivante :
\centerverb/\definesubmol{<nom>}[<code1>]{<code2>}/
\medskip

Dans la cas où l'argument optionnel est présent, l'alias «\verb-!<nom>-» sera remplacé par \verb'<code1>' si la liaison qui arrive sur l'alias vient de droite, c'est à dire si l'angle que fait la liaison entrante est compris entre $-90$\degres{} et 90\degres{}, ces valeurs étant non comprises. Pour tous les autres cas où la liaison arrive de gauche ou verticalement, l'alias sera remplacé par \verb-<code2>-.

On va définir une séquence de contrôle \verb-\Me- pour «méthyl» de telle sorte que l'alias «\verb-!\Me-» soit remplacé par «\verb-H_3C-» lorsque la liaison arrive de droite et par «\verb-CH_3-» lorsqu'elle arrive de gauche. Avec cet alias, on peut observer sur l'exemple que l'on n'a plus à s'occuper de l'angle (que dans certaines molécules plus complexes on ne connaît même pas)\idx*{\definesubmol} :
\exemple{Alias dual}/\definesubmol\Me[H_3C]{CH_3}
\chemfig{*6((-!\Me)=(-!\Me)-(-!\Me)=(-!\Me)-(-!\Me)=(-!\Me)-)}/\idx*{sauvegarde d'une molécule|)}

\section{Décorations}
\subsection{Formule de Lewis}\label{lewis}
\idx*{Lewis (représentation)}La macro \idx{\lewis} permet de placer des paires d'électrons, des électrons ou une lacune. On utilise cette syntaxe :
\centerverb|\lewis{<n1><n2>...<ni>,<atome>}|
\smallskip

où les \verb-<n1>-\ldots\verb-<ni>- représentent les positions (en multiples de 45\degres) désirées autour de l'\verb-<atome>-. Ces entiers doivent être compris entre 0 et 7.

Cette commande peut également être utilisée en dehors de l'argument de \verb-\chemfig-\idx*{\lewis} :
\exemple{La macro \string\lewis}|\lewis{0246,A}\par\medskip
\lewis{1357,B}\par\medskip
\chemfig{H-\lewis{26,O}-S(=[2]\lewis{13,O})
(=[6]\lewis{57,O})-\lewis{26,O}-H}|

Si au lieu d'une paire représentée par une ligne, on souhaite deux points, on fait suivre l'entier par «\verb-:-». Si on veut dessiner un électron, il suffit de le faire suivre par un «\verb-.-». Pour dessiner une lacune, on le fait suivre d'un «\verb-|-»\idx*{\lewis} :
\exemple{Décorations de Lewis}*\lewis{0:2:4:6:,C}\qquad\lewis{1:3:5:7:,C}\par\bigskip
\lewis{0.2.4.6.,C}\qquad\lewis{1.3.5.7.,C}\par\bigskip
\lewis{0:2.4|,X}\par\bigskip
Ion oxonuim : \chemfig{H-\lewis{5|7,O^+}(-[2]H)-H}*

Toutes les décorations dessinées par l'intermédiaire de \idx{\lewis} ne sont pas comptabilisées dans la boîte englobante\idx*{boite englobante@boîte englobante} de l'atome. Les décorations sont faites en surimpression. On en voit une conséquence dans les deux exemples ci-dessus où les cadre ne semblent ne plus être correctement ajustés au dessin de la molécule qui dépasse légèrement vers le bas. Ceci sera parfois observable dans ce chapitre «Décorations» où l'on présente des commandes qui ne modifient pas la boîte englobante.

\label{Lewis}Il faut noter que la macro \idx{\Lewis} fonctionne de la même façon que la macro \verb-\lewis- mais les décorations seront \emph{prises en compte} dans la boîte englobante.

On peut le constater de façon plus évidente en traçant une \verb-\fbox- autour des atomes décorés\idx*{\lewis} :
\exemple{Boîte englobante et macro \string\lewis}*\fboxsep0pt
\fbox{\lewis{0.2.4.6.,A}}\quad\fbox{\Lewis{0.2.4.6.,A}}\par\medskip
\fbox{\lewis{13,B}}\quad\fbox{\Lewis{13,B}}*

\label{setlewis}On peut régler plusieurs paramètres à l'aide la macro\idx*\setlewis
\centerverb|\setlewis[<dim1>]{<dim2>}{<dim3>}{<code tikz>}|
\smallskip

Si un argument est vide, il prend sa valeur par défaut.
\begin{itemize}
	\item \verb-<dim1>- est la largeur du rectangle représentant une lacune obtenue avec le caractère «|». Elle vaut 0.3ex par défaut;
	\item \verb-<dim2>- est la distance entre la boîte englobant l'atome et la décoration. Elle vaut 0.4ex par défaut;
	\item \verb-<dim3>- est la longueur du trait représentant la paire d'électrons. Elle vaut 1.5ex par défaut;
	\item \verb-<code tikz>- est le code qui sera passé directement à \TIKZ. Ce code est vide par défaut.
\end{itemize}

\idx*{\lewis}\exemple{Les paramètres de la macro \string\lewis}*\setlewis{4pt}{1.5em}{red}
\chemfig{A-\lewis{26,B}-C}\par\bigskip
\setlewis[0.8ex]{}{}{line width=1pt}
\chemfig{A-\lewis{2|,B}-C}*

Un problème concernant les décorations de Lewis dans les directions obliques peut parfois survenir. Pour l'atome «O» dans l'exemple ci-dessous, il semble que la décoration en position 1 soit plus éloignée de l'atome que celle en position 4 :
\exemple{Directions obliques}/\huge
\Lewis{1|4|,O}/
Or, il n'en en rien comme on peut le voir en traçant la boîte englobante de l'atome :
\exemple{Illusion d'optique}/\huge
\fboxsep0pt
\def\printatom#1{\fbox{$\mathrm{#1}$}}
\Lewis{1|4|,O}/
\label{opt.lewis}L'impression de plus grand éloignement est dû au fait que les contours de la lettre «O» sont plus éloignés de ceux de la boîte englobante dans les coins, c'est-à-dire dans les directions impaires.

Pour rapprocher (ou éloigner) les décorations de lewis dans les directions impaires, les commandes \verb-\lewis- et \verb-\Lewis- admettent un argument optionnel qui contient un coefficient qui vient multiplier le décalage entre la boite englobante et la décoration de Lewis réglé avec la commande \idx\setlewis. Pour la lettre «O», il semble que la valeur 0.5 soit satisfaisante pour ce coefficient :
\exemple*{Argument optionnel de \string\lewis}/\huge
\Lewis{1|4|,O}\quad \Lewis[0.5]{1|4|,O}

\Lewis{0:3:,O}\quad  \Lewis[2]{0:5:,O}\quad  \Lewis[0]{0:5:,O}\quad  \Lewis[0.5]{0:5:,O}/
\label{setlewisdist}Enfin, la macro \idx{\setlewisdist} règle la distance entre les deux disques représentant une paire d'électrons. L'argument de cette macro doit être une distance valide pour \TeX, ou, s'il est vide spécifie à la valeur par défaut qui est 0.3em :
\exemple{Espacement des électrons}/\Lewis{1:3:5:7:,X}\qquad\Lewis{0:2:4:6:,X}\bigskip

\setlewisdist{0.2em}\Lewis{1:3:5:7:,X}\qquad\Lewis{0:2:4:6:,X}\bigskip

\setlewisdist{4pt}\Lewis{1:3:5:7:,X}\qquad\Lewis{0:2:4:6:,X}/

\subsection{Empilement de caractères}
Les macros\label{chemabove}\idx*{\chemabove}
\centerverb|\chemabove[<dim>]{<code>}{<matériel>}|
et\label{chembelow}\idx*{\chembelow}
\centerverb|\chembelow[<dim>]{<code>}{<matériel>}|
\smallskip

placent le \verb-<matériel>- respectivement au-dessus et au-dessous du \verb-<code>- à une distance verticale \verb-<dim>-, et cela sans changer la boîte englobante\idx*{boite englobante@boîte englobante} du \verb-<code>-. L'argument optionnel permet si on le souhaite, de spécifier cette dimension à chaque appel. Si l'argument optionnel n'est pas utilisé, une dimension par défaut sera prise : elle vaut 1.5pt mais peut être modifiée avec la macro \idx*{\setstacksep} :

\centerverb|\setstacksep{<dimension>}|

Ces commandes sont indépendantes de la macro \verb-\chemfig- et peuvent aussi bien être appelées à l'intérieur ou à l'extérieur de son argument.

On peut les utiliser notamment dans les cycles en prenant soin de mettre des accolades autour des lettres A, B, C et D pour éviter que \CF ne stoppe la lecture de l'atome sur ces lettres :
\exemple{Superposition dans les cycles}|\chemfig{*5(-\chembelow{A}{B}--\chemabove{C}{D}--)}|

Elles sont parfois utiles pour placer des pseudo exposants tenant lieu de charge\idx*{cycle!charge} qui ne changent pas la boîte englobante de l'atome, de façon à ce que les liaisons n'en soient pas trop éloignées :
\exemple{ion oxonium}*\chemfig{H-\chemabove{\lewis{5|7,O}}{\quad\scriptstyle+}(-[2]H)-H}*

Les commandes \idx{\Chemabove} et \idx{\Chembelow} fonctionnent de la même façon sauf que la boîte englobante \emph{tient compte} du \verb-<matériel>- placé au dessus ou au dessous.

\section{Utilisation de {\protect\ttfamily\protect\textbackslash chemfig} dans l'environnement \protect\ttfamily tikzpicture}
Il est possible d'appeler la commande \idx{\chemfig} à l'intérieur d'un environnement {\ttfamily\idx{tikzpicture}} :
\exemple{\textbackslash chemfig dans tikzpicture}|\begin{tikzpicture}[help lines/.style={thin,draw=black!50}]
\draw[help lines] (0,0) grid (4,4);
\draw(0,0) -- (2,1);
\draw(2,2) circle (0.5);
\node at (1,3) {\chemfig{A=B-[:30]C}};
\node[draw,red,anchor=base] at(3,2){\chemfig{X>[2,,,,blue]Y}};
\end{tikzpicture}|

\section{Au delà de la chimie}\label{style.noeuds}
Intrinsèquement, \CF est un outil pour tracer des graphes, et cet outil a été programmé pour qu'il soit adapté à la chimie. Dans une certaine mesure, il est possible de détourner \CF de son usage premier pour tracer des organigrammes ou autres schémas se ramenant à des graphes.

Chaque atome est contenu dans un nœud de \TIKZ. Par défaut, ces nœuds ont un «inner sep» et un «outer sep» égal à 0pt. Ils sont rectangulaires comme on l'a vu page~\pageref{longueur.liaison}. Ces valeurs par défaut peuvent être écrasées avec la macro \idx{\setnodestyle} dont l'argument est passé à \TIKZ et spécifie le style des nœuds contenant les atomes.

Dans cet exemple, on spécifie simplement «draw,inner sep=2pt» ce qui a pour effet de tracer le contour des nœuds et espacer de 2pt leur contour de leur contenu. On spécifie également \verb-\setbondoffset{0pt}-\idx{\setbondoffset} pour que les liaisons touchent les frontières des nœuds. L'espace interatome est allongé à 75pt. Enfin, la commande \idx{\printatom} est réduite à sa plus simple expression de façon à ne plus se placer en mode mathématique pour afficher les atomes et donc tenir compte des espaces :
\exemple*{Un organigramme}/\setnodestyle{draw,inner sep=2pt}
\setbondoffset{0pt}
\setatomsep{75pt}
\renewcommand\printatom[1]{#1}
\chemfig{Le chef-[6]Moi(-[4]Eux(-[6]Les autres)(-[7,2]Groupe 1))-Toi(-[:-120,0.5]Lui)(-[:-60,0.5]Elle)}/

Voici un autre organigramme où les nœuds sont circulaires et colorés en bleu cyan\idx*{\printatom} :
\exemple*{Schéma de famille}/\setnodestyle{draw,circle,fill=cyan,minimum size=25pt}
\setbondoffset{0pt}
\setatomsep{80pt}
\renewcommand\printatom[1]{\textsf{#1}}
\chemfig{Moi(-[:-50,1.2]Frère)(-[:-10]Frère(-[:15]Nièce)(-[:-35]Nièce))
(-[:-155,0.8]Sœur-[:-80]Neveu)(-[:95,1.25]Père(-[:-25,0.8]Oncle)(-[:-65,0.8]Tante))
(-[:135]Mère-[:-95,0.5]Oncle)}/

\section{Exemples commentés}\label{exemples.commentes}
Dans ce chapitre, plusieurs molécules seront dessinées en mettant en œuvre les méthodes précédemment exposées. Le but recherché ici est de montrer dans quel ordre logique peut se construire une molécule de façon à ce que l'utilisateur peu familier avec \CF acquière une méthode pour construire des molécules complexes. Pour l'y aider, les étapes de la construction seront montrées.

De plus, on mettra en évidence que plusieurs possibilités s'offrent à l'utilisateur pour un même résultat graphique, certaines intuitives et d'autres beaucoup moins, l'essentiel étant de montrer que \CF permet une certaine souplesse dans le codage des molécules. À chacun ensuite de se construire et s'approprier les méthodes avec lesquelles il est le plus à l'aise.

\subsection{L'éthanal}
On va ici dessiner la molécule d'éthanal : \chemfig{H-C(-[2]H)(-[6]H)-C(-[7]H)=[1]O}

La meilleure méthode pour les molécules non cycliques est de choisir la plus longue chaîne. Ici on peut prendre «\verb|H-C-C=O|» par exemple. Il faut incliner la liaison \verb|C=O| de 45\degres{} en utilisant l'angle prédéfini «\verb-[1]-». On obtient la «structure» de la molécule sur laquelle il suffira de rajouter les ramifications\idx*{liaison!angle!prédéfini} :
\exemple{Structure de l'éthanal}|\chemfig{H-C-C=[1]O}|

Il reste à placer 3 atomes d'hydrogène avec les bonnes inclinaisons à l'aide des angles prédéfinis. Le premier à 90\degres{} avec la ramification\idx*{liaison!ramification} «\verb/(-[1]H)/», le second à 270\degres{} avec «\verb/(-[6]H)/» et celui de droite à 315\degres{} avec «\verb/(-[7]H)/» :
\exemple{Ethanal}|\chemfig{H-C(-[2]H)(-[6]H)-C(-[7]H)=[1]O}|

\subsection{L'acide 2-amino-4-oxohexanoïque}
Voici la molécule à dessiner : \chemfig{-[::+30]-[::-60](=[:-90]O)-[::+60]-[::-60](-[:-90]NH_2)-[::+60](=[:90]O)-[::-60]OH}

Il existe ---~comme c'est le souvent cas pour la plupart des molécules~--- plusieurs méthodes, et pour chacune, plusieurs façons différentes d'arriver au résultat. Ici, nous allons examiner 4 méthodes différentes.

\subsubsection{Angles absolus}
\idx*{liaison!angle!absolu}On va tout d'abord tracer la chaîne médiane avec des angles absolus. On règle l'angle par défaut à $+30\degres$ avec l'argument optionnel\idx*{chemfig@\protect\texttt{\protect\string\protect\chemfig}!arguments optionnels}, ainsi seules les liaisons «descendantes» auront besoin que l'on spécifie leur angle absolu de $-30\degres$ :
\exemple{Structure (angles absolus)}|\chemfig{[:30]--[:-30]--[:-30]--[:-30]OH}|

Il reste à ajouter les ramifications\idx*{liaison!ramification} «\verb/(=[6]O)/», «\verb/(-[6]NH_2)/» et «\verb/(=[2]O)/» sur les bons sommets :
\exemple{Molécule (angles absolus)}|\chemfig{[:30]--[:-30](=[6]O)--[:-30](-[6]NH_2)-(=[2]O)-[:-30]OH}|

\subsubsection{Angles relatifs}
\idx*{liaison!angle!relatif}Une approche plus générale aurait été de n'utiliser que des angles relatifs. Il aurait fallu procéder de cette façon :
\exemple{Structure (angles relatifs)}|\chemfig{[:30]--[::-60]--[::-60]--[::-60]OH}|

puis
\exemple{Molécule (angles relatifs)}|\chemfig{[:30]--[::-60](=[::-60]O)--[::-60](-[::-60]NH_2)
-(=[::60]O)-[::-60]OH}|

\subsubsection{Cycle}
Les angles entre les liaisons étant de 120\degres{}, on peut penser à utiliser un 6-cycle, quoique cette méthode soit moins naturelle. Il faut ici profiter du fait qu'un cycle peut être incomplet\idx*{cycle!incomplet}. Il est également nécessaire de faire pivoter le cycle de 120\degres{} pour que le premier sommet soit au sud-est du cycle :
\exemple{Structure}|\chemfig{[:120]NH_2*6(---=O)}|

\idx*{cycle!ramification}Il faut maintenant faire partir les ramifications des sommets adéquats :
\exemple{Molécule (cycle)}|\chemfig{[:120]NH_2*6(-(-(=[::60]O)-[::-60]OH)--(--[::60])=O)}|

\subsubsection{Cycles imbriqués}
\idx*{cycle!imbrication}En approfondissant la méthode avec les cycles, on peut aussi penser à imbriquer des 6-cycles incomplets. On pourrait partir de cette structure :
\exemple{Structure}|\chemfig{*6(--*6(--=O))}|

Et ensuite ajouter les liaisons qui partent des sommets des ces cycles. Il n'y a pas à se préoccuper des angles puisque les liaisons qui partent des cycles sont les bissectrices des côtés du cycle, ce que justement, on cherche ici :
\exemple{Molécule (cycles imbriqués)}|\chemfig{*6((-)-(=O)-*6(-(-NH_2)-(-OH)=O))}|

Un examen attentif révèle cependant que la seconde double liaison vers l'atome d'oxygène se trouve \emph{à l'intérieur} du 6-cycle incomplet\footnote{C'était aussi le cas pour la méthode précédente avec un seul cycle.}. Malgré sa concision, ce code ne conduit donc pas à un dessin parfait. On peut bien sûr corriger ce défaut en allongeant un peu le code :
\exemple{Molécule (cycles imbriqués corrigés)}|\chemfig{*6((-)-(=O)-*6(-(-NH_2)-(-OH)(=[::60]O)))}|

\subsection{Glucose}
Le but ici est de représenter selon différentes conventions la molécule de glucose.

\subsubsection{Formule topologique}
\idx*{formule topologique}Le code ressemble ici à celui de l'acide 2-amino-4-oxohexanoïque. On obtient quasiment la même structure avec des angles absolus sauf qu'ici, l'angle par défaut est de $-30\degres$ :
\exemple[60]{Structure}|\chemfig{[:-30]HO--[:30]--[:30]--[:30]-H}|

Et l'ajout des ramifications ne pose pas de problème particulier. On utilise des angles absolus :
\exemple[60]{Fructose, formule topologique}|\chemfig{[:-30]HO--[:30](<[2]OH)-(<:[6]OH)
-[:30](<:[2]OH)-(<:[6]OH)-[:30](=[2]O)-H}|

\subsubsection{Projection de Fisher}
\idx*{projection de Fisher}Le but est d'obtenir la molécule ci dessous :
\begin{center}
	\definesubmol{x}{(-[4]H)(-[0]OH)}
	\definesubmol{y}{(-[0]H)(-[4]OH)}
	\chemfig{[2]OH-[3]-!x-!x-!y-!x-=[1]O}
\end{center}
L'idée est de commencer à dessiner la plus longue chaîne verticale en indiquant un angle «\verb-[2]-» par défaut. Voici la structure où l'on met volontairement des lettres minuscules au bout de chaque liaison verticale :
\exemple{Structure}|\chemfig{[2]OH-[3]-a-b-c-d-=[1]O}|

Ensuite, on définit deux alias pour les liaisons horizontales et les atomes qui les termineront. Prenons «\verb-x-» que nous mettrons à la place des minuscules a, c et d et «\verb-y-» qui prendra la place de la lettre c. Comme les alias ne comportent qu'un seul caractère, on peut se passer d'accolade et écrire «\verb-!x-» au lieu de «\verb-!{x}-»\idx*{\definesubmol} :
\exemple{Glucose (projection de Fisher)}|\definesubmol{x}{(-[4]H)(-[0]OH)}
\definesubmol{y}{(-[0]H)(-[4]OH)}
\chemfig{[2]OH-[3]-!x-!x-!y-!x-=[1]O}|

\subsubsection{Représentation "chaise"}
\idx*{representation chaise@représentation chaise}On va représenter cette molécule d'$\alpha$-D-glucose :
\chemfig{?(-[:190]OH)-[:-50](-[:170]OH)-[:10](-[:-55,0.7]OH)-[:-10](-[6,0.7]OH)-[:130]O-[:190]?(-[:150,0.7]-[2,0.7]OH)}

Pour cela, on va tout d'abord tracer 5 côtés de la chaise et relier le premier sommet au dernier avec un crochet «\verb-?-». On adopte les angles absolus suivants, donnés dans l'ordre de parcourt trigonométrique : $-50\degres$, $10\degres$, $-10\degres$, $130\degres$, $190\degres$.
\exemple{Structure}|
\chemfig{?-[:-50]-[:10]-[:-10]-[:130]O-[:190]?}|

Maintenant, il suffit de rajouter les ramifications entre parenthèses. Les angles sont choisis au mieux pour rendre une impression de perspective, et certaines liaisons sont raccourcis d'un coefficient de 0,7 :
\exemple{Représentation chaise}|\chemfig{?(-[:190]OH)-[:-50](-[:170]OH)-[:10](-[:-55,0.7]OH)
-[:-10](-[6,0.7]OH)-[:130]O-[:190]?(-[:150,0.7]-[2,0.7]OH)}|

\subsubsection{Projection de Haworth}
\idx*{projection de Haworth}Le but est de représenter cette molécule de D-glucopyranose :
{\setcrambond{2pt}{}{}
\chemfig{HO-[2,0.5,2]?<[7,0.7](-[2,0.5]OH)-[,,,,line width=2pt](-[6,0.5]OH)>[1,0.7](-[6,0.5]OH)-[3,0.7]O-[4]?(-[2,0.3]-[3,0.5]OH)}}

Tout d'abord, on va choisir la plus longue chaîne qui part du groupe «HO» de gauche et continue sur 5 côtés du cycle. Le cycle sera fermé avec un crochet. Pour la liaison verticale qui part du premier groupe «HO», il faut spécifier qu'elle doit partir du second atome avec l'argument optionnel. De plus, elle sera raccourcie avec un coefficient de 0,5. Son argument optionnel\idx*{chemfig@\protect\texttt{\protect\string\protect\chemfig}!arguments optionnels} sera donc «\verb/[2,0.5,2]/».

Ensuite, pour donner une impression de perspective au cycle, les liaisons inclinées seront réduites d'un coefficient de 0,7. Pour les traits gras inclinés, on va se servir des liaisons de Cram en ayant redéfini la largeur de la base des triangles à 2pt. Pour la liaison horizontale en trait gras, il faudra la tracer  avec une épaisseur de 2pt et son argument optionnel sera donc «\verb/[0,,,,line width=2pt]/». Voici la structure de la molécule\idx*{\setcrambond} :
\exemple{Structure}|\setcrambond{2pt}{}{}
\chemfig{HO-[2,0.5,2]?<[7,0.7]-[,,,,
line width=2pt]>[1,0.7]-[3,0.7]O-[4]?}|

Il ne reste plus qu'à rajouter les ramifications, mises au bon endroit, en spécifiant des angles absolus correctement choisis et des longueurs parfois réduites pour mieux donner l'illusion de la perspective\idx*{\setcrambond} :
\exemple{Projection de Haworth}|\setcrambond{2pt}{}{}
\chemfig{HO-[2,0.5,2]?<[7,0.7](-[2,0.5]OH)-[,,,,
line width=2pt](-[6,0.5]OH)>[1,0.7](-[6,0.5]OH)-[3,0.7]
O-[4]?(-[2,0.3]-[3,0.5]OH)}|

\subsection{Adrénaline}
On cherche à dessiner la molécule d'adrénaline :
\chemfig{*6((-HO)-=-(-(<[::60]OH)-[::-60]-[::-60,,,2]HN-[::+60]CH_3)=-(-HO)=)}

Nous allons utiliser deux méthodes différentes.

\subsubsection{Utilisation d'un cycle}
Tout d'abord, on part du 6-cycle et nous dessinons le début des ramifications\idx*{cycle!ramification} qui en partent :
\exemple[60]{Structure de l'adrénaline}|\chemfig{*6((-HO)-=-(-)=-(-HO)=)}|

Il faut maintenant compléter la ramification de droite en utilisant, par exemple, des angles relatifs :
\exemple[60]{Adrénaline, étape 2}|\chemfig{*6((-HO)-=-(--[::-60]-[::-60]
HN-[::+60]CH_3)=-(-HO)=)}|

Puis, il faut rajouter la liaison de Cram vers \verb-OH- et spécifier que la liaison qui arrive sur «\verb-NH-» le fait sur le second atome «N». Nous utilisons le 4\ieme{} argument optionnel\idx*{chemfig@\protect\texttt{\protect\string\protect\chemfig}!arguments optionnels} de la liaison :
\exemple[60]{Adrénaline}|\chemfig{*6((-HO)-=-(-(<[::60]OH)-[::-60]-[::-60,,,2]
HN-[::+60]CH_3)=-(-HO)=)}|

\subsubsection{Utilisation de 2 cycles}
Cette méthode est moins naturelle, mais le but est ici d'expliquer comment rendre une liaison invisible\idx*{liaison!invisible}.

On pourrait améliorer ce code en considérant que le dessin de la molécule d'adrénaline est constitué de deux 6-cycles accolés\idx*{cycle!imbrication} l'un à l'autre :
\exemple[60]{Adrénaline, structure 2 cycles}|\chemfig{*6((-HO)-=*6(--HN---)-=-(-HO)=)}|

Il faut donc rendre invisible les deux premières liaisons du cycle de droite. Pour cela, on se sert de l'argument qui est passé à \TIKZ en spécifiant «\verb-draw=none-». Ces liaisons ont donc ce code : «\verb/-[,,,,,draw=none]/». Pour que le code reste lisible, on définit un alias nommé «\verb-&-» pour ces liaisons\idx*{\definesubmol} :
\exemple[60]{Adrénaline, étape 2}|\definesubmol{&}{-[,,,,draw=none]}
\chemfig{*6((-HO)-=*6(!&!&HN---)-=-(-HO)=)}|

Le reste devient facile, il suffit d'ajouter les ramification aux bons sommets\idx*{\definesubmol} :
\exemple[60]{Adrénaline, étape 3}|\definesubmol{&}{-[,,,,draw=none]}
\chemfig{*6((-HO)-=*6(!&!&HN(-CH_3)--(<OH)-)-=-(-HO)=)}|

Pour finir, on spécifie que les liaisons qui \emph{arrivent et partent} de «\verb-HN-» doivent le faire sur deuxième atome. On définit donc un autre alias pour la liaison invisible qui arrive sur «\verb-HN-»\idx*{\definesubmol} :
\exemple[60]{Adrénaline}|\definesubmol{&}{-[,,,,draw=none]}
\definesubmol{&&}{-[,,,2,draw=none]}
\chemfig{*6((-HO)-=*6(!&!{&&}HN(-CH_3)-[,,2]-(<OH)-)-=-(-HO)=)}|

\subsection{Guanine}
Nous allons dessiner la molécule de guanine :
\chemfig{*6((-H_2N)=N-*6(-\chembelow{N}{H}-=N?)=?-(=O)-HN-[,,2])}\medskip

Tout d'abord, commençons par dessiner les cycles imbriqués\idx*{cycle!imbrication} en mettant seulement les atomes d'azote aux sommets :
\exemple{Guanine, structure}|\chemfig{*6(=N-*6(-N-=N)=--N-)}|

Puis nous allons tracer la liaison horizontale dans le cycle de droite avec un crochet. Nous allons aussi positionner un atome d'hydrogène sous l'atome d'azote du 5-cycle avec la commande \verb-\chembelow{N}{H}-. Il faut aussi écrire «\verb-HN-» au lieu de «\verb-N-» au sommet en haut à gauche de la molécule\idx*{\chembelow} :
\exemple{Guanine, étape 2}|\chemfig{*6(=N-*6(-\chembelow{N}{H}-=N?)=?--HN-)}|

On constate qu'une liaison part du mauvais atome\footnote{Ceci semble illogique puisque l'angle de la liaison du groupe \texttt{HN} vers le premier sommet du 6-cycle est comprise entre $-90\degres$ et $90\degres$; \CF devrait donc partir du 2\ieme{} atome. Pour expliquer cette contradiction, il faut savoir que dans les cycles, la dernière liaison relie toujours le dernier sommet au premier sommet en ignorant l'angle \emph{calculé théorique} de cette liaison (qui est ici de $-90\degres{}$). \CF utilise cet angle théorique pour déterminer les atomes de départ et d'arrivée, mais ne s'en sert pas pour tracer la liaison puisque les deux extrémités sont déjà définies. L'atome de départ de la dernière liaison est donc le \no1.} ! Il faut corriger le mécanisme de calcul automatique pour que la liaison parte du 2\ieme{} atome «\verb-N-» au lieu du premier. Pour cela, on spécifie un argument optionnel pour la dernière liaison du premier 6-cycle «\verb-[,,2]-» :
\exemple{Guanine, étape 3}|\chemfig{*6(=N-*6(-\chembelow{N}{H}-=N?)=?--HN-[,,2])}|

Il suffit de rajouter les ramifications aux bons sommets. On peut notamment remarquer la ramification qui part du premier sommet du premier 6-cycle «\verb/(-H_2N)/» :
\exemple{Guanine}|\chemfig{*6((-H_2N)=N-*6(-\chembelow{N}{H}-=N?)=?-(=O)-HN-[,,2])}|

On aurait aussi pu dessiner cette même molécule avec un 5-cycle \emph{régulier}, comme cela se fait parfois :
\exemple{Guanine avec 5-cycle}|\chemfig{*6((-H_2N)=N-*5(-\chembelow{N}{H}-=N-)=-(=O)-HN-[,,2])}|

\section{Comment faire\protect\ldots}
\subsection{Écrire un atome en couleur}
\idx*{couleur (atome)}Comme le package \verb-xcolor- est chargé par \TIKZ, lui même chargé par \CF, on peut donc mettre dans le code d'une molécule des instructions de couleur, principalement \idx{\color} et \idx{\textcolor}. Les atomes étant affichés dans des nœuds de \TIKZ qui se comportent comme des boîtes de \TeX{}, tout se passe comme si ces atomes étaient confinés dans un groupe ce qui fait que le changement de couleur reste local à l'atome.

\exemple{Couleurs}/\chemfig{C\color{blue}H_3-C(=[1]O)-[7]O\color{red}H}/

On constate que ce code ne fonctionne pas, toujours à cause de la règle de \idx*{decoupage en atomes@découpage en atomes} qu'utilise \CF : ici, le premier atome de la molécule commence à «\verb-C-» et s'étend jusqu'à la prochaine lettre majuscule. Cet atome est donc «\verb-C\color{blue}-» et donc, le changement de couleur se fait en fin d'atome et reste sans effet. Il faut forcer \CF à couper le premier atome juste après «\verb-C-» avec le caractère «\verb-|-» et ensuite, englober \verb-\color{blue}H_3- entre accolades de façons à ce que \CF ne stoppe pas l'atome \no2 avant le «\verb-H-» ce qui laisserait le changement de couleur seul et donc inefficace dans un atome :

\exemple{Couleurs}/\chemfig{C|{\color{blue}H_3}-C(=[1]O)-[7]O|{\color{red}H}}/

On peut obtenir le même effet avec \verb-\textcolor- :

\exemple{Couleurs}/\chemfig{C|\textcolor{blue}{H_3}-C(=[1]O)-[7]O|\textcolor{red}{H}}/

Le principal inconvénient est qu'il faut répéter l'opération pour chaque atome que l'on veut colorer, même si ceux-ci sont contigus.

\subsection{Ajouter un exposant sans influer sur une liaison}
Ajouter une \idx{charge} sous forme d'exposant mathématique à un atome implique que la boîte (et donc le nœud de \TIKZ) le contenant aura ses dimensions modifiées. Cela n'a guerre d'importance si l'atome est un fin de chaîne mais l'esthétique peut être compromise si une liaison doit en partir. Le premier réflexe est de mettre l'exposant dans une boîte de \TeX{} de dimensions nulles et donc d'utiliser la macro\idx\rlap\footnote{Si l'on doit mettre la charge a gauche de l'atome, il faut employer la commande \texttt{\string\llap}.}, ce qui donne des résultats souvent satisfaisants. On voit ici que grâce à \idx\rlap, l'\idx{alignement horizontal} des atomes est préservé :
\exemple{Charge et liaison}/\chemfig{A^+-[2]B}
\qquad
\chemfig{A\rlap{${}^+$}-[2]B}/
Si l'on veut utiliser la commande \verb-\oplus- qui affiche «$\oplus$»\idx*{charge!\protect\texttt{\protect\string\protect\oplus}}, on peut trouver que la charge est trop basse : $\mathrm{A^\oplus}$. Dans ce cas, pourquoi ne pas se servir de \idx{\chemabove} pour placer aussi précisément que l'on veut, aussi bien verticalement qu'horizontalement la charge :
\exemple{Charge et \string\chemabove}/\chemfig{\chemabove[0.5pt]{A}{\scriptstyle\hspace{3.5mm}\oplus}-[2]B}
\qquad
\chemfig{{\chemabove[-0.5pt]{A}{\scriptstyle\hspace{3.5mm}\oplus}}-[2]B}/
On remarque un niveau d'accolades supplémentaire pour la seconde molécule. En effet, comme on spécifie «\verb/-0.5pt/» pour l'argument optionnel de \idx{\chemabove} pour descendre la charge, il faut éviter que \CF ne comprenne ce signe «\verb/-/» comme une liaison simple.

Pour ajouter une charge près du sommet d'un cycle\idx*{charge}, la meilleure méthode est de créer une liaison invisible\idx*{liaison!invisible} qui parte de ce sommet, ce qu'on fait ici avec \idx\definesubmol{} avec une liaison ayant un coefficient de longueur égal à 0.2 :
\exemple{Charges et cycles}/\definesubmol\nobond{-[,0.2,,,draw=none]}
\chemfig{*5(---(!\nobond\scriptstyle\oplus)-(!\nobond\scriptstyle{-})-)}/

\subsection{Dessiner une liaison courbe}
Nous avons déjà vu qu'avec la librairie «\verb-decorations.pathmorphing-» de \TIKZ, on peut dessiner une liaison ondulée\idx*{liaison!courbe} :

\exemple{Liaison ondulée}|\chemfig{A-[,3,,,decorate,decoration=snake]B}

\chemfig{A-[,3,,,decorate,decoration={snake,amplitude=1.5mm,
    segment length=2.5mm}]B}|

Pour plus de souplesse, on peut aussi poser des nœuds avec le marqueur «\verb-@-»\idx*{"@} et réutiliser ces nœuds après que la molécule ait été tracée pour les relier avec une ligne courbe à l'aide de \idx{\chemmove} :

\exemple{Liaisons courbes}/\chemfig{@{a}A-[,,,,draw=none]@{b}B}
\chemmove{\draw[-](a)..controls +(45:7mm) and +(225:7mm)..(b);}
\bigskip

\chemfig{*6(@{a}---@{b}---)}
\chemmove{\draw[-](a)..controls +(60:3em) and +(240:3em)..(b);}
\quad
\chemfig{*6(@{a}---@{b}---)}
\chemmove{\draw[-](a)..controls +(60:3em) and +(30:1em)..
    ++(20:2em) ..controls +(210:3em) and +(-120:4em) ..(b);}/

\subsection{Modifier la taille d'une molécule}
\idx*{taille des molécules@taille des molecules}Deux paramètres déterminent par défaut la taille d'une molécule : la taille de la police et le paramètre de \idx{\setatomsep} qui est de 3em par défaut. On peut jouer indépendamment sur ces deux paramètres pour modifier la taille d'une molécule :

\exemple{Modification de la taille}/\definesubmol\hho{H-[:30]O-[:-30]H}
\chemfig{!\hho}

\setatomsep{2.5em}\chemfig{!\hho}

\scriptsize\chemfig{!\hho}

\tiny\chemfig{!\hho}\setatomsep{5em}\chemfig{!\hho}/

Il est possible d'utiliser le second argument optionnel de \verb-\chemfig-\idx*{chemfig@\protect\texttt{\protect\string\protect\chemfig}!arguments optionnels} pour agrandir ou réduire une molécule, et ceci globalement, c'est-à-dire que le texte et les liaisons seront réduits selon la même proportion :

\exemple{Modification globale de la taille}/\definesubmol\hho{H-[:30]O-[:-30]H}
\chemfig{!\hho}

\chemfig[][scale=0.75]{!\hho}

\chemfig[][scale=0.5]{!\hho}

\chemfig[][scale=0.33]{!\hho}/

\subsection{Dessiner un élément de polymère}
\idx*{polymère}La difficulté réside dans le fait d'afficher des délimiteurs (parenthèses ou crochets) sur des liaisons. Pour cela, on va encore définir avec le caractère «\verb-@-»\idx*{"@} des nœuds globaux que l'on utilisera ensuite pour qu'ils servent d'ancre aux délimiteurs.

Nous allons écrire une macro toute simple \verb-\setpolymerbracket- dont les deux caractères qui suivent définissent le délimiteur ouvrant et le délimiteur fermant.

Ensuite, la macro \verb-\makebraces- admettra un argument de la forme«\verb-[<dim up>,<dim down>]-». Ces deux dimensions seront la hauteur et la profondeur des délimiteurs par rapport à la ligne de base. Les arguments suivants seront l'indice placé après le délimiteur fermant puis les noms des 2 nœuds où doivent être placés les délimiteurs ouvrants et fermants.

\exemple*{Polymères}|\newcommand\setpolymerdelim[2]{\def\delimleft{#1}\def\delimright{#2}}
\def\makebraces[#1,#2]#3#4#5{%
	\edef\delimhalfdim{\the\dimexpr(#1+#2)/2}%
	\edef\delimvshift{\the\dimexpr(#1-#2)/2}%
	\chemmove{%
		\node[at=(#4),yshift=(\delimvshift)]
			{$\left\delimleft\vrule height\delimhalfdim depth\delimhalfdim
			width0pt\right.$};%
		\node[at=(#5),yshift=(\delimvshift)]
			{$\left.\vrule height\delimhalfdim depth\delimhalfdim
			width0pt\right\delimright_{\rlap{$\scriptstyle#3$}}$};}}
\setpolymerdelim()
Polyéthylène:
\chemfig{\vphantom{CH_2}-[@{op,.75}]CH_2-CH_2-[@{cl,0.25}]}
\makebraces[5pt,5pt]{\!\!n}{op}{cl}
\bigskip

Polyvinyl chloride:
\chemfig{\vphantom{CH_2}-[@{op,.75}]CH_2-CH(-[6]Cl)-[@{cl,0.25}]}
\makebraces[5pt,25pt]{\!\!\!n}{op}{cl}
\bigskip

Nylon 6:
\chemfig{\phantom{N}-[@{op,.75}]{N}(-[2]H)-C(=[2]O)-{(}CH_2{)_5}-[@{cl,0.25}]}
\makebraces[30pt,5pt]{}{op}{cl}
\bigskip

Polycaprolactame:\setatomsep{2em}
\chemfig{[:-30]-[@{left,.75}]N(-[6]H)-[:30](=[2]O)--[:30]--[:30]--[@{right,0.25}:30]}
\makebraces[5pt,25pt]{\!\!\!n}{left}{right}
\bigskip

\setpolymerdelim[]
Polyphénylène sulfide:
\chemfig{\vphantom{S}-[@{op,.75}]S-(**6(---(-[@{cl,0.25}])---))}
\makebraces[15pt,15pt]{}{op}{cl}
\bigskip

\chemfig{-CH_2-CH([6]-CO-NH-CH_2-NH-CO-CH([4]-CH_2-)([0]-[@{downleft,0.8},2]CH_2
-CH([2]-CO-NH_2)-[@{downright,0.3},2]CH_2-[,1.5]C?H-))-[@{upleft,0.8},2]CH_2
-CH([6]-CO-NH_2)-[@{upright,0.3},2]CH_2-[,1.5]CH([6]-CO-NH-CH_2-NH-C?O)-}
\makebraces[5pt,40pt]{n}{upleft}{upright}
\makebraces[38pt,7pt]{n}{downleft}{downright}|

\subsection{Dessiner le symétrique d'une molécule}\label{retournement}
\idx*{symetrique d'une molecule@symétrique d'une molécule}Il existe deux commandes \idx{\hflipnext} et \idx{\vflipnext} qui permettent de tracer le symétrique de la prochaine molécule par rapport à un axe horizontal ou vertical. Si on souhaite construire le symétrique de plusieurs molécules, il faut écrire les commandes avant chaque molécule concernée.

\exemple{Symétriques}/\chemfig{H_3C-C(=[:30]O)-[:-30]OH}% original

\vflipnext% dessine le symétrique vertical de :
\chemfig{H_3C-C(=[:30]O)-[:-30]OH}\medskip

\chemfig{H_3C-C(=[:30]O)-[:-30]OH}% original
\hflipnext% dessine le symétrique horizontal de :
\chemfig{H_3C-C(=[:30]O)-[:-30]OH}/

\subsection{Ajouter du texte au dessus des liaisons et coder les angles}
\idx*{liaison!avec texte}Une fois que l'on a compris que le caractère «\verb-@-»\idx*{"@} permet de poser un nœud «global» pour \TIKZ, c'est-à-dire accessible après que la molécule ait été dessinée, tout ce qui est possible avec \TIKZ et les nœuds (c'est-à-dire beaucoup de choses) devient envisageable.

Pour écrire quelque chose au-dessus ou au-dessous d'une liaison, on peut donc poser des nœuds «globaux» sur les atomes situés aux extrémités de cette liaison et écrire à mi-chemin de ces deux nœuds un texte que l'on aura soin d'élever ou d'abaisser pour qu'il se situe juste au dessus ou au dessous de la liaison. C'est ce que fait la commande \verb-\bondname- dans le code ci-dessous\footnote{La commande \texttt{\string\si} est fournie par le package \href{http://www.ctan.org/tex-archive/help/Catalogue/entries/siunitx.html}{\texttt{\textbf{siunitx}}}.}.

\idx*{liaison!angle!codage}Pour les angles entre deux liaisons partant d'un atome, 3 atomes sont impliqués et il faudra poser un nœud global sur chacun d'eux. On peut aisément calculer l'angle entre deux lignes issues d'un même nœud, c'est ce que fait la commande \verb-\arcbetweennodes-. Ensuite, la macro \verb-\arclabel- trace un arc de cercle entre deux liaisons et écrit un texte à côté de cet arc : l'argument optionnel de cette macro est le code passé à \TIKZ. L'argument \no2 est le rayon de l'arc tandis que les trois arguments suivants sont les noms des nœuds globaux entre lesquels doit être tracé l'arc, le nom du milieu devant être celui du sommet de l'angle. Enfin, le dernier argument est le texte à écrire.

\exemple*{Angles et texte sur les liaisons}|
\newcommand\namebond[4][5pt]{\chemmove{\path(#2)--(#3)node[midway,sloped,yshift=#1]{#4};}}

\newcommand\arcbetweennodes[3]{%
  \pgfmathanglebetweenpoints{\pgfpointanchor{#1}{center}}{\pgfpointanchor{#2}{center}}%
  \let#3\pgfmathresult}

\newcommand\arclabel[6][stealth-stealth,shorten <=1pt,shorten >=1pt]{%
  \chemmove{%
    \arcbetweennodes{#4}{#3}\anglestart \arcbetweennodes{#4}{#5}\angleend
    \draw[#1]([shift=(\anglestart:#2)]#4)arc(\anglestart:\angleend:#2);
    \pgfmathparse{(\anglestart+\angleend)/2}\let\anglestart\pgfmathresult
    \node[shift=(\anglestart:#2+1pt)#4,anchor=\anglestart+180,rotate=\anglestart+90,inner sep=0pt,
          outer sep=0pt]at(#4){#6};}}

\chemfig{@{a}A=[:30,1.5]@{b}B-[7,2]@{c}C-@{d}D}
\namebond{a}{b}{\scriptsize My text}
\namebond[-3.5pt]{b}{c}{\small\color{red}$\pi$}
\namebond{c}{d}{\small1\si\angstrom}
\medskip

Molécule d'eau horizontale : \chemfig{@{1}H-[::37.775,2]@{2}O-[::-75.55,2]@{3}H}.
\namebond{1}{2}{\footnotesize0.9584\si\angstrom}
\namebond{2}{3}{\footnotesize0.9584\si\angstrom}
\arclabel{0.5cm}{1}{2}{3}{\footnotesize104.45\si\degree}
\qquad
Molécule d'eau pivotée de +30\si\degree : \chemfig{[:30]@1H-[::37.775,2]@2O-[::-75.55,2]@3H}
\namebond12{\footnotesize0.9584\si\angstrom}
\namebond23{\footnotesize0.9584\si\angstrom}
\arclabel{0.5cm}{1}{2}{3}{\footnotesize104.45\si\degree}|

\subsection{Schéma de Lewis à l'angle près}
Pour quelques cas très particuliers, il est parfois nécessaire de positionner des schémas de Lewis au degrés près et non plus à des multiples de 45 degrés.

Pour cela, il est relativement facile d'écrire une macro \verb-\mylewis-, admettant un argument optionnel (la longueur du doublet) qui vaut ici 2ex et deux arguments obligatoires; le premier étant le nom de l'atome et le second étant la liste des angles séparés par des virgules.

L'astuce consiste à créer un n\oe ud invisible circulaire qui contient l'atome et tracer les doublets aux angles désirés de façon à ce qu'ils soient tangents à ce cercle :

\exemple*{Doublets au degrés prés}|\makeatletter
\newcommand\mylewis[3][2ex]{% #1=longueur, #2=atome #3=liste des angles
	\tikzpicture[baseline,anchor=base]%
		\node[inner sep=0pt,outer sep=1pt,circle,overlay](atom@@)at(0,0){\phantom{#2}};%
		\node[inner sep=0pt,outer sep=0pt]at(0,0){#2};%
		\def\list@angle{#3,}%
		\loop
			\expandafter\grab@angle\list@angle\@nil
			\pgfextractx\CF@dim{\pgfpointanchor{atom@@}\current@angle}\edef\CF@dimax{\the\CF@dim}%
			\pgfextracty\CF@dim{\pgfpointanchor{atom@@}\current@angle}\edef\CF@dimay{\the\CF@dim}%
			\pgfmathparse{#1*sin(\current@angle)/2}\let\offset@xx\pgfmathresult
			\pgfmathparse{#1*cos(\current@angle)/2}\let\offset@yy\pgfmathresult
			\draw[line width=.4pt,overlay]
			(\CF@dimax-\offset@xx,\CF@dimay+\offset@yy)--(\CF@dimax+\offset@xx,\CF@dimay-\offset@yy);%
			\unless\ifx\@empty\list@angle
		\repeat
	\endtikzpicture
}
\def\grab@angle#1,#2\@nil{\def\current@angle{#1}\def\list@angle{#2}}
\makeatother
Essai : \mylewis{Cl}{15}\qquad \mylewis[3ex]{Cl}{-60}\qquad \mylewis[1.5ex]{Cl}{60,120,240,300}
\bigskip

\chemfig{P(-[:72]\mylewis{Cl}{-18,72,162})(-[:-72]Cl)
(-[:144]Cl)(-[:-144]Cl)-\mylewis{Cl}{0,90,-90}}|

\subsection{Dessiner des liaisons multiples}
Là encore, la librairie «decorations.markings» permet de tracer des liaisons multiples :

\exemple*{Liaisons multiples}|\catcode`\@=11
\tikzset{nbond/.style args={#1}{%
	draw=none,%
	decoration={%
		markings,%
		mark=at position 0 with {\coordinate (CFstart@) at (0,0);},
		mark=at position 1 with {%
		\foreach\CF@i in{0,1,...,\number\numexpr#1-1}{%
			\pgfmathsetmacro\CF@nbondcoeff{\CF@i-0.5*(#1-1)}%
			\draw ([yshift=\CF@nbondcoeff\CF@double@sep]CFstart@)--(0,\CF@nbondcoeff\CF@double@sep);
			}%
		}
		},
	postaction={decorate}
	}
}
\catcode`\@=12
\chemfig{A-[1,,,,nbond=4]B-[:-30,,,,nbond=5]C-[6,,,,nbond=6]D}|

\part{Schémas réactionnels}\label{schemas}
\idx*{schéma réactionnel|(}Suite à plusieurs demandes d'utilisateurs et étant devenu évident que \CF présentait une faiblesse quant au tracé de schémas réactionnels, cette lacune est désormais comblée. Par conséquent, \CF passe en version 1.0 puisque je considère que les fonctionnalités principales que je souhaitais implémenter sont désormais disponibles.

Je remercie Clemens \textsc{Niederberger} pour l'aide qu'il m'a apportée et les tests qu'il a effectués sur les nouvelles fonctionnalités présentées dans cette partie.
\section{Généralités}\label{schemestart}
Un schéma réactionnel doit être contenu entre les commandes «\idx\schemestart» et «\idx\schemestop». Comme on le constate sur cet exemple, des \idx{informations de débogage} ont été masquées puis rendues visibles pour aider à la compréhension avec la commande «\idx\schemedebug» et l'argument «false» ou «true» :
\exemple[50]{Exemple 1}/\schemedebug{false}
\schemestart
  \chemfig{*6(-=-=-=)}\arrow
  \chemfig{X=[1]Y}\arrow
  \chemfig{S>T}
\schemestop
\bigskip

\schemedebug{true}
\schemestart
  \chemfig{*6(-=-=-=)}\arrow
  \chemfig{X=[1]Y}\arrow
  \chemfig{S>T}
\schemestop/

Quelques remarques :
\begin{itemize}
	\item les commandes \idx{\arrow} tracent les flèches;
	\item tout ce qui se trouve entre deux commande \idx{\arrow} est considéré comme étant un \idx{composé}. Le parti a été pris que tous les réglages possibles, qu'ils concernent les flèches ou les composés, le seront grâce aux arguments de la commande \idx{\arrow}, dont la syntaxe en devient assez complexe;
	\item les flèches sont tracées horizontalement, ce qui est bien évidemment modifiable;
	\item les flèches sont sur la ligne imaginaire reliant les centre des boîtes englobantes les composés (les points rouges et bleus sont les points d'attache des flèches). Ce comportement est également modifiable;
	\item Les informations de débogage, qui sont rendues visibles ou pas avec la commande \idx{\schemedebug} sont :
	\begin{itemize}
		\item ce qui se trouve en vert au dessus des boîtes englobantes est le nom attribué par défaut par \CF aux composés et suit la progression "c1", "c2", etc. La numérotation repart à 1 pour un nouveau schéma réactionnel.
		\item les boîtes englobantes des composés ont été tracées;
		\item les extrémités des flèches sont matérialisés par des points rouge et les ancres par des points bleu;
	\end{itemize}
	\item la distance de bord à bord entre deux composés est définie avec la commande \idx*\setcompoundsep\verb-\setcompoundsep{<dim>}-\label{setcompoundsep} où l'argument est une dimension valide au sens de \TeX{}. Par défaut, et si l'argument est vide, cette dimension vaut 5em;
	\item enfin, la distance entre les bords des composés et le début et la fin des flèches est défini avec la commande \idx*\setarrowoffset\verb-\setarrowoffset{<dim>}- où l'argument est une dimension valide au sens de \TeX{}. Par défaut, et si l'argument est vide, cette dimension vaut 4pt.\label{setarrowoffset}
\end{itemize}

\section{Types de flèches}\label{arrow}
Lorsque la commande \idx{\arrow} est suivie d'un argument optionnel entre accolades (qui n'est donc pas obligatoire), cet argument contient le type de flèche\idx*{flèche!type} :
\exemple[50]{Types de flèches}|\schemestart A\arrow{->}B\schemestop\par % par défaut
\schemestart A\arrow{-/>}B \schemestop\par
\schemestart A\arrow{<-}B \schemestop\par
\schemestart A\arrow{<->}B \schemestop\par
\schemestart A\arrow{<=>}B \schemestop\par
\schemestart A\arrow{<->>}B \schemestop\par
\schemestart A\arrow{<<->}B \schemestop\par
\schemestart A\arrow{0}B \schemestop\par
\schemestart A\arrow{-U>}B \schemestop|
La flèche «\verb/-U>/» n'est pas dessinée de façon complète, un arc de cercle qui lui est tangent en son milieu peut être rajouté avec les arguments optionnels passés à cette flèche, voir page~\pageref{fleche.arg.optionnel}. Voici une flèche «\verb/-U>/» avec son arc de cercle : \schemestart A\arrow{-U>[$\scriptstyle x$][$\scriptstyle y$]}B\schemestop

Par souci de concision, par la suite, sauf exemple spécial, des lettres majuscules seront mises au lieu de formules chimiques crées via la commande \idx\chemfig. Il est bien évident que les schémas réactionnels fonctionnent de façon identique avec des lettres ou des dessins de molécules. On peut voir dans la galerie plusieurs exemples où les schémas réactionnels entrent en jeu.

\section{Caractéristiques des flèches}
Chaque \idx{flèche} est caractérisée par :
\begin{itemize}
	\item \idx*{flèche!angle}un angle exprimé en degrés;
	\item \idx*{flèche!coefficient}un coefficient qui spécifie la longueur de la flèche par multiplication de la valeur de l'espacement entre composés\idx*{composé!espacement} défini par \idx\setcompoundsep;
	\item \idx*{flèche!style}un style qui contient des instructions \TIKZ qui vont permettre de personnaliser la couleur, l'épaisseur de la flèche ou un autre attribut graphique.
\end{itemize}

On peut définir ces caractéristiques à l'aide de la commande \idx\setarrowdefault\verb-{angle,coeff,style}-\label{setarrowdefault}, et ce, à \emph{l'extérieur} d'un schéma réactionnel. Si l'angle est vide, il prend la valeur 0 et si le coeff est est vide, il vaut 1. Les caractéristiques ainsi définies sont valables pour tout le reste du document, à partir du moment où l'instruction est rencontrée. Pour revenir aux valeurs par défaut, il suffit d'entrer un argument vide.
\exemple[50]{Définition de valeurs par défaut}/\schemestart A\arrow B\arrow C\schemestop

\setarrowdefault{15,1.5,red,thick}
\schemestart A\arrow B\arrow C\schemestop

\setarrowdefault{,2.5,dashed}
\schemestart A\arrow B\arrow C\schemestop

\setarrowdefault{}
\schemestart A\arrow B\arrow C\schemestop/

Pour modifier localement une, ou toutes ces valeurs par défaut, la commande \idx{\schemestart} admet un argument optionnel de la forme \verb-[angle,coeff,style]- qui change les caractéristiques par défaut à l'intérieur du schéma réactionnel concerné :
\exemple[50]{Argument optionnel}/\setarrowdefault{5,2.5,blue}
\schemestart A\arrow B\arrow C\schemestop

\schemestart[0] A\arrow B\arrow C\schemestop

\schemestart[0,1] A\arrow B\arrow C\schemestop

\schemestart[0,1,thick] A\arrow B\arrow C\schemestop

\schemestart[0,1,black] A\arrow B\arrow C\schemestop/
Pour le style\idx*{flèche!style}, la règle est la suivante : le style spécifié dans l'argument entre crochets s'applique \emph{après} le style par défaut, sans l'écraser ! C'est pour cette raison que seul l'attribut de couleur «black» parvient à écraser celui par défaut qui est «blue».

Enfin, la commande \idx{\arrow} admet un argument optionnel entre crochets de la forme \verb-[angle,coeff,style]- pour modifier les caractéristiques de la flèche concernée. Pour le style, comme précédemment, celui est-ci est appliqué \emph{après} le style par défaut et l'éventuel style spécifié dans l'argument optionnel de la commande \verb-\schemestart-, le tout sans écrasement.
\exemple[50]{Caractéristiques des flèches}/\schemestart
  A\arrow[45]B\arrow[-20,2]C
\schemestop
\bigskip

\schemestart
  A\arrow[90,,thick]B\arrow[,2]C
  \arrow[-45,,dashed,red]D
\schemestop/

\section{Nom des composés}
\idx*{composé!nom}On peut passer outre le mécanisme automatique qui nomme les composés «c1», «c2», etc. Pour cela, la commande \idx{\arrow} admet un argument entre parenthèses qui doit suivre immédiatement la commande. Cet argument est de la forme : \verb/(n1--n2)/. Il nomme «\verb-n1-» le \idx{composé} se trouvant à l'origine de la flèche et «\verb-n2-» celui se trouvant à sa fin. N'importe quelle chaîne de caractères alphanumériques peut être utilisée. La numérotation des noms "c<n>" continue en interne ce qui signifie que si un \idx{composé} porte un autre nom que celui par défaut, cela ne change pas le nom par défaut des composés suivants.

Les noms sont facultatifs et l'argument peut aussi bien être \verb/(n1--)/ que \verb/(--n2)/.

\exemple[50]{Nom des composés}/\schemedebug{true}
\schemestart
  A\arrow(aa--bb)B\arrow(--cc)C\arrow(--dd)D\arrow E
\schemestop
\bigskip

\schemestart
  A\arrow(aa--)B\arrow(bb--)C\arrow(cc--dd)D\arrow E
\schemestop/
On le voit, les deux méthodes sont équivalentes et l'on peut donc nommer un \idx{composé} avec la flèche qui le précède ou avec la flèche qui le suit. Par contre lorsqu'un \idx{composé} est entouré de deux flèches spécifiant son nom, le premier nom est ignoré et un warning est émis :
\exemple[50]{Noms surabondants}/\schemedebug{true}
\schemestart
  A\arrow(--foo)B\arrow(bar--)C
\schemestop/
Ici, le \idx{composé} «B» est nommé «foo» par la flèche qui lui arrive dessus et «bar» par celle qui en part. \CF émet donc le warning suivant annonçant que le nom "foo" sera ignoré :

\hfill\verb-Package chemfig Warning: two names for the same node, first name "foo" ignored-\hfill\null

\section{Ancres}
\idx*{composé!ancre}Comme on l'a vu, les flèches sont sur la ligne reliant les centre de boites englobant les composés. On peut spécifier un ancre autre que celui par défaut (qui, au sens de \idx*{tikz}\TIKZ, s'appelle «center»). On utilise pour cela l'argument entre parenthèses :

\hfill\verb/(n1.a1--n2.a2)/\hfill\null

où l'ancre »\verb-a1-« ou »\verb-a2-« peut être :  north west, north, north east, west, center, east, mid west, mid, mid east, base west, base, base east, south west, south, south east, text, ou n'importe quel angle. Voici un exemple du manuel de \TIKZ où les ancres sont placés sur la boîte englobante :
\exemple*{Ancres de tikz}|\Huge
\begin{tikzpicture}[baseline]
\node[anchor=base west,name=x,draw,inner sep=25pt] {\color{lightgray}Rectangle\vrule width 1pt height 2cm};
\foreach \anchor/\placement in
{north west/above left, north/above, north east/above right,west/left, center/above, east/right,
mid west/left, mid/above, mid east/right,base west/left, base/below, base east/right,
south west/below left, south/below, south east/below right,text/below,10/right,45/above,150/left}
\draw[shift=(x.\anchor)] plot[mark=x] coordinates{(0,0)}
node[\placement,inner sep=0pt,outer sep=2pt] {\scriptsize\texttt{(\anchor)}};
\end{tikzpicture}|
Comme les noms, les ancres de départ et de fin sont indépendants et facultatifs.

Voici un exemple où l'alignement\idx*{schéma réactionnel!alignement} par défaut n'est pas bon car les deux «A» ne sont pas alignés verticalement. Les \idx{informations de débogage} ont été rendues visibles pour constater que les ancres «center» par défaut ne conviennent pas :
\exemple[50]{Problèmes d'alignement}/\schemedebug{true}
\schemestart
  \chemfig{A*5(-----)}
  \arrow
  \chemfig{A*5(---(-)--)}
\schemestop/
Pour que l'alignement\idx*{schéma réactionnel!alignement} soit correct, on va faire partir/arriver la flèche soit des ancres «base east»/«base west», soit des ancres «mid east»/«mid west» :
\exemple[50]{Problèmes d'alignement}/\schemedebug{true}
\schemestart
  \chemfig{A*5(-----)}
  \arrow(.base east--.base west)
  \chemfig{A*5(---(-)--)}
\schemestop
\bigskip

\schemestart
  \chemfig{A*5(-----)}
  \arrow(foo.mid east--bar.mid west)
  \chemfig{A*5(---(-)--)}
\schemestop/

\idx*{composé!ancre}Un dernier ancre reste à spécifier, c'est celui du premier \idx{composé} par rapport à la \idx{ligne de base} du texte qui le précède, il s'agit du point vert de gauche sur le schéma qui suit :
\exemple[50]{Ancre initial}/\schemedebug{true}
Texte qui précède :
\schemestart
  \chemfig{A*5(-----)}\arrow A
\schemestop/

L'emplacement de cet ancre sur la boîte contenant le premier \idx{composé} vaut par défaut «text». Il est réglable avec le second argument optionnel de la commande \idx{\schemestart} :
\exemple[50]{Réglage de l'ancre initial}/\schemedebug{true}
Texte qui précède :
\schemestart[][south]
  \chemfig{A*5(-----)}\arrow A
\schemestop
\bigskip

Texte qui précède :
\schemestart[][north west]
  \chemfig{A*5(-----)}\arrow A
\schemestop
\bigskip

Texte qui précède :
\schemestart[][west]
  \chemfig{A*5(-----)}\arrow A
\schemestop/

\section{Style des composés}
\idx*{composé!style}Toujours par l'intermédiaire de l'argument entre parenthèses de la commande \idx{\arrow}, on peut spécifier avec des instructions de \TIKZ le style «\verb-s-» de la boîte englobante du \idx{composé} de départ ou de celui d'arrivée. La syntaxe complète de la commande \idx{\arrow} est donc la suivante, où chaque spécification est optionnelle et peut être omise :

\hfill\verb/\arrow(n1.a1[s1]--n2.a2[s2]){type flèche}[angle,coeff,style flèche]/\hfill\null

Tout comme les noms, si un style est spécifié à un composé par la flèche qui lui arrive dessus et par celle qui en part, le premier style sera ignoré avec un warning.

\exemple[60]{Style des composés}/\schemestart
  A
  \arrow([red]--[fill=blue,semitransparent,text opacity=1,
  inner sep=10pt,rounded corners=2mm])
  B
\schemestop
\bigskip

\schemestart
  A\arrow(--foo[yshift=5mm])B
\schemestop/
\label{setcompoundstyle}La macro \idx\setcompoundstyle\verb-{<code tikz>}- permet de définir de façon générale le style des composés\idx*{composé!style} affichés par la suite. Il faut bien évidemment entrer un argument vide pour qu'aucun style ne soit appliqué, ce qui est le cas par défaut.

Ici, nous allons définir un style en forme de boites aux coins arrondis, dont le fond sera semi transparent :
\exemple[50]{Styles globaux}/\setcompoundstyle{draw,line width=0.8pt,semitransparent,
text opacity=1,inner sep=8pt,rounded corners=1mm}
\schemestart
  A\arrow([fill=red]--[fill=blue])[90]
  B\arrow(--[fill=gray])
  C\arrow(--[fill=green])[-90]
  D\arrow(--[draw=none])[-180]
\schemestop/

\section{Embranchements}
\idx*{schéma réactionnel!embranchements}Jusqu'à présent, on n'a pu tracer que des schémas réactionnels linéaires. On peut également faire des embranchements et c'est là que le nom des composés va prendre toute son importance. Dans l'argument entre parenthèses de la commande \idx{\arrow}, si un nom est précédé de \og\verb-@-\fg, cela signifie que ce \idx{composé} existe déjà. Plusieurs cas de figure peuvent se présenter :
\begin{itemize}
	\item \verb/(@n1--n2)/ : la flèche sera tracée depuis le composé existant \og\verb-n1-\fg{} et le schéma continuera à la suite de cette flèche, créant donc un embranchement;
	\item \verb/(@n1--@n2)/ : la flèche est tracée entre deux composés existants, qu'ils soient déjà définis ou qu'ils soient définis plus tard dans le schéma réactionnel : cette syntaxe peut donc se placer \emph{n'importe où} dans le code du schéma réactionnel;
	\item \verb/(n1--@n2)/ : cette syntaxe n'est pas admise;
\end{itemize}

Voici un exemple où 3 embranchements sont créés, l'un partant de «B», l'autre de «D» et le dernier de «X». À la fin, une flèche est tracée entre 2 composés existants  \og XX\fg{} et \og D\fg{} :
\exemple[50]{Embranchements}/\schemestart
  A\arrow(aa--bb)B\arrow(--cc)C\arrow D
  \arrow(@bb--xx1)[-90]X\arrow[-90]Y% 1er embranchement
  \arrow(@c4--)[-90]Z\arrow W% 2è embranchement
  \arrow(@xx1--xx2)[-45]XX% 3è embranchement
  \arrow(@xx2--@c4)% flèche XX à D
\schemestop/

On pourrait vouloir que «Y» et «XX» soient sur une même horizontale. Pour cela, on va tracer une liaison invisible horizontale de «Y» à «XX» et finir le schéma par une flèche entre les deux composés existants «XX» et «D» :
\exemple[50]{Embranchements}/\schemestart
  A\arrow(aa--bb)B\arrow(--cc)C\arrow D
  \arrow(@bb--xx1)[-90]X\arrow[-90]Y\arrow(--xx2){0}XX
  \arrow(@c4--)[-90]Z\arrow W
  \arrow(@xx1--@xx2)% flèche de X à XX
  \arrow(@xx2--@c4)% flèche XX à D
\schemestop/

\section{Sous schéma}\label{subscheme}
\idx*{schéma réactionnel!sous schéma}On peut placer une partie d'un schéma réactionnel dans une boîte englobante unique, considérée par \CF comme un \idx{composé}. La commande \idx{\subscheme} dont l'argument obligatoire contient le sous schéma entre accolades permet de grouper un sous schéma comme un tout et lorsque \idx{\subscheme} se trouve après une flèche, la commande enveloppe ce sous schéma dans un \idx{composé} portant le nom «c<n+1>» :
\exemple[50]{Sous schéma}/\schemedebug{true}
\schemestart
  A\arrow
  \subscheme{B\arrow[-90,2]C}
  \arrow
  D
\schemestop/
Bien que ça ne soit pas clair car les noms se superposent, la boîte contenant le sous schéma porte le nom «c2» et la numérotation se poursuit à l'intérieur du sous schéma «c3» pour B, «c4» pour C. Comme le premier \idx{composé} du sous schéma est «B», la ligne de base du sous schéma est celle de «B». On peut le mettre en évidence en précisant les ancres\idx*{schéma réactionnel!sous schéma!ancre} :
\exemple[50]{Sous schéma}/\schemedebug{true}
\schemestart
  A\arrow(--.mid west)
  \subscheme{B\arrow[-90,2]C}
  \arrow
  D
\schemestop/
Il faut noter que la commande \idx\subscheme\verb-{<scheme>}- n'étant rien d'autre qu'un raccourci pratique pour
\begin{center}
\idx\schemestart\verb-<scheme>-\idx\schemestop
\end{center}
Par conséquent, \idx\subscheme{} admet les mêmes arguments optionnels que \idx\schemestart.

\idx*{schéma réactionnel!sous schéma!délimiteur|(}\label{chemleft}\CF fournit la paire de commandes \idx{\chemleft} et \idx{\chemright} qui permettent de placer des délimiteurs extensibles de part et d'autre d'un matériel. Ces commandes doivent être suivies de délimiteurs, tout comme on en mettrait à la suite des primitives de \TeX{} \verb-\left- et \verb-\right- :
\centerverb/\chemleft<car1><matériel>\chemright<car2>/
où \verb-<car1>- et \verb-<car2>- sont «(» et «)» ou «[» et «]» ou tout autre délimiteur extensible accepté par les commandes \verb-\left- et \verb-\right-.
\exemple{Les macros \string\chemleft\ et \string\chemright}/\chemleft\lfloor\chemfig{A-[1]B}\chemright)

\chemleft\{\chemfig{A-[1,1.25]B-[6,1.25]C}\chemright|

\chemleft[\chemfig{H-[1]O-[7]H}\chemright]/
Voici le code du schéma réactionnel vu précédemment où l'on utilise \idx{\chemleft} et \idx{\chemright} :
\exemple{Schéma réactionnel avec \string\chemleft\ et \string\chemright}/\schemestart
  A\arrow
  \chemleft[\subscheme{B\arrow[-90,2]C}\chemright]
  \arrow
  D
\schemestop/
\label{chemup}Dans le même ordre d'idée, les macros \idx{\chemup} et \idx{\chemdown} fonctionnent de la même façon sauf que les délimiteurs extensibles sont positionnés au dessus et au dessous du matériel :
\centerverb/\chemup<car1><matériel>\chemdown<car2>/
Voici un exemple :
\exemple{Les macros \string\chemup\ et \string\chemdown}/\schemestart[-90]
X\arrow
\chemup\{\chemfig{A-[1]B-[7]C}\chemdown\}
\arrow Y
\schemestop
\qquad
\schemestart[-90]
X\arrow
\chemup[\chemfig{A-[1]B-[7]C}\chemdown]
\arrow Y
\schemestop/

Avec les styles des composés, il est possible également possible de délimiter un composé quelconque (et donc un sous schéma) par des délimiteurs extensibles (parenthèses, crochets, accolades), ceci après avoir chargé la librairie de \TIKZ \og matrix\fg{} en mettant dans le préambule du document :

\hfill\verb-\usetikzlibrary{matrix}-\hfill\null

Comme les commandes \idx{\chemleft}, \idx{\chemright}, \idx{\chemup} et \idx{\chemdown} sont disponibles, l'extension \CF ne procède \emph{pas} à ce chargement, il appartient donc à l'utilisateur de le faire s'il souhaite avoir accès à ces délimiteurs.

Voici le sous schéma précédent délimité par des crochets :
\exemple[50]{les délimiteurs de la librairie «matrix»}/\schemestart
  A\arrow(--[left delimiter={[}, right delimiter={]}])
  \subscheme{B\arrow[-90,2]C}
  \arrow
  D
\schemestop/
Les délimiteurs étant tracés en dehors de la boîte englobante, il est souhaitable ici de raccourcir un peu les flèches arrivant et partant de ces délimiteurs :
\exemple[50]{Sous schéma}/\schemestart
  A\arrow(--[left delimiter={[},
  right delimiter={]}])[,,shorten >=6pt]
  \subscheme{B\arrow[-90,2]C}
  \arrow[,,shorten <=6pt]
  D
\schemestop/\idx*{schéma réactionnel!sous schéma!délimiteur|)}

Les sous schémas doivent être utilisés à bon escient et peuvent parfois donner des résultats non désirés. Voici un exemple où l'on se sert d'un sous schéma pour aligner horizontalement 3 composés :
\exemple[50]{Sous schéma}/\schemedebug{true}
\schemestart
  A
  \arrow{0}[-90]
  \subscheme{%
    tagada\arrow{}
    tsoin\arrow{}
    fin}
  \arrow(xx--yy){}E
  \arrow(@c1--@c3){}
  \arrow(@c1--@c5){}
  \arrow(@c1--@c4){}
\schemestop/
On constate que le centre du sous schéma est sur la même verticale que le centre du composé "A" puisqu'on a tracé une flèche invisible\idx*{flèche!invisible} avec un angle de $-90$. Par contre, la flèche entre deux composés existants \og A\fg{} et \og tsoin\fg{} n'est \emph{pas} verticale car \og tsoin\fg{} ne se trouve pas sous le centre du sous-schéma puisque "tagada" est plus large que "fin". Pour rendre cette flèche verticale, on ne peut pas s'en sortir avec un sous schéma, sauf à spécifier un angle trouvé en tâtonnant pour l'ancre d'arrivée de la flèche invisible.

Il sera beaucoup plus simple de procéder sans sous-schéma et en utilisant un embranchement : tracer une flèche \emph{visible} entre \og A\fg{} et \og tsoin\fg{}, puis partir de \og tsoin\fg{} pour tracer de part et d'autre des flèches horizontales, en créant un embranchement pour les flèches vers la droite.
\exemple[50]{Sous schéma}/\schemedebug{true}
\schemestart
  A
  \arrow(--tsoin){->}[-90]
  tsoin
  \arrow{<-}[180]
  tagada
  \arrow(@tsoin--fin){}
  fin
  \arrow{}
  E
  \arrow(@c1--@c3){}
  \arrow(@c1--@fin){}
\schemestop/

\section{Arguments optionnels des flèches}\label{fleche.arg.optionnel}
\idx*{flèche!argument optionnel}À l'intérieur de l'argument entre accolades de la commande \idx\arrow, le nom des flèches peut être suivi d'arguments optionnels placés entre crochets. Voici ces arguments optionnels et leur signification pour les flèches définies par \CF :
\begin{itemize}
	\item les flèches «\verb|->|», «\verb|<-|», «\verb|<->|», «\verb|<=>|», «\verb|<<->|»,«\verb|<->>|», «\verb|-/>|» ont trois arguments optionnels :
	\begin{itemize}
		\item le premier contient le «label» qui sera placé au dessus de la flèche\idx*{flèche!label};
		\item le second contient le «label» qui sera placé sous la flèche. Ces deux labels sont orientés selon le même angle que la flèche. On peut régler le décalage perpendiculaire\idx*{flèche!label!décalage} entre la flèche et l'ancre\idx*{flèche!label!ancre} des labels avec la commande \idx*\setarrowlabelsep\verb-\setarrowlabelsep{<dim>}-\label{setarrowlabelsep}, où l'argument est une dimension valide au sens de \TeX{}. Par défaut, ou si l'argument est vide, cette distance vaut 3pt. Les labels contenus dans les deux arguments optionnels ne \emph{sont pas} composés en mode mathématique.
		\item le troisième est une dimension qui correspond au décalage dans la direction perpendiculaire au sens de la flèche\idx*{flèche!décalage} que l'on veut lui faire subir : cette dimension sera positive pour un décalage de la flèche (et ses éventuels labels) vers le haut et négative si l'on souhaite un décalage vers le bas.
	\end{itemize}
	\item la flèche «\verb|-U>|» dispose de 5 arguments optionnels :
	\begin{itemize}
		\item les trois premiers sont identiques à ceux des autres types de flèches;
		\item le quatrième est le coefficient (qui vaut 0.333 par défaut) qui multiplie la longueur de la flèche pour obtenir le rayon de l'arc de cercle;
		\item le cinquième est le demi angle partant du centre de l'arc de cercle tracé, il vaut 60 degrés par défaut.
	\end{itemize}
	\item la flèche invisible\idx*{flèche!invisible} «\verb-0-» admet 2 arguments optionnels qui sont du même type que les deux premiers vus au dessus;
\end{itemize}
\exemple[50]{Arguments optionnels des flèches}/\schemedebug{false}
\schemestart A\arrow{->[sur][sous]}B \schemestop
\qquad
\schemestart A\arrow{->[sur][sous][4pt]}B \schemestop
\qquad
\schemestart A\arrow{->[sur][sous][-4pt]}B \schemestop
\medskip

\schemestart A\arrow{<=>[sur][sous]}[30,1.5]B \schemestop
\medskip

\schemestart[-20]
  A\arrow{->}B\arrow{->[][][3pt]}C\arrow{->[][][-3pt]}D
\schemestop/
Un problème survient lorsque les flèches sont verticales :
\exemple[50]{Flèches verticales}/\schemestart
  A\arrow{->[sur][sous]}[-90]B
\schemestop/
Par souci de lisibilité, il serait souhaitable que les \idx*{flèche!label}labels placés au dessus et au dessous soient horizontaux. On peut choisir l'angle selon lequel les labels sont affichés\idx*{flèche!label!angle}, la valeur par défaut étant l'angle de la flèche. Pour spécifier un autre angle, il suffit de placer au début des arguments optionnels \verb-*{<angle>}- :
\exemple[55]{Choix des angles}/\schemedebug{true}
\schemestart A\arrow{->[*{0}sur][*{0}sous]}[90]B\schemestop
\qquad
\schemestart A\arrow{->[*{0}sur][*{0}sous]}[45]B\schemestop
\qquad
\schemestart A\arrow{->[*{0}sur][*{0}sous]}[-45]B\schemestop
\qquad
\schemestart A\arrow{->[*{0}sur][*{0}sous]}[-90]B\schemestop/
L'ancre par défaut où est attaché chaque label provoque parfois des affichages indésirables :
\exemple[50]{Ancres}/\schemedebug{true}
\schemestart
  A\arrow{->[*{0}au-dessus][*{0}au-dessous]}[45,2]B
\schemestop/
On peut spécifier également l'ancre d'attache\idx*{flèche!label!ancre} pour écraser celui choisi par \CF par défaut. Il suffit d'utiliser la syntaxe suivante : \verb-*{<angle>.<ancre>}-.
\exemple[50]{Ancres}/\schemedebug{true}
\schemestart
  A\arrow{->[*{0.0}au-dessus][*{0.180}au-dessous]}[45,2]B
\schemestop
\qquad
\schemestart
  A\arrow{->[*{0.south east}au-dessus]%
    [*{0.north west}au-dessous]}[45,2]B
\schemestop/

Le cas particulier à envisager est la flèche «\verb/-U>/». Si l'un des deux labels contenus dans les deux premiers arguments optionnels est présent, l'arc de cercle correspondant est tracé :
\exemple[50]{La flèche \texttt{-U>}}/\schemestart A\arrow{-U>[123][456]}B\schemestop
\qquad
\schemestart A\arrow{-U>[123]}[30]B\schemestop
\qquad
\schemestart A\arrow{-U>[][456]}[-30]B\schemestop/

Le quatrième et cinquième argument optionnel changent les dimensions de l'arc de cercle. Ils représentent respectivement le coefficient qui multiplie la longueur de la flèche pour obtenir le rayon et l'angle correspondant au demi arc de cercle (seule la valeur absolue de l'angle est prise en compte) :
\exemple[50]{La flèche \texttt{-U>}}/\schemestart A\arrow{-U>[123][456][][0.25]}B\schemestop
\qquad
\schemestart A\arrow{-U>[123][456][][][90]}B\schemestop
\qquad
\schemestart A\arrow{-U>[123][456][][1][45]}B\schemestop/
En mettant un rayon et un angle négatif, l'arc de cercle se situe sous la flèche :
\exemple[50]{La flèche \texttt{-U>}}/\schemestart
  A\arrow{-U>[123][456][][-0.333][-60]}B
\schemestop/
Les deux premiers arguments disposent des mêmes fonctionnalités concernant les angles d'affichage et les ancres paramétrables que ceux des autres flèches :
\exemple[50]{La flèche \texttt{-U>}}/\schemestart
  A\arrow{-U>[123][456]}[-90]B
\schemestop
\qquad
\schemestart
  A\arrow{-U>[*{0.180}123][*{0.180}456]}[-90]B
\schemestop/

\section{Créer ses propres flèches}\label{definearrow}
Cette section, assez technique et demandant des connaissances sur \TIKZ, n'intéressera que les utilisateurs confirmés ayant besoin de définir leur propres flèches.

La commande \idx{\definearrow} permet de construire des flèches personnalisées. La syntaxe de cette commande est la suivante :

\hfill\verb-\definearrow{<nombre>}{<nom flèche>}{<code>}-\hfill\null

où \verb-<nombre>- est le nombre d'arguments optionnels auxquels on fera référence dans le \verb-<code>- avec la syntaxe habituelle \verb-#1-, \verb-#2-, etc. On ne peut pas définir de valeur par défaut pour ces arguments optionnels, et s'ils sont absents lorsque l'utilisateur utilise la macro \verb-\arrow-, ils seront vides.

Avant d'aller plus loin, examinons les macros disponibles en interne lors du tracé des flèches. Comme ces macros ont le caractère \verb-@- dans leur nom, on ne peut y accéder qu'entre les commandes \idx{\makeatletter} et \idx{\makeatother}.
\begin{itemize}
	\item \idx{\CF@arrow@start@name} et \idx{\CF@arrow@end@name} contiennent les noms des composés (qui sont des nœuds pour \TIKZ) entre lesquels doit être tracée la flèche;
	\item \idx{\CF@arrow@start@node} et \idx{\CF@arrow@end@node} contiennent les noms des nœuds où seront placés les extrémités des flèches. À la suite de ces noms viennent s'ajouter, s'ils ne sont pas vides, les ancres spécifiés par l'utilisateur dans l'argument entre parenthèses de la commande \idx\arrow;
	\item \idx{\CF@arrow@current@style} et \idx{\CF@arrow@current@angle} contiennent le style et l'angle de la flèche devant être tracée\idx*{flèche!angle}\idx*{flèche!style};
	\item \idx{\CF@arrow@shift@nodes}\verb-{<dim>}- décale les nœuds «\idx{\CF@arrow@start@node}» et «\idx{\CF@arrow@end@node}» de la dimension contenue dans son argument et ce, dans la direction perpendiculaire à la flèche\idx*{flèche!décalage};
	\item \idx{\CF@arrow@display@label}\verb/{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}/ est la plus complexe et se charge de placer les labels\idx*{flèche!label} avec les arguments suivants :
	\begin{itemize}
		\item \verb-#1- et \verb-#5- sont les labels a écrire;
		\item \verb-#2- et \verb-#6- sont des réels compris entre 0 et 1 spécifiant à quel endroit de la flèche ces labels doivent être écrits, 0 étant le début et 1 étant la fin,, le tout étant supposé que la flèche est \emph{rectiligne};
		\item \verb-#3- et \verb-#7- sont les caractères «+» ou «-», «+» affichant le label au dessus et «-» l'affichant au dessous
		\item \verb-#4- et \verb-#8- sont les nom des nœuds correspondant au début et à la fin de la flèche.
	\end{itemize}
	\item les extrémités de flèches\idx*{flèche!extrémité} employées sont basées sur le modèle «\verb-CF-» pour une flèche complète et avec l'option «harpoon» pour la demi flèche supérieure.
\end{itemize}

\subsection{Une première flèche}
Pour créer un exemple, mettons que l'on veuille construire une flèche avec un disque en son milieu que l'on va appeler «\verb/-.>/». Décidons qu'elle admettra 4 arguments optionnels. Comme pour les flèches déjà définies, le premier et le second seront les labels à mettre au dessus et au dessous et le troisième sera le décalage de la flèche dans le sens perpendiculaire à sa direction. Enfin, le 4\ieme{} argument sera la taille du point que l'on prendra égale à 2pt si le 4\ieme{} argument est absent.

Nous allons d'abord écrire \idx*\definearrow\verb/\definearrow{4}{-.>}/ pour déclarer que la flèche aura 4 arguments optionnels et s'appellera \verb/-.>/. Tout d'abord, il faut modifier les positions des nœuds entre lesquels doit être tracée la flèche pour tenir compte du décalage contenu dans le 3\ieme{} argument. Ceci est réalisé par la macro \idx{\CF@arrow@shift@nodes}, et il suffit donc de commencer le code de la flèche par : \idx{\CF@arrow@shift@nodes}\verb-{#3}%-. Ensuite, il faut tracer la flèche elle même et en profiter pour poser un nœud au milieu du segment que nous appelons "\verb-mid@point-", puis tracer un cercle dont le centre est ce dernier nœud. Tout ceci est fait par le code \idx*{tikz}\TIKZ suivant :

{\hskip2em\verb-\edef\pt@radius{\ifx\@empty#4\@empty 2pt\else #4\fi}% rayon du point-\par\parskip0pt
\hskip2em\verb/\expandafter\draw\expandafter[\CF@arrow@current@style,-CF]/\par
\hskip4em\verb/(\CF@arrow@start@node)--(\CF@arrow@end@node)coordinate[midway](mid@point);/\par
\hskip2em\verb-\filldraw(mid@point)circle(\pt@radius);%-}

Il ne nous reste plus qu'à placer les labels\idx*{flèche!label} s'ils existent avec la ligne suivante :

\hskip2em\verb/\CF@arrow@display@label{#1}{0.5}{+}{\CF@arrow@start@node}{#2}{0.5}{-}{\CF@arrow@end@node}/

Voici notre flèche achevée :
\exemple*{Flèche «-.>»}/\makeatletter
\definearrow4{-.>}{%
  \edef\pt@radius{\ifx\@empty#4\@empty 2pt\else #4\fi}% rayon du point
  \CF@arrow@shift@nodes{#3}%
  \expandafter\draw\expandafter[\CF@arrow@current@style,-CF](\CF@arrow@start@node)--(\CF@arrow@end@node)
    coordinate[midway](mid@point);
  \filldraw(mid@point)circle(\pt@radius);%
  \CF@arrow@display@label{#1}{0.5}{+}{\CF@arrow@start@node}{#2}{0.5}{-}{\CF@arrow@end@node}
  }
\makeatother
\schemestart
A \arrow{-.>} B \arrow{-.>[sur][sous][][1pt]} C \arrow{-.>[][sous]}[30] D \arrow{-.>[sur][][5pt][1.5pt]} E
\schemestop/

\subsection{Une flèche courbe}
Pourquoi ne pas maintenant créer une flèche courbe ? Pour rendre les choses simples, mettons qu'elle n'aura qu'un seul argument optionnel contenant le code \TIKZ qui définira le (ou les) point de contrôle, et si cet argument est vide, une flèche du type «\verb/-CF/» sera tracée.

Si l'argument \verb-#1- n'est pas vide, ce qui nous intéresse ne sont pas \idx{\CF@arrow@start@node} et \idx{\CF@arrow@end@node} qui contiennent les noms des nœuds où seront placés les extrémités des flèches parce que l'emplacement des ces nœuds est déjà déterminés par les ancres\idx*{flèche!ancre} qui sont calculés pour des flèches \emph{rectilignes} ! Nous allons plutôt prendre \idx{\CF@arrow@start@name} et \idx{\CF@arrow@end@name} qui contiennent les noms des composés (qui sont des nœuds pour \TIKZ) entre lesquels doit être tracée la flèche. Voici le code \TIKZ qui va tracer la ligne courbe entre ces deux composés :

{\verb/\draw[shorten <=\CF@arrow@offset,shorten >=\CF@arrow@offset,\CF@arrow@current@style,-CF,/\par\parskip0pt
\verb/(\CF@arrow@start@name).. controls #1 ..(\CF@arrow@end@name);%/}

On doit rajouter le code \TIKZ qui permet de raccourcir la flèche tracée de la valeur \idx{\CF@arrow@offset} définie par \idx{\setarrowoffset} puisqu'on ne part pas des nœuds correspondant aux flèches rectilignes \idx{\CF@arrow@start@node} et \idx{\CF@arrow@end@node}. Il faudra donc rajouter au début de \idx{\CF@arrow@current@style} le code suivant\idx*{\CF@arrow@offset}\idx*{\CF@arrow@offset} :
\centerverb/shorten <=\CF@arrow@offset, shorten >=\CF@arrow@offset/
c'est ce que font les deux lignes qui suivent le \verb-\else-.

Voici donc notre flèche :
\exemple*{Flèche courbe}/\makeatletter
\definearrow1{s>}{%
\ifx\@empty#1\@empty
  \expandafter\draw\expandafter[\CF@arrow@current@style,-CF](\CF@arrow@start@node)--(\CF@arrow@end@node);%
\else
  \def\curvedarrow@style{shorten <=\CF@arrow@offset,shorten >=\CF@arrow@offset,}%
  \CF@expadd@tocs\curvedarrow@style\CF@arrow@current@style
  \expandafter\draw\expandafter[\curvedarrow@style,-CF](\CF@arrow@start@name)..controls#1..(\CF@arrow@end@name);
\fi
}
\makeatother
\schemestart
A\arrow{s>}
B\arrow{s>[+(0.5cm,0.5cm)]}
C\arrow{s>[+(45:1cm)]}
D\arrow(.60--.120){s>[+(60:1cm) and +(-120:1cm)]}
E\arrow{s>[+(45:1) and +(-135:1)]}
F\arrow{s>[+(-30:1) and +(150:1)]}[,1.5]
G\arrow(.90--.90){s>[+(60:1)and+(120:1)]}[,2]
H
\schemestop

\schemestart
A\arrow(.90--.180){s>[+(90:0.8) and +(180:0.8)]}[45]B
\arrow(.0--.90){s>[+(0:0.8) and +(90:0.8)]}[-45]C
\arrow(.-90--.0){s>[+(-90:0.8) and +(0:0.8)]}[-135]D
\arrow(.180--.-90){s>[+(180:0.8) and +(-90:0.8)]}[135]
\schemestop/

\section{La commande \protect\texttt{\textbackslash merge}}
La commande \idx{\merge} permet de tracer des flèches qui partent de plusieurs composés existants puis qui se rejoignent pour continuer le schéma réactionnel.

Immédiatement après la commande \idx{\merge}, il faut spécifier dans quelle direction va se faire la progression. Pour cela, on utilise un des 4 caractères de direction : «\verb->-» (qui est celui par défaut si le caractère est absent), «\verb-<-», «\verb-^-» et «\verb-v-».

La syntaxe devient ensuite :

\hfill\verb/\merge{dir}(n1.a1)(n2.a2)(...)(ni.ai)--(n.a[s])/\hfill\null

Où les noms «\verb-ni-» avant le double tiret sont ceux que des composés déjà existant que l'on veut joindre. On peut également préciser l'ancre «\verb-ai-» duquel doit partir la flèche si l'ancre par défaut ne convient pas. Comme pour la commande \idx\arrow, «\verb-n.a[s]-» contient le nom, l'ancre et le style du prochain composé.

\exemple[50]{La commande \string\merge}/\schemestart
ABC\arrow[30]EFGHIJ\arrow[45]KLM\arrow[60]NO
\merge>(c1)(c2)(c3)--()suite 1
\arrow suite 2
\schemestop
\bigskip

\schemestart
Foooo\arrow(foo--bar){<=>}Bar\arrow(--baz){<=>}Bz
\merge^(foo)(bar)(baz)--()suite
\schemestop
\bigskip

\schemedebug{true}
\schemestart
A\arrow{<->}[90]B
\merge<(c1.120)(c2)--(foobar.45[circle,blue])CCC
\schemestop/

En ce qui concerne la géométrie de la flèche \idx{\merge}, celle-ci se compose de $n$ traits qui partent de chaque composé et vont jusqu'à la ligne de jonction qui leur est perpendiculaire : la longueur par défaut du plus court de ces traits est la moitié de l'espacement entre les composés défini avec \idx\setcompoundsep. La flèche tracée depuis la ligne de jonction jusqu'au composé suivant a également cette longueur par défaut, et elle part du milieu de la ligne de jonction. Ces 3 caractéristiques géométriques peuvent être modifiées au moyen de l'argument optionnel qui vient après le nom de composé suivant :

\hfill\verb/\merge{dir}(n1.a1)(n2.a2)(...)(ni.ai)--(n.a[s])[c1,c2,c,style]/\hfill\null

où :
\begin{itemize}
	\item la longueur de trait le plus court entre les composés à joindre et la ligne de jonction s'obtient en multipliant l'espacement entre les composés défini avec \idx{\setcompoundsep} par le coefficient \verb-c1-, qui vaut 0.5 par défaut;
	\item la longueur de la flèche entre la ligne de jonction et le composé suivant s'obtient en l'espacement entre les composés par le coefficient \verb-c2-, qui vaut 0.5 par défaut;
	\item l'endroit d'où part la flèche depuis la ligne de jonction est déterminée par le coefficient \verb-c-, sachant que s'il vaut 0, la flèche partira de la gauche de la ligne de jonction (ou du haut si la direction est \verb-v- ou \verb-^-);
	\item le style de la flèche tracée avec \idx{\merge} est défini par le dernier argument \verb-style-.
\end{itemize}

\exemple*{Paramètres géométriques de \string\merge}/\schemestart A\arrow{<=>}[90]B\merge(c1)(c2)--()C\schemestop\qquad
\schemestart A\arrow{<=>}[90]B\merge(c1)(c2)--()[1]C\schemestop\qquad
\schemestart A\arrow{<=>}[90]B\merge(c1)(c2)--()[,1]C\schemestop\qquad
\schemestart A\arrow{<=>}[90]B\merge(c1)(c2)--()[,,0.2]C\schemestop\qquad
\schemestart A\arrow{<=>}[90]B\merge(c1)(c2)--()[,,0.9,red,thick]C\schemestop
\bigskip

\schemestart A\arrow{<=>}B\merge^(c1)(c2)--()C\schemestop\qquad
\schemestart A\arrow{<=>}B\merge^(c1)(c2)--()[1]C\schemestop\qquad
\schemestart A\arrow{<=>}B\merge^(c1)(c2)--()[,1]C\schemestop\qquad
\schemestart A\arrow{<=>}B\merge^(c1)(c2)--()[,,0.2]C\schemestop\qquad
\schemestart A\arrow{<=>}B\merge^(c1)(c2)--()[,,0.9,red,thick]C\schemestop/

Enfin, il est possible d'écrire des labels au dessus ou au dessous de la flèche créée par la commande \idx{\merge}. Pour cela, le caractère définissant la direction admet deux arguments optionnels entre crochets, le premier contenant le label mis au dessus et le second celui mis au dessous de la flèche. La syntaxe complète de la commande \idx{\merge} est donc :

\hfill\verb/\merge{dir}[labelup][labeldow](n1.a1)(n2.a2)(...)(ni.ai)--(n.a[s])[c1,c2,c,style]/\hfill\null

Toutes les fonctionnalités déjà présentées pour les labels des flèches sont ici possibles, à savoir choisir l'angle de rotation et l'ancre avec la syntaxe \verb-*{angle.ancre}- placée juste avant le contenu du label.

\exemple*{Labels de la commande \string\merge}/\schemestart
ABC\arrow{<=>}[90]DEF\merge>[sur][sous](c1)(c2)--()[0.25,1,0.75]GHIJ
\schemestop\qquad
\schemestart
ABC\arrow{<=>}[90]DEF\merge>[*{45.south west}sur][*{45.north east}sous](c1)(c2)--()[0.25,1,0.75]GHIJ
\schemestop\qquad
\schemestart
ABC\arrow{<=>}[90]DEF\merge>[*{90}sur][*{90}sous](c1)(c2)--()[0.25,1,0.75]GHIJ
\schemestop
\bigskip

\schemestart
ABC\arrow{<=>}DEF\merge v[sur][sous](c1)(c2)--()[0.25,1,0.75]GHIJ
\schemestop\qquad
\schemestart
ABC\arrow{<=>}DEF\merge v[*{45.north west}sur][*{45.south east}sous](c1)(c2)--()[0.25,1,0.75]GHIJ
\schemestop\qquad
\schemestart
ABC\arrow{<=>}DEF\merge v[*{0}sur][*{0}sous](c1)(c2)--()[0.25,1,0.75]GHIJ
\schemestop/

\section{Le signe +}\label{signe+}
Entre les commandes \idx{\schemestart} et \idx{\schemestop}, on dispose de la macro «\idx\+» qui affiche un signe ${}+{}$. Elle admet un argument optionnel \emph{entre accolades} contenant 3 dimensions sous cette forme \verb-{<dim1>,<dim2>,<dim3>}- où :
\begin{itemize}
	\item \verb-<dim1>- et \verb-<dim2>- sont les dimensions qui vont être insérées avant et après le signe ${}+{}$;
	\item \verb-<dim3>- est le décalage vertical que l'on veut faire subir au signe.'
\end{itemize}
Si l'un des arguments est vide ou si l'argument entre accolades n'existe pas, les dimensions prennent leur valeur par défaut que l'on peut spécifier avec la commande \idx\setandsign\verb-{<dim1>,<dim2>,<dim3>}-\label{setandsign}. Si l'on spécifie un champ vide, \verb-<dim1>- et \verb-<dim2>- valent 0.5em tandisque que \verb-<dim3>- vaut 0pt s'il est vide. Les valeurs par défaut \verb-{0.5em,0.5em,0pt}- sont celles en vigueur si l'utilisateur n'en spécifie pas d'autres.

\exemple[50]{La commande \string\+}/\schemestart
A\+B\+{2em,,5pt}C\+{0pt,0pt,-5pt}D\arrow E\+F
\schemestop

\setandsign{1em,1em,0pt}
\schemestart
A\+B\+{2em,,5pt}C\+{0pt,0pt,-5pt}D\arrow E\+F
\schemestop/

Comme on le voit sur l'exemple ci-dessous, il faut comprendre que le signe ${}+{}$ inséré par la commande \idx{\+} fait partie du composé :
\exemple[50]{Les composés et \string\+}/\schemedebug{true}
\schemestart A\+ B\+{,,5pt}C\arrow D\+ E\schemestop/
Il devient donc difficile de faire partir une flèche exactement sous la lettre«A» puisque cette lettre n'est pas un composé unique aux yeux de \CF. On peut donc utiliser dans ce cas la commande \idx{\subscheme} pour envelopper dans un composé unique la lettre «A», voire même le signe lui même et pouvoir y faire référence par la suite avec le nom qui lui est attribué :
\exemple[50]{Sous composé et \string\+}/\schemedebug{true}
\schemestart
\subscheme{A}\+ B\arrow C
\arrow(@c2--)[-90]E
\schemestop
\medskip

\schemestart
A\subscheme{\+}BCDEF \arrow G
\arrow(@c2--)[-90]H
\schemestop/%
\idx*{schéma réactionnel|)}
Il peut arriver que l'alignement du signe «+» avec les molécules qui précèdent ou qui suivent pose problème. Voici un exemple :
\exemple{Alignement du signe +}/\schemedebug{true}
\schemestart
  \chemfig{C(<[:40])(<[:160])=[6]C(<[:-130])<[:-20]}
  \+
  \chemfig{\lewis{246,Br}-\lewis{026,Br}}
\schemestop/
Ce qui se passe est que le signe «+» est sur la même ligne de base que le composé qui précède, et cette ligne de base est celle de l'atome «C» du haut. On pourrait bien sûr décaler le signe «+» mais cela ne changerait pas la position verticale de «\kern0.3333em\chemfig{\lewis{246,Br}-\lewis{026,Br}}\kern0.3333em». En fait, le signe «+» ne stoppe pas la lecture d'un composé pour \CF ce que l'on constate dans l'exemple ci-dessus où tout est englobé dans le composé «c1». On va donc être obligé de stopper le composé après la première molécule avec un \verb-\arrow{0}[,0]- qui produira une flèche invisible de longueur nulle. Pour centrer verticalement le tout, on va également préciser que l'ancre du premier composé doit être «west» (ou «180» qui est un synonyme) avec le deuxième argument optionnel de la commande \verb-\schemestart- :
\exemple{Alignement du signe +}/\schemedebug{true}
\schemestart[][west]
  \chemfig{C(<[:40])(<[:160])=[6]C(<[:-130])<[:-20]}
  \arrow{0}[,0]\+
  \chemfig{\lewis{246,Br}-\lewis{026,Br}}
\schemestop/
De cette façon, le premier composé «c1» est la première molécule et le second composé est le reste, c'est-à-dire le signe «+» et la seconde molécule. On aurait pû jouer sur les ancres ou les styles via la commande \verb-\arrow- pour placer le second composé à un autre endroit. Ici, par exemple on décale le second composé de 10pt vers le bas dans le premier cas et on fait coïncider l'ancre «south east» du premier composé avec l'ancre «south west» du second dans le deuxième cas :
\exemple{Alignement du signe +}/\schemedebug{true}
\schemestart[][west]
  \chemfig{C(<[:40])(<[:160])=[6]C(<[:-130])<[:-20]}
  \arrow(--[yshift=-10pt]){0}[,0]\+
  \chemfig{\lewis{246,Br}-\lewis{026,Br}}
\schemestop
\medskip

\schemestart[][west]
  \chemfig{C(<[:40])(<[:160])=[6]C(<[:-130])<[:-20]}
  \arrow(.south east--.south west){0}[,0]\+
  \chemfig{\lewis{246,Br}-\lewis{026,Br}}
\schemestop/
\newpage

\part{Liste des commandes}
Les commandes créées par \CF sont :
\begin{center}
\begin{longtable}{>\footnotesize l>\footnotesize p{9cm}}\\\hline
\hfill\normalsize Commandes\hfill\null &\hfill\normalsize Description\hfill\null\\\hline
\idx\chemfig\verb-<code>-&dessine la molécule dont le dessin est décrit par le \verb-<code>-\\
\idx\chemfig\verb-*<code>-&comme ci-dessus, mais les liaisons ont des longueurs fixes\\
\idx\enablefixedbondlength&les molécules ont des liaisons de longueurs égales\\
\idx\disablefixedbondlength&les molécules ont des espaces interatomes égaux\\
\idx\enablebondjoin{} et \idx\disablebondjoin& active ou désactive le raccord entre les liaisons simples\\
\idx\printatom & cette macro affiche les atomes dans les molécules. Elle peut être redéfinie pour personnaliser l'affichage, voir page~\pageref{perso.affichage}\\
\idx\setnodestyle\verb-{<style tikz>}-& à l'aide de la syntaxe de \TIKZ, cette macro définit le style de nœuds contenant les atomes, voir page~\pageref{style.noeuds}\\
\idx\setbondestyle\verb-{<style tikz>}-& à l'aide de la syntaxe de \TIKZ, cette macro définit le style des liaisons voir page~\pageref{setbondstyle}\\
\idx\hflipnext&la prochaine molécule sera inversée horizontalement\\
\idx\vflipnext&la prochaine molécule sera inversée verticalement\\
\idx\definesubmol\verb-{<nom>}[code1]{<code2>}- & créé un alias \verb-!<nom>- que l'on peut placer dans le code des molécules à dessiner qui remplace le \verb-<code1>- ou le \verb-<code2>- selon l'inclinaison de la dernière liaison. Voir page~\pageref{definesubmol}\\
\idx\chemskipalign & Ignore le groupe d'atomes en cours pour le mécanisme d'alignement vertical. Voir page~\pageref{chemskipalign}.\\
\idx\redefinesubmol\verb-{<nom>}{<code>}-& remplace l'alias déjà existant \verb-!<nom>- par le nouveau \verb-<code>-. Voir page~\pageref{redefinesubmol}\\[2ex]\hline
&\\
\idx\setcrambond\verb-{<dim1>}{<dim2>}{<dim3>}-& règle les dimensions des triangles représentant les liaisons de Cram : \verb-<dim1>- est la largeur de la base, \verb-<dim2>- est l'espacement entre les pointillés et \verb-<dim3>- est la largeur des pointillés. Voir page~\pageref{setcrambond}\\
\idx\setatomsep\verb-{<dim>}>-& règle la distance interatome. Voir page~\pageref{setatomsep}\\
\idx\setangleincrement\verb-<angle>- & spécifie l'angle à multiplier pour les angles de liaisons. Voir page~\pageref{setangleincrement}\\
\idx\setbondoffset\verb-{<dim>}- & règle l'espacement entre les atomes liés et la liaison. Voir page~\pageref{setbondoffset}\\
\idx\setdoublesep\verb-{<dim>}- & règle l'espacement entre les deux traits d'une double liaison. Voir page~\pageref{setdoublesep}\\[2ex]\hline
&\\
\idx\lewis\verb-[coeff]{<codes>,<atome>}-& affiche l'\verb-<atome>- et positionne les décorations de Lewis selon ce qui est spécifié dans le \verb-<code>-. Les décorations dessinées ne modifient pas la boîte englobante de l'\verb-<atome>-. Voir page~\pageref{lewis}\\
\idx\Lewis\verb-[coeff]{<codes>,<atome>}-& affiche l'\verb-<atome>- et positionne les décorations de Lewis selon ce qui est spécifié dans le \verb-<code>-. Voir page~\pageref{Lewis}\\
\idx\setlewis\verb-{<dim1>}{<dim2>}{<code tikz>}- & règle les décoration de Lewis; \verb-<dim1>- est la distance entre l'atome et la décoration, \verb-<dim2>- est la longueur du trait représentant la paire d'électrons et \verb-<code tikz>- est le code qui sera passé directement à \TIKZ. Voir page~\pageref{setlewis}\\
\idx\setlewisdist\verb-{dim}-& règle la distance entre les deux disques représentant une paire d'électron. Voir page~\pageref{setlewisdist}\\[2ex]\hline
&\\
\idx\chemmove\verb-[<options tikz>]<code tikz>-& Ouvre un environnement \verb-tikzpicture- en y ajoutant à celles qui existent déjà les \verb-<options tikz>-, et relie avec le \verb-<code tikz>- les nœuds posés dans les molécules à l'aide du caractère «\verb-@-». Voir page~\pageref{mecanismes-reactionnels}.\\[2ex]\hline
&\\
\idx\chemabove\verb-[<dim>]{<txt1>}{txt2}- & écrit le \verb-<txt1>- et positionne le \verb-<txt2>- au dessus en laissant \verb-<dim>- d'espacement vertical. Cette commande ne change pas la boîte englobante de \verb-<txt1>-. Voir page~\pageref{chemabove}\\
\idx\chembelow\verb-[<dim>]{<txt1>}{txt2}- & écrit le \verb-{txt1}- et positionne le \verb-<txt2>- au dessous en laissant \verb-<dim>- d'espacement vertical. Cette commande ne change pas la boîte englobante de \verb-<txt1>-. Voir page~\pageref{chemabove}\\
\idx\Chemabove\verb-[<dim>]{<txt1>}{txt2}- & écrit le \verb-<txt1>- et positionne le \verb-<txt2>- au dessus en laissant \verb-<dim>- d'espacement vertical. Voir page~\pageref{chemabove}\\
\idx\Chembelow\verb-[<dim>]{<txt1>}{txt2}- & écrit le \verb-{txt1}- et positionne le \verb-<txt2>- au dessous en laissant \verb-<dim>- d'espacement vertical. Voir page~\pageref{chembelow}\\
\idx\chemname\verb-[<dim>]{<molécule>}{<nom>}-\idx*\chemname & Affiche le \verb-<nom>- sous la \verb-<molécule>-. Voir page~\pageref{chemname}\\
\idx\chemnameinit & initialise la plus grande profondeur des molécules rencontrées pour avoir un alignement correct de leurs noms. Voir page~\pageref{chemnameinit}\\[2ex]\hline
&\\
\idx\schemestart\dots\idx\schemestop& balises entre lesquelles un schéma réactionnel est tracé. Voir page~\pageref{schemestart}.\\
\idx\arrow& trace une flèche dans un schéma réactionnel (la commande n'est définie que dans un schéma réactionnel). Voir page~\pageref{arrow} et suivantes.\\
\idx\+ & affiche un signe $+$ dans un schéma réactionnel (la commande n'est définie que dans un schéma réactionnel). Voir page~\pageref{signe+}.\\
\idx\subscheme\verb-{<code>}- & trace un sous schéma réactionnel (la commande n'est définie que dans un schéma réactionnel). Voir page~\pageref{subscheme}.\\
\idx\definearrow & définit une flèche. Voir page~\pageref{definearrow}.\\
\idx\chemleft\verb-<car1><matériel>-\idx\chemright\verb-<car1>-& trace des delimiteurs extensibles définis par \verb-<car1>- et \verb-<car2>- à gauche et à droite du \verb-<matériel>-, voir page~\pageref{chemleft}.\\
\idx\chemup\verb-<car1><matériel>-\idx\chemdown\verb-<car1>-& trace des delimiteurs extensibles définis par \verb-<car1>- et \verb-<car2>- au dessus et au dessous du \verb-<matériel>-, voir page~\pageref{chemup}.\\
\idx\setcompoundsep\verb-{<dim>}-& définit l'espacement de bord à bord des composés dans un schéma réactionnel. Voir page~\pageref{setcompoundsep}.\\
\idx\setarrowoffset\verb-{<dim>}-&définit l'espacement entre le bord d'un composé et le début et la fin d'une flèche. Voir page~\pageref{setarrowoffset}.\\
\idx\setarrowdefault\verb-{angle,coeff,style}-&définit les caractéristiques par défaut d'une flèche. Voir page~\pageref{setarrowdefault}.\\
\idx\setcompoundstyle\verb-{<code tikz>}-&définit le style par défaut des composés. Voir page~\pageref{setcompoundstyle}.\\
\idx\setarrowlabelsep\verb-{<dim>}-&définit l'espacement entre la flèche et l'ancre des labels qui sont placés au dessus et au dessous. Voir page~\pageref{setarrowlabelsep}.\\
\idx\setandsign\verb-{<dim1>,<dim2>,<dim3>}-&définit les caractéristiques du signe $+$ où \verb-<dim1>- et \verb-<dim2>- sont les espaces laissés avant et près le signe et \verb-<dim3>- est le décalage vertical. Voir page~\pageref{setandsign}.\\\hline
\end{longtable}
\end{center}
\newpage

\part{Galerie}
Ce manuel s'achève avec des dessins de molécules plus ou moins complexes.

L'utilisateur curieux pourra s'intéresser au \verb-<code>- de chaque molécule, bien que celui-ci devienne parfois rebutant lorsqu'elles deviennent complexes. En effet, au delà d'un certain niveau de complexité, bien qu'il soit est assez facile d'écrire un \verb-<code>- pour dessiner une molécule, il est assez ardu de relire ce \verb-<code>- pour l'analyser a posteriori. On atteint rapidement les limites de la lisibilité immédiate du code d'un dessin complexe.

Quoi qu'il en soit, j'espère que cette extension aidera tous les utilisateurs de \LaTeX{} qui souhaitent dessiner des molécules chimiques. Bien que \CF ait été testé de façon approfondie et que le numéro de version soit supérieur à 1.0, j'espère que vous serez indulgent quant aux bugs rencontrés. Un \href{mailto:unbonpetit@openmailbox.org}{\texttt{\textbf{email}}} pour me signaler tout dysfonctionnement ou toute proposition d'amélioration sera bienvenu.\nobreak

\hfill Christian \textsc{Tellechea}
\bigskip

\begin{center}
\parskip0pt
$\star$\par
$\star\quad\star$
\end{center}
\bigskip

\exemple*{2-methylpentane}/\chemfig{[7]H_3C-CH(-[6]CH_3)-[1]CH_2-CH_2-[1]CH_3}/

\exemple*{3-éthyl-2-méthylhexane}/\chemfig{H_3C-[7]CH(-[6]CH_3)-[1]CH(-[7]C_3H_7)-[2]CH_2-[3]H_3C}/

\idx*\definesubmol
\idx*\phantom
\exemple*{Stéarine, formule semi développée}/\definesubmol{@}{([0,2]-O-[0,1]C(=[2,1]O)-C_{17}H_{33})}
\chemfig{[2,2]CH_2!@-CH_{\phantom 2}!@-CH_2!@}/

\idx*\definesubmol
\exemple*{Stéarine, formule topologique}/\definesubmol{x}{-[:+30,.6]-[:-30,.6]}
\definesubmol{y}{-O-(=[2,.6]O)-!x!x!x!x!x!x!x!x}
\chemfig{[2]([0]!y)-[,1.5]([0]!y)-[,1.5]([0]!y)}/

\exemple*{2-méthylpropanoate de méthyl}/\chemfig{H_3C-CH_2(-[2]CH_3)-C(=[1]O)-[7]O-CH_3}/

\exemple*{La vanilline}/\chemfig{HC*6(-C(-OH)=C(-O-[::-60]CH_3)-CH=C(-[,,,2]HC=[::-60]O)-HC=[,,2])} \quad ou \quad
\chemfig{*6(-(-OH)=(-OCH_3)-=(-=[::-60]O)-=)}/

\exemple*{La caféine}/\chemfig{*6((=O)-N(-CH_3)-*5(-N=-N(-CH_3)-=)--(=O)-N(-H_3C)-)}/

\exemple*{L'aspirine}/\chemfig{*6(-=-(-O-[::-60](=[::-60]O)-[::+60])=(-(=[::+60])-[::-60]OH)-=)}/

\exemple*{Anhydride phtalique}/\chemfig{*6(=*5(-(=O)-O-(=O)-)-=-=-)}/

\idx*\setcrambond
\exemple*{Camphre}/\chemfig{*6(-(<:[::120](-[::-100,0.7])(-[::100,0.7]))--(=O)-(-)(<:[::120])--)}
\quad ou \quad
\setcrambond{3pt}{}{}
\chemfig{<[:10](>[:85,1.8]?(-[:160,0.6])-[:20,0.6])
>[:-10]-[:60](=[:30,0.6]O)-[:170]?(-[:30,0.6])-[:190]-[:240]}/

\idx*\definesubmol
\exemple*{Triphenylméthane}/\chemfig{*6(-=-*6(-(-*6(=-=-=-))-*6(=-=-=-))=-=)}
\quad ou \quad
\definesubmol{@}{*6(=-=-=-)}
\chemfig{(-[:-30]!@)(-[:90]!@)(-[:210]!@)}/

\idx*\setcrambond
\idx*\definesubmol
\exemple*{Amygdaline}/\setcrambond{2pt}{}{}
\definesubmol{c1}{-[:200]-[:120]O-[:190]}
\definesubmol{c2}{-[:170](-[:200,0.7]HO)<[:300](-[:170,0.6]HO)
-[:10,,,,line width=2pt](-[:-40,0.6]OH)>[:-10]}
\definesubmol{csub}{-[:155,0.65]-[:90,0.65]}
\chemfig{O(!{c1}(!{csub}O(!{c1}(!{csub}OH)!{c2}))!{c2})-[:-30](-[:-90]CN)-[:30]*6(=-=-=-)}/

\idx*\setcrambond
\idx*\definesubmol
\exemple*{Adénosine triphosphate}/\setcrambond{3pt}{}{}
\definesubmol{a}{-P(=[::-90,0.75]O)(-[::90,0.75]HO)-}
\chemfig{[:-54]*5((--[::60]O([::-60]!aO([::-60]!aO([::60]!aHO))))<(-OH)
-[,,,,line width=2pt](-OH)>(-N*5(-=N-*6(-(-NH_2)=N-=N-)=_-))-O-)}/

\exemple*{Viagra}/\chemfig{N*6((-H_3C)---N(-S(=[::+120]O)(=[::+0]O)-[::-60]*6(-=-(-O-[::-60]-[::+60]CH_3)
=(-*6(=N-*5(-(--[::-60]-[::+60]CH_3)=N-N(-CH_3)-=)--(=O)-N(-H)-))-=))---)}/

\exemple*{Ester de cholestérol}/\chemfig{[:30]R-(=[::+60]O)-[::-60]O-*6(--*6(=--*6(-*5(---(-(-[::+60]Me)
-[::-60]-[::-60]-[::+60]-[::-60](-[::-60]Me)-[::+60]Me)-)-(-[::+0]Me)---)--)-(-[::+0]Me)---)}/

\exemple*{Porphyrine}/\chemfig{?=[::+72]*5(-N=(-=[::-72]*5(-[,,,2]HN-[,,2](=-[::-36]*5(=N-(=-[::-72]*5(-NH-[,,1]?=-=))
-=-))-=-))-=-)}/

\idx*\definesubmol
\exemple*{Manganese 5,10,15,20-tétra(N-ethyl-3-carbazolyl) porphyrine}/\definesubmol{A}{*6(=-*5(-*6(-=-=-)--N(--[::-60])-)=-=-)}
\chemfig{([::+180]-!A)=[::+72]*5(-N=(-(-[::+54]!A)=[::-72]*5(-N(-[::-33,1.5,,,draw=none]Mn)
-(=(-[::+72]!A)-[::-36]*5(=N-(=(-[::+54]!A)-[::-72]*5(-N-(-)=-=))-=-))-=-))-=-)}/

\exemple*{Pénicilline}/\chemfig{[:-90]HN(-[::-45](-[::-45]R)=[::+45]O)>[::+45]*4(-(=O)-N*5(-(<:(=[::-60]O)
-[::+60]OH)-(<[::+0])(<:[::-108])-S>)--)}/

\idx*\chembelow
\exemple*{LSD}/\chemfig{[:150]?*6(=*6(--*6(-N(-CH_3)--(<(=[::+60]O)-[::-60]N(-[::+60]-[::-60])
-[::-60]-[::+60])-=)([::-120]<H)---)-*6(-=-=-(-[::-30,1.155]\chembelow{N}{H}?)=))}/

\exemple*{Strychnine}/\chemfig{*6(=-*6(-N*6(-(=O)--([::-120]<:H)*7(-O--=?[0]([::-25.714]-[,2]?[1]))
-*6(-?[0,{>}]--(<N?[1]?[2])-(<[::-90]-[::-60]?[2]))(<:[::+0]H)-([::+120]<H))--?)=?-=-)}/

\exemple*{Codéïne}/\chemfig{[:-30]**6(-(-OH)-?-*6(-(-[3]-[2,2]-[0,.5])*6(-(<:[:-150,1.155]O?)
-(<:OH)-=-)-(<:[1]H)-(-[2]NCH_3)--)---)}/

\idx*\lewis
\exemple*{Colorant(rouge)}/\chemfig{**6(--*6(-(-NO_2)=-(-\lewis{26,O}-[0]H)=(-\lewis{4,N}=[0]\lewis{2,N}-[0]Ar)-)----)}/

\idx*\lewis
\exemple*{Menthone}/\chemfig{CH_3-?(-[2]H)(-[::-30,2]-[::+60](=[1]\lewis{20,O})
-[::-150,1.5](-[:20]CH(-[1]CH_3)(-[7]CH_3))(-[6]H)-[::-90,2]-[::+60]?)}/

\idx*\chembelow
\idx*\+
\idx*\schemestart
\exemple*{Synthèse de Fischer de l'indole}/\schemestart
	\chemfig{*6(=-*6(-\chembelow{N}{H}-NH_2)=-=-)}
	\+
	\chemfig{(=[:-150]O)(-[:-30]R_2)-[2]-[:150]R_1}
	\arrow(.mid east--.mid west){->[\chemfig{H^+}]}
	\chemfig{*6(-=*5(-\chembelow{N}{H}-(-R_2)=(-R_1)-)-=-=)}
\schemestop/

\idx*\chemabove
\idx*\lewis
\idx*{"@}
\idx*\chemmove
\idx*{charge!\protect\texttt{\protect\string\protect\oplus}}
\idx*{charge!\protect\texttt{\protect\string\protect\ominus}}
\exemple*{Mécanisme réactionnel : groupement carbonyle}/
\schemestart
	\chemfig{C([3]-)([5]-)=[@{db,.5}]@{atoo}\lewis{06,O}}
	\arrow(.mid east--.mid west){<->}
	\chemfig{\chemabove{C}{\scriptstyle\oplus}([3]-)([5]-)-\chemabove
		{\lewis{026,O}}{\hspace{5mm}\scriptstyle\ominus}}
\schemestop
\chemmove{\draw[shorten <=2pt, shorten >=2pt](db) ..controls +(up:5mm) and +(up:5mm)..(atoo);}/

\idx*\chembelow
\idx*\lewis
\idx*\chemabove
\idx*{"@}
\idx*\chemmove
\exemple*{Mécanismes réactionnels : dérivés nitrés}/\schemestart
	\chemfig{R-\chembelow{N}{\hspace{-5mm}\scriptstyle\oplus}([1]=[@{db}]@{atoo1}O)([7]-[@{sb}]@{atoo2}
	\chemabove{\lewis{157,O}}{\hspace{7mm}\scriptstyle\ominus})}
	\arrow(.mid east--.mid west){<->}
	\chemfig{R-\chemabove{N}{\hspace{-5mm}\scriptstyle\oplus}([1]-\chemabove{O}{\scriptstyle\ominus})([7]=O)}
\schemestop
\chemmove{
	\draw[shorten <=2pt, shorten >=2pt](db) ..controls +(120:5mm) and +(120:5mm)..(atoo1);
	\draw[shorten <=3pt, shorten >=2pt](atoo2) ..controls +(225:10mm) and +(225:10mm)..(sb);
}/

\idx*\lewis
\idx*\chemabove
\idx*\chemmove
\idx*\arrow\idx*\+\idx*\schemestart\idx*\schemestop
\idx*{"@}
\idx*\chembelow
\idx*{charge!\protect\texttt{\protect\string\protect\oplus}}
\exemple*{Addition nucléophile. Amines primaires}/\setatomsep{2.5em}
\setcompoundsep{5em}
\schemestart
	\chemfig{R-@{aton}\lewis{2,N}H_2}
	\+
	\chemfig{@{atoc}C([3]-CH_3)([5]-CH_3)=[@{atoo1}]O}
	\chemfig{@{atoo2}\chemabove{H}{\scriptstyle\oplus}}
	\chemmove[-stealth,shorten <=3pt,dash pattern= on 1pt off 1pt,thin]{
		\draw[shorten >=2pt](aton) ..controls +(up:10mm) and +(left:5mm)..(atoc);
		\draw[shorten >=8pt](atoo1) ..controls +(up:10mm) and +(north west:10mm)..(atoo2);}
	\arrow{<=>[\tiny addition]}
	\chemfig{R-@{aton}\chembelow{N}{\scriptstyle\oplus}H([2]-[@{sb}]H)-C(-[2]CH_3)(-[6]CH_3)-OH}
\schemestop
\chemmove{
    \draw[-stealth,dash pattern= on 1pt off 1pt,shorten <=3pt, shorten >=2pt]
    (sb)..controls +(left:5mm) and +(135:2mm)..(aton);}
\par
\schemestart
	\arrow{<=>}
	\chemfig{R-@{aton}\lewis{2,N}([6]-[@{sbh}]H)-[@{sb}]C(-[2]CH_3)(-[6]CH_3)-[@{sbo}]@{atoo}
	\chemabove{O}{\scriptstyle\oplus}(-[1]H)(-[7]H)}
	\chemmove[-stealth,shorten <=3pt,shorten >=2pt,dash pattern= on 1pt off 1pt,thin]{
		\draw(aton) ..controls +(up:5mm) and +(up:5mm)..(sb);
		\draw(sbh) ..controls +(left:5mm) and +(south west:5mm)..(aton);
		\draw(sbo) ..controls +(up:5mm) and +(north west:5mm)..(atoo);}
	\arrow{<=>[\tiny élimination]}\chemfig{R-N=C(-[1]CH_3)(-[7]CH_3)}
	\+
	\chemfig{H_3\chemabove{O}{\scriptstyle\oplus}}
\schemestop/

\idx*\setatomsep
\idx*\schemestart\idx*\arrow\idx*\merge\idx*\schemestop
\exemple*{Schéma réactionnel}/\setatomsep{2em}
\schemestart[-90]
	\chemfig{**6(---(-NH _2)---)}\arrow{0}\chemfig{HNO_2}
	\merge(c1)(c2)--()
	\chemfig{**6(---(-N_2|{}^\oplus)---)}\arrow{0}\chemfig{**6(---(-NH _2)---)}
	\merge(c3)(c4)--()
	\chemfig{**6(---(-N=[::-30]N-[::-30]**6(---(-NH_2)---))---)}
\schemestop/

\idx*\setatomsep
\idx*\schemestart\idx*\arrow\idx*\subscheme\idx*\schemestop\idx*\chemleft\idx*\chemright
\idx*{charge!\protect\texttt{\protect\string\protect\oplus}}
\exemple*{Réaction d'addition}/\setatomsep{2.5em}
\schemestart
	\chemfig{*6(=-(-)(=[2]O))}
	\arrow{->[\+\chemfig{H^\oplus}]}
	\chemleft[\subscheme[90]{%
		\chemfig{*6((-[2,0.33,,,draw=none]\scriptstyle\oplus)-=(-)-OH)}
		\arrow{<->}
		\chemfig{*6(=-(-)(-[6,0.33,,,draw=none]\scriptstyle\oplus)-OH)}}\chemright]
	\arrow(@c3--)\chemfig{*6((-[2]R)-=(-)-OH)}
	\arrow(@c4--)\chemfig{*6(=-(-)(-[6]R)-OH)}
\schemestop/

\idx*\setatomsep
\idx*\schemestart\idx*\arrow\idx*\subscheme\idx*\schemestop\idx*\chemname\idx*\definesubmol\idx*\chemleft\idx*\chemright
\idx*{charge!\protect\texttt{\protect\string\protect\oplus}}
\idx*{charge!\protect\texttt{\protect\string\protect\ominus}}
\exemple*{Substitution aromatique éléctrophile}Z\setatomsep{1.5em}%
\definesubmol{+}{-[,-0.4,,,draw=none]\oplus}%
\schemestart
	\arrow{0}[,0]
	\chemleft[\subscheme{\chemfig{*6(=-=-(-[:120]Br)(-[:60]H)-(!+)-)}
		\arrow{<->}
		\chemfig{*6(-(!+)-=-(-[:120]Br)(-[:60]H)-=)}
		\arrow{<->}
		\chemfig{*6(-=-(!+)-(-[:120]Br)(-[:60]H)-=)}}\chemright]
	\arrow(@c2--){<-[*0\chemfig{{-}AlBr_4|^\ominus}][*0\chemfig{Br_2/Al_2Br_3}]}[90,1.5]
	\chemname{\chemfig{*6(-=-=-=-)}}{Benzène 1}
	\arrow(@c4--){->[*0\chemfig{{-}H^\oplus}]}[90,1.5]
	\chemname{\chemfig{*6(-=-=(-Br)-=-)}}{Bromobenzène 2}
	\arrow(@c5.mid east--@c6.mid west)
\schemestop
\chemnameinit{}Z

\idx*\setbondoffset
\idx*\setatomsep
\idx*\lewis
\idx*\arrow\idx*\+\idx*\schemestart\idx*\schemestop\idx*\setcompoundsep
\idx*\chemmove
\idx*{"@}
\exemple*{Mécanismes réactionnels de la chloration}/\scriptsize\setbondoffset{1pt}\setatomsep{2em}\setcompoundsep{4em}
\schemestart
	\chemfig{Cl-[4]@{a0}(=[@{a1}:120]@{a2}O)-[:-120](=[:-60]O)-[4]Cl}\+\chemfig{*6(-=-=(-@{oh1}OH)-=)}\arrow
	\chemfig{*6((-O-[:150](-[@{o0}:150]@{o1}\lewis{6.,O})(-[@{cl0}:60]@{cl1}Cl)-[:240](-[4]Cl)=[6]O)=-=-=-)}
	\arrow\chemfig{*6((-O-[:150](=[2]O)-[:-150](=[6]O)-[:150]Cl)=-=-=-)}\+\chemfig{HCl}
	\arrow(@c1--){0}[-90,0.5]
	\chemfig{*6(-=*6(-O-*6(-@{o2}(=[@{o3}]@{o4}O)-Cl)=)-=-=)}\+\chemfig{*6(-=-=(-@{oh2}OH)-=)}\arrow
	\chemfig{*6(-=*6(-O-(-(-[@{cl2}:60]@{cl3}Cl)(-[@{o5}:-120]@{o6}\lewis{6.,O})-O-[::-40]*6(=-=-=-))=)-=-=)}
	\kern-3em \arrow\chemfig{[:30]*6(=-(-O-[:-60](=O)-[:-120](=[4]O)-[:-60]O-*6(=-=-=-))=-=-)}
	\kern-3em \+\chemfig{HCl}
\schemestop
\chemmove[line width=0.2pt,-stealth,dash pattern = on 2pt off 1pt]{
	\draw[shorten <=2pt](a1)..controls+(200:5mm)and+(200:5mm)..(a2);
	\draw[shorten >=2pt](oh1.west)..controls+(180:15mm)and+(60:5mm)..(a0);
	\draw[shorten <=6pt,shorten >=2pt](o1)..controls+(270:5mm)and+(270:5mm)..(o0);
	\draw[shorten <=2pt](cl0)..controls+(150:5mm)and+(150:5mm)..(cl1.150);
	\draw[shorten <=2pt](o3)..controls +(30:3mm) and +(30:5mm)..(o4.east);
	\draw[shorten >=2pt](oh2.135).. controls +(150:10mm) and +(90:10mm).. (o2);
	\draw[shorten >=2pt,shorten <=5pt]([xshift=-1.5mm]o6.315)..controls +(315:5mm) and +(315:5mm)..(o5);
	\draw[shorten <=2pt](cl2)..controls +(135:5mm) and +(135:5mm)..(cl3.north west);}/

\idx*\chemabove
\idx*\chembelow
\idx*{"@}
\idx*\chemmove
\idx*{charge!\protect\texttt{\protect\string\protect\ominus}}
\exemple*{Cannizzaro}/\schemestart
	\chemfig{[:-30]*6(=-=(-@{atoc}C([6]=[@{db}]@{atoo1}O)-H)-=-)}
	\arrow(start.mid east--.mid west){->[\chemfig{@{atoo2}\chemabove{O}{\scriptstyle\ominus}}H]}
	\chemmove[-stealth,shorten >=2pt,dash pattern=on 1pt off 1pt,thin]{
			\draw[shorten <=8pt](atoo2) ..controls +(up:10mm) and +(up:10mm)..(atoc);
			\draw[shorten <=2pt](db) ..controls +(left:5mm) and +(west:5mm)..(atoo1);}
	\chemfig{[:-30]*6(=-=(-C([6]-[@{sb1}]@{atoo1}\chembelow{O}{\scriptstyle\ominus})([2]-OH)-[@{sb2}]H)-=-)}
	\hspace{1cm}
	\chemfig{[:-30]*6((-@{atoc}C([6]=[@{db}]@{atoo2}O)-[2]H)-=-=-=)}
	\chemmove[-stealth,shorten <=2pt,shorten >=2pt,dash pattern=on 1pt off 1pt,thin]{
			\draw([yshift=-4pt]atoo1.270) ..controls +(0:5mm) and +(right:10mm)..(sb1);
			\draw(sb2) ..controls +(up:10mm) and +(north west:10mm)..(atoc);
			\draw(db) ..controls +(right:5mm) and +(east:5mm)..(atoo2);}
	\arrow(@start.base west--){0}[-75,2]
	{}
	\arrow
	\chemfig{[:-30]*6(=-=(-C([1]-@{atoo2}O-[@{sb}0]@{atoh}H)([6]=O))-=-)}
	\arrow{0}
	\chemfig{[:-30]*6((-C(-[5]H)(-[7]H)-[2]@{atoo1}\chemabove{O}{\scriptstyle\ominus})-=-=-=)}
	\chemmove[-stealth,shorten >=2pt,dash pattern=on 1pt off 1pt,thin]{
			\draw[shorten <=7pt](atoo1.90) ..controls +(+90:8mm) and +(up:10mm)..(atoh);
			\draw[shorten <=2pt](sb) ..controls +(up:5mm) and +(up:5mm)..(atoo2);}
\schemestop/

\begingroup
\catcode`;=12
\idx*\setbondoffset
\idx*\setatomsep
\idx*{"@}
\idx*\chemabove
\idx*\chemmove
\idx*\lewis
\idx*{charge!\protect\texttt{\protect\string\protect\oplus}}
\idx*\schemestart\idx*\arrow\idx*\setcompoundsep\idx*\setarrowoffset\idx*\subscheme\idx*\chemleft\idx*\chemright
\exemple*{Réarrangement de Beckmann}/\setbondoffset{1pt}
\setatomsep{2.5em}
\setcompoundsep{5em}
\setarrowoffset{6pt}
\schemestart
	\chemfig{(-[:-150]R')(-[:-30]R)=[2]N-[:30]OH}
	\arrow{<=>[\chemfig{H^\oplus}]}
	\chemfig{(-[@{a0}:-150]R')(-[:-30]R)=[2]@{a1}N-[@{b0}:30]@{b1}\chemabove{O}{\scriptstyle\oplus}H_2}
	\chemmove[red,-stealth,red,shorten <=2pt]{
		\draw(a0)..controls +(135:2mm) and +(215:4mm).. (a1);
		\draw(b0)..controls +(120:2mm) and +(180:3mm).. ([yshift=7pt]b1.180);}
	\arrow{<=>[\chemfig{{-}H_2O}]}[,1.1]
	\chemleft[\subscheme[90]{%
		\chemfig{R'-\chemabove{N}{\scriptstyle\oplus}~C-R}
		\arrow{<->}[,0.75]
		\chemfig{R'-\lewis{2:,N}=@{a1}\chemabove{C}{\scriptstyle\oplus}-R}}\chemright]
	\arrow{<=>[\chemfig{H_2@{a0}\lewis{0:2:,O}}]}[,1.1]
	\chemmove[red,-stealth,red,shorten <=3pt]{
		\draw(a0)..controls+(90:10mm)and+(45:10mm)..([yshift=6pt]a1.45);}
	\arrow(@c1--){0}[-90,0.333]
	\chemfig{*6(R\rlap{$'$}-N=(-R)-\chemabove{O}{\scriptstyle\oplus} H_2)}
	\arrow{<=>[\chemfig{{-}H^\oplus}]}
	\chemfig{*6(R\rlap{$'$}-N=(-R)-OH)}
	\arrow
	\chemfig{*6(R\rlap{$'$}-\chembelow{N}{H}-(-R)(=[2]O))}
\schemestop/
\endgroup

\idx*\setatomsep
\idx*\setcompoundsep
\idx*\schemestart\idx*\schemestop\idx*\arrow\idx*\+
\exemple*{Schéma réactionnel}/\setatomsep{1.5em}
\setcompoundsep{4em}
\schemestart
	\chemfig{-[::30]=_[::-60](-[:: -60])-[::60]}
	\arrow{->[\chemfig{HCl}]}
	\chemfig{-[::30]-[::-60](-[::120]Cl)(-[::-60])-[::60]}\+\chemfig{-[::30](-[::60]Cl)-[::-60](-[::-60])-[::60]}
	\arrow(@c1--.north west){->[\chemfig{H_2O}]}[-45,1.7]
	\chemfig{-[::30]-[::-60](-[::120]OH)(-[::-60])-[::60]}\+\chemfig{-[::30](-[::60]OH)-[::-60](-[::-60])-[::60]}
\schemestop/

\idx*\tikzset\idx*\schemestart\idx*\arrow\idx*\chemmove\idx*\schemestop
\idx*{charge!\protect\texttt{\protect\string\protect\oplus}}
\exemple*{Estérification de l'acide formique}Z\tikzset{obrace/.style={left delimiter={[},inner sep=3pt},
	cbrace/.style={right delimiter={]},inner sep=3pt},
	braces/.style={left delimiter={[},right delimiter={]},inner sep=3pt}}
\setatomsep{2em}
\schemestart
	\chemfig{H-C(=[:60]O)-[:-60]O-H}
	\arrow(--M1[obrace]){-U>[\scriptsize\chemfig{H_2SO_4^{}}][\scriptsize\chemfig{HSO_4^\ominus}][][.25]}%
		[,1.5,shorten >=6pt]
	\chemfig{H-@{a2}C(-[:60]O-H)(-[:30,.5,,,draw=none]{\scriptstyle\oplus})-[:-60]O-H}
	\arrow(--[cbrace]){<->}
	\chemfig{H-C(=[:60]\chemabove{O}{\scriptstyle\oplus}-H)-[:-60]O-H}
	\arrow(@M1--){<=>[*{0}\scriptsize\chemfig{H-[:120]@{a1}O-[:60]CH_3}][*{0}\tiny addition]}[-90,1.33]
	\chemfig{H-C(-[2]O-[:30]H)(-\chemabove{O}{\scriptstyle\oplus}(-[:60]CH_3)-[:-60]H)-[6]O-[:-30]H}
	\arrow{<=>[\tiny protolysis]}[180]
	\chemfig{H-C(-[2]O-[:30]H)(-O-CH_3)-[@{b1}6]@{a3}\chemabove{O}{\kern-4mm\scriptstyle\oplus}(-[:-150]H)-[:-30]H}
	\arrow(--[obrace]){<=>[*{0}\scriptsize\chemfig{{-}H_2O}][*{0}\tiny elimination]}[-90,,shorten >=6pt]
	\chemfig{H-C(-[:60]O-H)(-[,.5,,,draw=none]{\scriptstyle\oplus})-[:-60]O-CH_3}
	\arrow(--[cbrace]){<->}
	\chemfig{H-C(=[:60]\chemabove{O}{\scriptstyle\oplus}-H)-[:-60]O-CH_3}
	\arrow{-U>[\scriptsize\chemfig{HSO_4^\ominus}][\scriptsize\chemfig{H_2SO_4^{}}][][.25]}[,1.5]
	\chemfig{H-C(=[:60]O)-[:-60]O-CH_3}
	\arrow(@M1--[yshift=-5pt]){0}[180,.5]{\tiny protolysis}
	\chemmove[red,shorten <=3pt,shorten >=1pt]{
		\draw(a1)..controls +(0:1.5cm)and+(0:3cm).. (a2);
		\draw(b1)..controls +(0:5mm)and+(20:5mm)..(a3);}
\schemestop Z

\idx*\schemestart\idx*\subscheme\idx*\arrow\idx*\lewis\idx*\+\idx*\arrow
\idx*\chemname\idx*\vflipnext\idx*\chemmove\idx*\chemabove\idx*\llap
\idx*{charge!\protect\texttt{\protect\string\protect\oplus}}
\idx*{charge!\protect\texttt{\protect\string\protect\ominus}}
\exemple*{Addition électrophile d'halogène sur l'oléfine}/\schemestart
	\subscheme{%
		\chemfig{C(<[:40])(<[:160])=[6]C(<[:-130])<[:-20]}
		\arrow{0}[,0]\+\chemfig{\lewis{246,Br}-\lewis{026,Br}}}
	\arrow(@c1--olefin){<=>[*{0}rapide]}[-90]
	\chemfig{>[:-20]C(<[:40])=[@{db}6]C(<[:-130])<[:-20]}
	\arrow(--bromonium){0}[-90]
	\chemname{\chemfig{C*3((<)(<:[:-155])-\raise1.5pt\llap{$\scriptstyle\oplus$}\lewis{17,Br}-C(<:)(<[:155])-)}}
		{bromonium ion}
	\arrow(--carbeniumA){<<->}[,1.5]
	\chemname{\chemfig{-[:-30]\chemabove{C}{\scriptstyle\oplus}(-[:30])-[6]C(<:[:-150])(<[:-100])-[:-30]
		\lewis{157,Br}}}{Xarbenium ion}
	\arrow(@bromonium--carbeniumB){<<->}[180,1.5]
	\chemname{\chemfig{-[:-30]\chemabove{C}{\scriptstyle\oplus}(-[:30])-[6]C(<[:-150])
		(<:[:-100])-[:-30]\lewis{137,Br}}}{carbenium ion}
	\arrow(@olefin--){0}[,.25]
	\chemfig{@{Br1}\chemabove[3pt]{\lewis{246,Br}}{\scriptstyle\delta\oplus}-[@{b2}]@{Br2}
		\chemabove[3pt]{\lewis{026,Br}}{\scriptstyle\delta\ominus}}
	\arrow(@olefin--[left]){0}[180,0]
	$\pi$ complexe
	\arrow(@carbeniumA--@olefin){<=>[lent, \chemfig{{-}Br^\ominus}]}
	\arrow(@carbeniumB--@olefin){<=>[lent, \chemfig{{-}Br^\ominus}]}
	\chemmove[-stealth,red,shorten <=3pt,shorten >=2pt]{
		\draw(db) .. controls +(20:5mm) and +(135:5mm) .. (Br1);
		\draw(b2) .. controls +(-90:5mm) and +(-120:5mm) .. (Br2);}
\schemestop
\chemnameinit{}/

\idx*\definesubmol
\idx*\setatomsep
\idx*\chemname
\idx*\chemmove
\idx*\schemestart\idx*\arrow\idx*\+\idx*\schemestop
\idx*{charge!\protect\texttt{\protect\string\protect\oplus}}
\exemple*{Sulfonation de la naphtalène}/\definesubmol\cycleoplus{-[,0.25,,,draw=none]\oplus}
\definesubmol{so2oh}{S(=[::90]O)(=[::-90]O)-OH}
\setatomsep{2.5em}
\schemestart[,1.5]
	\chemname{\chemfig{*6(=-*6(-=-=-)=-=-)}}{Naphtalène}\+\chemfig{H_2SO_4}
	\arrow(nph.mid east--.south west){->[80\degres C]}[45]
	\chemname{\chemfig{*6(=-*6(-=-(!\cycleoplus)-(-SO_3H)-)=-=-)}}{Ion 1-arenium}
	\arrow(.mid east--.mid west)
	\chemname{\chemfig{*6(=-*6(-=-=(-!{so2oh})-)=-=-)}}{Acide 1-naphthalenesulfonique}
	\arrow(@nph.mid east--.north west){->[160\degres C]}[-45]
	\chemname{\chemfig{*6(=-*6(-=-(-SO_3H)-(!\cycleoplus)-)=-=-)}}{Ion 2-arenium}\kern-4em
	\arrow(.mid east--.mid west)
	\chemname{\chemfig{*6(=-*6(-=-(-!{so2oh})=-)=-=-)}}{Acide 2-naphthalenesulfonique}
\schemestop
\chemnameinit{}/

\begingroup\catcode`;12
\idx*\chemname
\idx*\color
\idx*\lewis
\idx*{"@}
\idx*\chemmove
\idx*{charge!\protect\texttt{\protect\string\protect\delta}}
\exemple*{Schéma explicatif}/\parbox{0.8\linewidth}{%
	\hspace{10em}
	\tikz[remember picture]\node(n0){\chemname{}{Attaques\\nucléophiles}};\par
	\vspace{2ex}\hspace{15em}
	\chemfig{R^2-(-[:-60]@{m3}H)-[:60]@{m0}(-[:120]R^1)(-[1,0.25,,,draw=none]\scriptstyle\color{red}\delta+)
		=[@{m1}]@{m2}\lewis{1:7:,O}-[1,0.5,,,draw=none]\scriptstyle\color{red}\delta{-}}
	\hspace{5em}
	\chemname[-15ex]{}{\tikz[remember picture]\node(n1){};Réactions d'addition}\kern1em
	\chemname{}{\tikz[remember picture]\node(n2){};Propriétés basiques}\par
	\vspace{6ex}\hspace{8em}
	\chemname{}{Propriétés acides des atomes\tikz[remember picture]\node(n3){};
		\\d'hydrogène en position $\alpha$}
	\chemmove[-stealth,line width=0.8pt,green!60!black!70]{
		\draw[shorten >=2pt](n0)..controls+(270:4em)and+(180:2em)..(m0);
		\draw[shorten >=8pt](n1)..controls+(180:2em)and+(60:2em)..(m1);
		\draw[shorten >=5pt](n2)..controls+(180:2em)and+(270:2em)..([xshift=3pt]m2.315);
		\draw[shorten >=2pt](n3)..controls+(0:2em)and+(270:2em)..(m3);
	}%
}
\chemnameinit{}/
\endgroup

\idx*\setatomsep
\idx*\printatom
\idx*\setbondoffset
\idx*\definesubmol
\idx*\redefinesubmol
\exemple*{Cristallographie}/\newcommand\disk{\tikz\draw[fill=black,overlay](0,0)circle(2pt);}
\setatomsep{20pt}
\renewcommand\printatom[1]{#1}
\setbondoffset{2pt}
\definesubmol{hat}{-[:40,1.5]\disk-[::-30,2]\disk-[::-30,2]\disk-[::-120,2]\disk-[::-30,2]\disk}
\definesubmol{motif}{-[:40,1.5]\disk(-[2,3])-[::-30,2]\disk
(-[2,3])-[::-30,2]\disk(-[2,3])-[::-120,2]\disk(-[2,3])-[::-30,2]\disk}
\chemfig{\disk?[a](-[2,3]\disk?[b](-[2,3]\disk?[c]!{hat}?[c])!{motif}?[b](-[2,3]))!{motif}?[a](-[2,3])}
\qquad
\redefinesubmol{motif}{\disk(-[2,3])(-[:42,3.6,,,draw=none]\disk)-[:30,2.6]\disk
(-[2,3])-[0,3]\disk(-[2,3])-[:-150,2.6]\disk(-[4,3])-[2,3]-[4,3]}
\redefinesubmol{hat}{\disk-[:30,2.6]\disk-[0,3]\disk-[:-150,2.6]\disk-[4,3]}
\chemfig{!{motif}!{motif}!{hat}}
\qquad
\redefinesubmol{motif}{(-[2,3])(-[:25,2.75,,,white]-[2,1.5,,,white]\disk)-[:50,3]\disk
(-[2,3])-[::-50,3]\disk(-[2,3])-[::-130,3]\disk-[2,3]-[4,3]\disk}
\redefinesubmol{hat}{-[:50,3]\disk-[::-50,3]\disk-[::-130,3]\disk}
\chemfig{-[4,3]\disk!{motif}(-[:25,2.75,,,draw=none]\disk?[uat]?[dat](-[::0,2.75]?[uat1]?[dat1]
-[::-90,1.3]\disk?[uat2]?[dat2])-[::-90,1.3]-[:25,2.75])!{hat}?[uat3]?[dat3]-[:50,1.5]
(-[6,1.5,,,draw=none]\disk?[dat,,,blue]?[dat1,,,blue]?[dat2,,,blue]?[dat3,,,blue])
-[2,1.5,,,draw=none]\disk?[uat,,,red]?[uat1,,,red]?[uat2,,,red]?[uat3,,,red]}/

\exemple*{Taxotère}/\chemfig{-[::-30](-[5])(-[7])-[::+60]-[::-60]O-[::+60](=[::-45]O)-[::+90]HN>:[::-60](-[::+60]**6(------))
-[::-30](<:[2]OH)-[::-60](=[6]O)-[::+60]O>:[::-60]*7(---?(<[::-120]OH)-(<|[1]CH_3)(<:[::-90]CH_3)
-(-[1](<[::+80]HO)-[0](=[::+60]O)-[7](<|[::+130]CH_3)(-[::+75](<|[2]OH)-[::-60]-[::-60](<[::+30]O-[::-90])
-[::-60](<[::+90])(<:[::+30]O-[7](-[6]CH_3)=[0]O)-[::-60])-[6]-[5,1.3]?(<:[7]O-[5](=[::-60]O)
-[6]**6(------)))=(-[2]CH_3)-)}/

\idx*{(\kern1cm)|see{ramification}}
\idx*{?@\protect\texttt{?}|see{liaison/atomes éloignés}}
\idx*{distance interatome|see{liaison/longueur}}
\idx*{*|see{cycle}}
\idx*{**|see{cycle/cercle intérieur}}
\idx*{\protect\symbol{'0174}@\protect\texttt{\protect\symbol{'0174}}|see{découpage en atomes}}
\idx*{>, <, >\protect\symbol{'0174}, <\protect\symbol{'0174}, >:, <:@\protect\texttt>, \protect\texttt<, \protect\texttt{>\protect\symbol{'0174}}, \protect\texttt{<\protect\symbol{'0174}}, >\protect\string:, <\protect\string:|see{Cram (représentation)}}
\idx*{-, =, \protect\string\protect~@\protect\texttt-, \protect\texttt=, \protect\texttt{\protect\string~}|see{liaison/types}}
\idx*{=\protect\string_, =\protect\string^@\protect\texttt{=\protect\string_}, \protect\texttt{=\protect\string^}|see{liaison/déportées}}
\idx*{"!|see{sauvegarde d'une molécule}}
\newpage
\phantomsection
\addcontentsline{toc}{part}{Index}
\printindex
\end{document}